<!DOCTYPE html>
<html lang="en" data-theme="liquid-glass">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Prenxy PDF+ | Document Manager & Viewer</title>
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a2e;
      --bg-card: #16162a;
      --bg-hover: #1e1e3a;
      --bg-glass: rgba(22, 22, 42, 0.85);
      --text-primary: #e8e8f0;
      --text-secondary: #9898b0;
      --text-muted: #5a5a78;
      --accent-primary: #7c3aed;
      --accent-secondary: #a855f7;
      --accent-glow: rgba(124, 58, 237, 0.4);
      --accent-gradient: linear-gradient(135deg, #7c3aed, #a855f7, #c084fc);
      --accent-gradient-2: linear-gradient(135deg, #06b6d4, #3b82f6, #7c3aed);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --border: rgba(124, 58, 237, 0.15);
      --border-hover: rgba(124, 58, 237, 0.35);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-md: 0 8px 32px rgba(0,0,0,0.4);
      --shadow-lg: 0 16px 48px rgba(0,0,0,0.5);
      --shadow-glow: 0 0 30px rgba(124, 58, 237, 0.2);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="light"] {
      --bg-primary: #f5f3ff;
      --bg-secondary: #ede9fe;
      --bg-tertiary: #ddd6fe;
      --bg-card: #ffffff;
      --bg-hover: #f0ecff;
      --bg-glass: rgba(255, 255, 255, 0.9);
      --text-primary: #1e1b4b;
      --text-secondary: #4c4670;
      --text-muted: #8b85a8;
      --border: rgba(124, 58, 237, 0.12);
      --border-hover: rgba(124, 58, 237, 0.3);
      --shadow-sm: 0 2px 8px rgba(124, 58, 237, 0.08);
      --shadow-md: 0 8px 32px rgba(124, 58, 237, 0.1);
      --shadow-lg: 0 16px 48px rgba(124, 58, 237, 0.12);
      --shadow-glow: 0 0 30px rgba(124, 58, 237, 0.1);
    }

    /* ===== ASTEROID THEME ===== */
    [data-theme="asteroid"] {
      --bg-primary: #030014;
      --bg-secondary: #0a0825;
      --bg-tertiary: #130f33;
      --bg-card: #0c0928;
      --bg-hover: #1a1444;
      --bg-glass: rgba(10, 8, 37, 0.9);
      --text-primary: #e0dff8;
      --text-secondary: #9b97c9;
      --text-muted: #585680;
      --accent-primary: #ff6b35;
      --accent-secondary: #ff9f1c;
      --accent-glow: rgba(255, 107, 53, 0.35);
      --accent-gradient: linear-gradient(135deg, #ff6b35, #ff9f1c, #ffd166);
      --accent-gradient-2: linear-gradient(135deg, #7b2ff7, #ff6b35, #ff9f1c);
      --border: rgba(255, 107, 53, 0.12);
      --border-hover: rgba(255, 107, 53, 0.3);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.6);
      --shadow-glow: 0 0 40px rgba(255, 107, 53, 0.15);
    }

    /* ===== TECHI THEME ===== */
    [data-theme="techi"] {
      --bg-primary: #001a1a;
      --bg-secondary: #002626;
      --bg-tertiary: #003333;
      --bg-card: #002020;
      --bg-hover: #003d3d;
      --bg-glass: rgba(0, 38, 38, 0.92);
      --text-primary: #00ffcc;
      --text-secondary: #00cc99;
      --text-muted: #338877;
      --accent-primary: #00ffd5;
      --accent-secondary: #00e5bf;
      --accent-glow: rgba(0, 255, 213, 0.25);
      --accent-gradient: linear-gradient(135deg, #00ffd5, #00e5bf, #00ccaa);
      --accent-gradient-2: linear-gradient(135deg, #00bfff, #00ffd5, #7cff6b);
      --border: rgba(0, 255, 213, 0.12);
      --border-hover: rgba(0, 255, 213, 0.3);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.6);
      --shadow-glow: 0 0 30px rgba(0, 255, 213, 0.12);
    }

    /* ===== VS CODE DARK THEME ===== */
    [data-theme="vscode-dark"] {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --bg-card: #2d2d30;
      --bg-hover: #37373d;
      --bg-glass: rgba(37, 37, 38, 0.95);
      --text-primary: #d4d4d4;
      --text-secondary: #9cdcfe;
      --text-muted: #6a9955;
      --accent-primary: #569cd6;
      --accent-secondary: #4fc1ff;
      --accent-glow: rgba(86, 156, 214, 0.25);
      --accent-gradient: linear-gradient(135deg, #569cd6, #4fc1ff, #9cdcfe);
      --accent-gradient-2: linear-gradient(135deg, #c586c0, #569cd6, #4ec9b0);
      --border: rgba(86, 156, 214, 0.15);
      --border-hover: rgba(86, 156, 214, 0.35);
      --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.35);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
      --shadow-glow: 0 0 20px rgba(86, 156, 214, 0.08);
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
    }

    /* ===== VS CODE LIGHT THEME ===== */
    [data-theme="vscode-light"] {
      --bg-primary: #f3f3f3;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e8e8e8;
      --bg-card: #ffffff;
      --bg-hover: #e8e8ec;
      --bg-glass: rgba(255, 255, 255, 0.96);
      --text-primary: #1e1e1e;
      --text-secondary: #0451a5;
      --text-muted: #008000;
      --accent-primary: #0066b8;
      --accent-secondary: #005fb8;
      --accent-glow: rgba(0, 102, 184, 0.15);
      --accent-gradient: linear-gradient(135deg, #0066b8, #005fb8, #0078d4);
      --accent-gradient-2: linear-gradient(135deg, #af00db, #0066b8, #267f99);
      --border: rgba(0, 102, 184, 0.12);
      --border-hover: rgba(0, 102, 184, 0.3);
      --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --shadow-glow: none;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
    }

    /* ===== GOOGLE THEME ===== */
    [data-theme="google"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e8eaed;
      --bg-card: #ffffff;
      --bg-hover: #f1f3f4;
      --bg-glass: rgba(255, 255, 255, 0.95);
      --text-primary: #202124;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --accent-primary: #1a73e8;
      --accent-secondary: #4285f4;
      --accent-glow: rgba(26, 115, 232, 0.15);
      --accent-gradient: linear-gradient(135deg, #4285f4, #34a853, #fbbc04, #ea4335);
      --accent-gradient-2: linear-gradient(135deg, #4285f4, #1a73e8);
      --success: #34a853;
      --warning: #fbbc04;
      --danger: #ea4335;
      --info: #4285f4;
      --border: rgba(0, 0, 0, 0.08);
      --border-hover: rgba(26, 115, 232, 0.3);
      --shadow-sm: 0 1px 2px rgba(60, 64, 67, 0.1);
      --shadow-md: 0 2px 6px rgba(60, 64, 67, 0.15), 0 1px 3px rgba(60, 64, 67, 0.1);
      --shadow-lg: 0 4px 12px rgba(60, 64, 67, 0.15), 0 2px 6px rgba(60, 64, 67, 0.1);
      --shadow-glow: none;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 28px;
    }

    /* ===== GOOGLE THEME â€” Full Material Design 3 Redesign ===== */
    /* Inspired by Google Photos (photos.google.com) â€” Material You, Product Sans, GM3 tokens */

    @keyframes googleRipple {
      0% { transform: scale(0); opacity: 0.4; }
      100% { transform: scale(4); opacity: 0; }
    }
    @keyframes googleFadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes googleShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    [data-theme="google"] body {
      font-family: 'Google Sans', 'Product Sans', 'Segoe UI', Roboto, sans-serif;
      background: #F0F4F9;
    }

    [data-theme="google"] .main::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 320px;
      background: linear-gradient(180deg, #E8EEFF 0%, #F0F4F9 100%);
      z-index: -1;
      pointer-events: none;
    }

    /* Header â€” Google Photos style top bar */
    [data-theme="google"] .header {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px) saturate(1.4);
      -webkit-backdrop-filter: blur(20px) saturate(1.4);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 3px rgba(60,64,67,0.08);
    }

    [data-theme="google"] .logo-icon {
      background: linear-gradient(135deg, #4285f4, #34a853);
      border-radius: 12px;
    }
    [data-theme="google"] .logo-icon::after {
      content: 'ðŸ“·';
      font-size: 16px;
    }
    [data-theme="google"] .logo-text span {
      color: #202124;
      font-weight: 400;
      font-family: 'Product Sans', 'Google Sans', sans-serif;
      letter-spacing: -0.5px;
    }
    [data-theme="google"] .logo-version {
      background: #E8F0FE;
      color: #1a73e8;
      font-weight: 500;
      border-radius: 100px;
      border: none;
    }

    /* Search â€” Google Photos rounded pill */
    [data-theme="google"] .search-box input {
      background: #EDF2FC;
      border: none;
      border-radius: 100px;
      color: #202124;
      font-family: 'Google Sans', 'Segoe UI', sans-serif;
      padding: 10px 20px 10px 44px;
      font-size: 14px;
      transition: background 0.3s, box-shadow 0.3s;
    }
    [data-theme="google"] .search-box input::placeholder { color: #5f6368; }
    [data-theme="google"] .search-box input:focus {
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(60,64,67,0.2), 0 4px 8px rgba(60,64,67,0.1);
      outline: none;
    }
    [data-theme="google"] .search-box .search-shortcut {
      background: rgba(26,115,232,0.08);
      color: #1a73e8;
      border: 1px solid rgba(26,115,232,0.15);
      border-radius: 6px;
      font-weight: 500;
    }

    /* Buttons â€” Material Design 3 */
    [data-theme="google"] .btn {
      border-radius: 100px;
      font-family: 'Google Sans', sans-serif;
      font-weight: 500;
      letter-spacing: 0.01em;
      border: none;
      background: transparent;
      color: #444746;
      transition: background 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }
    [data-theme="google"] .btn:hover {
      background: rgba(68,71,70,0.08);
    }
    [data-theme="google"] .btn:active {
      background: rgba(68,71,70,0.12);
    }
    [data-theme="google"] .btn-icon {
      border-radius: 100px;
      width: 40px;
      height: 40px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    [data-theme="google"] .btn-primary {
      background: #0b57d0;
      color: #ffffff;
      border-radius: 100px;
      padding: 10px 24px;
      font-weight: 500;
      box-shadow: none;
      border: none;
    }
    [data-theme="google"] .btn-primary::before { display: none; }
    [data-theme="google"] .btn-primary:hover {
      background: #0842a0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.15);
      transform: none;
    }
    [data-theme="google"] .btn-primary:active {
      background: #06317a;
      transform: none;
    }

    /* Toolbar */
    [data-theme="google"] .toolbar {
      background: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
    }
    [data-theme="google"] .sort-select {
      background: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      color: #3c4043;
      font-family: 'Google Sans', sans-serif;
    }
    [data-theme="google"] .view-toggle {
      background: rgba(0,0,0,0.04);
      border-radius: 100px;
      border: none;
    }
    [data-theme="google"] .view-toggle button.active {
      background: #ffffff;
      color: #0b57d0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      border-radius: 100px;
    }

    /* Stats bar */
    [data-theme="google"] .stats-bar {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    [data-theme="google"] .stat-item {
      background: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 12px;
      color: #3c4043;
      box-shadow: none;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    [data-theme="google"] .stat-item:hover {
      box-shadow: 0 1px 3px rgba(60,64,67,0.15);
      border-color: #0b57d0;
    }
    [data-theme="google"] .stat-item i {
      color: #1a73e8;
    }

    /* File cards â€” Google Photos media card style */
    [data-theme="google"] .file-card {
      background: #ffffff;
      border: none;
      border-radius: 12px;
      box-shadow: none;
      overflow: hidden;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    [data-theme="google"] .file-card:hover {
      box-shadow: 0 1px 3px rgba(60,64,67,0.15), 0 4px 8px rgba(60,64,67,0.1);
      transform: none;
    }
    [data-theme="google"] .file-card-preview {
      background: #F0F4F9;
      border-bottom: 1px solid #e8eaed;
      border-radius: 0;
    }
    [data-theme="google"] .file-card-preview::after { display: none; }
    [data-theme="google"] .file-card-body {
      padding: 12px 16px;
    }
    [data-theme="google"] .file-card-name {
      font-weight: 500;
      color: #202124;
      font-family: 'Google Sans', sans-serif;
    }
    [data-theme="google"] .file-card-type {
      color: #5f6368;
    }
    [data-theme="google"] .file-card-actions .btn-icon {
      background: transparent;
      border-radius: 100px;
      color: #5f6368;
      border: none;
    }
    [data-theme="google"] .file-card-actions .btn-icon:hover {
      background: rgba(60,64,67,0.08);
      color: #202124;
    }
    [data-theme="google"] .file-card-checkbox {
      border-color: #dadce0;
      background: transparent;
      border-radius: 100px;
    }
    [data-theme="google"] .file-card.selected .file-card-checkbox {
      background: #0b57d0;
      border-color: #0b57d0;
    }
    [data-theme="google"] .file-card.selected {
      outline: 2px solid #0b57d0;
      outline-offset: -2px;
    }

    /* List items */
    [data-theme="google"] .file-list-item {
      border-radius: 12px;
      border: none;
    }
    [data-theme="google"] .file-list-item:hover {
      background: rgba(60,64,67,0.04);
    }
    [data-theme="google"] .file-list-item .file-icon-mini {
      background: #E8F0FE;
      color: #1a73e8;
      border-radius: 12px;
    }

    /* Category headers */
    [data-theme="google"] .category-header {
      border: none;
      background: transparent;
    }
    [data-theme="google"] .category-header h2 {
      color: #202124;
      font-family: 'Google Sans', sans-serif;
      font-weight: 400;
    }

    /* PDF Viewer overrides */
    [data-theme="google"] .viewer-overlay {
      background: rgba(32,33,36,0.92);
      backdrop-filter: blur(20px);
    }
    [data-theme="google"] .viewer-header {
      background: rgba(32,33,36,0.95);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    [data-theme="google"] .viewer-title {
      font-family: 'Google Sans', sans-serif;
      font-weight: 400;
    }
    [data-theme="google"] .viewer-controls .btn {
      border-radius: 100px;
    }
    [data-theme="google"] .viewer-page-nav {
      background: rgba(255,255,255,0.06);
      border-radius: 100px;
    }
    [data-theme="google"] .viewer-page-nav input {
      background: transparent;
      color: #e3e3e3;
      font-family: 'Google Sans', sans-serif;
    }
    [data-theme="google"] .viewer-canvas-container {
      background: #202124;
    }
    [data-theme="google"] .pdf-page-wrapper canvas {
      border-radius: 0;
    }
    [data-theme="google"] .pdf-page-label {
      font-family: 'Google Sans', sans-serif;
    }

    /* Image viewer */
    [data-theme="google"] .image-viewer-overlay {
      background: rgba(32,33,36,0.95);
      backdrop-filter: blur(20px);
    }

    /* DOCX viewer */
    [data-theme="google"] .docx-viewer-overlay {
      background: rgba(32,33,36,0.9);
      backdrop-filter: blur(20px);
    }

    /* Theme picker */
    [data-theme="google"] .theme-picker-panel {
      background: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 28px;
      box-shadow: 0 4px 12px rgba(60,64,67,0.15);
    }
    [data-theme="google"] .theme-picker-header h3 {
      color: #202124;
      font-family: 'Google Sans', sans-serif;
      font-weight: 400;
    }
    [data-theme="google"] .theme-card {
      background: #f8f9fa;
      border: 1px solid #dadce0;
      border-radius: 16px;
    }
    [data-theme="google"] .theme-card:hover {
      box-shadow: 0 1px 3px rgba(60,64,67,0.15);
      border-color: #1a73e8;
    }
    [data-theme="google"] .theme-card.active {
      border-color: #0b57d0;
      box-shadow: 0 0 0 2px #0b57d0;
    }
    [data-theme="google"] .theme-card-preview {
      border-radius: 12px 12px 0 0;
    }
    [data-theme="google"] .theme-card-info .theme-name {
      color: #202124;
      font-family: 'Google Sans', sans-serif;
    }

    /* Command palette */
    [data-theme="google"] .command-palette {
      background: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 24px;
      box-shadow: 0 8px 24px rgba(60,64,67,0.2);
    }
    [data-theme="google"] .command-palette input {
      background: transparent;
      color: #202124;
      font-family: 'Google Sans', sans-serif;
      border: none;
    }
    [data-theme="google"] .command-item:hover,
    [data-theme="google"] .command-item.active {
      background: #E8F0FE;
      color: #0b57d0;
    }

    /* Upload modal */
    [data-theme="google"] .upload-modal {
      background: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 28px;
      box-shadow: 0 8px 32px rgba(60,64,67,0.2);
    }
    [data-theme="google"] .upload-modal h2 {
      color: #202124;
      font-family: 'Google Sans', sans-serif;
    }
    [data-theme="google"] .upload-drop-zone {
      border: 2px dashed #dadce0;
      border-radius: 16px;
      background: #f8f9fa;
    }
    [data-theme="google"] .upload-drop-zone:hover,
    [data-theme="google"] .upload-drop-zone.drag-over {
      border-color: #1a73e8;
      background: #E8F0FE;
    }

    /* Toast */
    [data-theme="google"] .toast {
      background: #323232;
      color: #ffffff;
      border-radius: 8px;
      border: none;
      font-family: 'Google Sans', sans-serif;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }

    /* Scrollbar â€” minimal Material style */
    [data-theme="google"] ::-webkit-scrollbar { width: 8px; height: 8px; }
    [data-theme="google"] ::-webkit-scrollbar-track { background: transparent; }
    [data-theme="google"] ::-webkit-scrollbar-thumb {
      background: rgba(60,64,67,0.2);
      border-radius: 100px;
    }
    [data-theme="google"] ::-webkit-scrollbar-thumb:hover {
      background: rgba(60,64,67,0.4);
    }

    /* Reading progress */
    [data-theme="google"] .reading-progress .reading-progress-fill {
      background: linear-gradient(90deg, #4285f4, #34a853, #fbbc04, #ea4335);
    }

    /* Context menu */
    [data-theme="google"] .context-menu {
      background: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(60,64,67,0.15), 0 8px 24px rgba(60,64,67,0.1);
    }
    [data-theme="google"] .context-menu-item:hover {
      background: #E8F0FE;
      color: #0b57d0;
    }

    /* Selection bar */
    [data-theme="google"] .selection-bar {
      background: #0b57d0;
      border-radius: 100px;
      border: none;
      box-shadow: 0 3px 5px rgba(11,87,208,0.25);
    }

    /* Sidebar */
    [data-theme="google"] .viewer-sidebar {
      background: rgba(32,33,36,0.95);
      border-right: 1px solid rgba(255,255,255,0.06);
    }
    [data-theme="google"] .viewer-sidebar .thumb-item.active {
      background: rgba(138,180,248,0.12);
      border-left-color: #8ab4f8;
    }

    /* ===== LIQUID GLASS THEME â€” Premium Frosted Water Glass UI ===== */

    @keyframes glassShimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes glassFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-6px); }
    }
    @keyframes glassPulseGlow {
      0%, 100% { box-shadow: 0 0 24px rgba(56,189,248,0.2), inset 0 0 16px rgba(56,189,248,0.06); }
      50% { box-shadow: 0 0 48px rgba(56,189,248,0.35), inset 0 0 24px rgba(56,189,248,0.12); }
    }
    @keyframes glassBadgeShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    @keyframes glassReveal {
      from { opacity: 0; transform: translateY(16px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes waterRipple {
      0% { transform: scale(0.8); opacity: 0.6; }
      50% { transform: scale(1.05); opacity: 0.3; }
      100% { transform: scale(0.8); opacity: 0.6; }
    }
    @keyframes liquidRefract {
      0%, 100% { border-color: rgba(255,255,255,0.45); }
      50% { border-color: rgba(56,189,248,0.3); }
    }
    @keyframes dropletFall {
      0% { transform: translateY(-8px) scale(0.9); opacity: 0; }
      30% { opacity: 1; }
      100% { transform: translateY(4px) scale(1); opacity: 0; }
    }

    [data-theme="liquid-glass"] {
      /* === Liquid Glass Palette â€” Aqua/Frost tones with high contrast === */
      --bg-primary: #e8f1ff;
      --bg-secondary: #dde8f9;
      --bg-tertiary: #cfdcf2;
      --bg-card: rgba(255, 255, 255, 0.65);
      --bg-hover: rgba(255, 255, 255, 0.8);
      --bg-glass: rgba(255, 255, 255, 0.2);
      --text-primary: #0c1929;
      --text-secondary: #1e3a5f;
      --text-muted: #5b7a9d;
      --accent-primary: #0284c7;
      --accent-secondary: #38bdf8;
      --accent-glow: rgba(56, 189, 248, 0.35);
      --accent-gradient: linear-gradient(135deg, #0284c7, #38bdf8, #7dd3fc);
      --accent-gradient-2: linear-gradient(90deg, #38bdf8, #a5f3fc, #0ea5e9);
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #6366f1;
      --border: rgba(56, 189, 248, 0.2);
      --border-hover: rgba(2, 132, 199, 0.4);
      --shadow-sm: 0 2px 8px rgba(0,60,120,0.07);
      --shadow-md: 0 8px 32px rgba(0,60,120,0.1);
      --shadow-lg: 0 20px 60px rgba(0,60,120,0.14);
      --shadow-glow: 0 0 60px rgba(56,189,248,0.15);
      --radius-sm: 16px;
      --radius-md: 24px;
      --radius-lg: 32px;
      --radius-xl: 48px;
      --transition: all 0.45s cubic-bezier(.25,1,.5,1);

      /* Glass-specific tokens */
      --glass-water: #0ea5e9;
      --glass-sky: #38bdf8;
      --glass-cyan: #22d3ee;
      --glass-frost: #bae6fd;
      --glass-deep: #0369a1;
      --glass-indigo: #6366f1;
      --glass-indigo-light: #a5b4fc;
      --glass-indigo-50: #eef2ff;
      --glass-indigo-100: #e0e7ff;
      --glass-indigo-200: #c7d2fe;
      --glass-indigo-800: #1e3a8a;
      --glass-indigo-900: #1e293b;
      --glass-surface: #e8f1ff;
      --glass-surface-secondary: #f0f7ff;
      --glass-panel-bg: rgba(255, 255, 255, 0.35);
      --glass-panel-border: rgba(255, 255, 255, 0.55);
      --glass-panel-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 4px 16px rgba(0,60,120,0.08);
    }

    /* ===== LIQUID GLASS: Body & Global ===== */
    [data-theme="liquid-glass"] body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #dbeafe 0%, #e0f2fe 30%, #f0f9ff 70%, #e8f1ff 100%);
      background-attachment: fixed;
      color: #0c1929;
    }

    /* ===== LIQUID GLASS: Water caustic overlay ===== */
    [data-theme="liquid-glass"] .main::before {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.025;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(ellipse 600px 300px at 20% 30%, rgba(56,189,248,0.4), transparent),
        radial-gradient(ellipse 500px 400px at 80% 60%, rgba(34,211,238,0.3), transparent),
        radial-gradient(ellipse 400px 200px at 50% 80%, rgba(14,165,233,0.3), transparent);
      filter: blur(60px);
    }

    /* ===== LIQUID GLASS: Header â€” Frosted glass navbar ===== */
    [data-theme="liquid-glass"] .header {
      background: rgba(255, 255, 255, 0.45) !important;
      backdrop-filter: blur(80px) saturate(200%) brightness(1.05) !important;
      -webkit-backdrop-filter: blur(80px) saturate(200%) brightness(1.05) !important;
      border-bottom: 1px solid rgba(255,255,255,0.6) !important;
      box-shadow: 0 1px 0 rgba(56,189,248,0.08), 0 8px 32px rgba(0,60,120,0.06) !important;
      border-radius: 0 0 28px 28px;
      margin: 0;
      padding: 0 20px !important;
      height: 60px !important;
    }

    /* ===== LIQUID GLASS: Logo ===== */
    [data-theme="liquid-glass"] .logo-icon {
      background: rgba(255, 255, 255, 0.5) !important;
      backdrop-filter: blur(20px) saturate(1.4);
      border: 1.5px solid rgba(255,255,255,0.65);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 4px 16px rgba(0,60,120,0.08);
      color: var(--glass-water) !important;
      border-radius: 14px !important;
      animation: liquidRefract 4s ease-in-out infinite;
    }
    [data-theme="liquid-glass"] .logo-icon::after {
      background: none !important;
    }
    [data-theme="liquid-glass"] .logo-text span {
      background: linear-gradient(135deg, #0c1929 0%, #0369a1 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      font-weight: 700 !important;
    }
    [data-theme="liquid-glass"] .logo-version {
      background: rgba(56,189,248,0.12) !important;
      color: var(--glass-deep) !important;
      border: 1px solid rgba(56,189,248,0.25);
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 9px !important;
      padding: 3px 10px !important;
    }

    /* ===== LIQUID GLASS: Search Box â€” Frosted pill ===== */
    [data-theme="liquid-glass"] .search-box input {
      border-radius: 9999px !important;
      background: rgba(255,255,255,0.55) !important;
      border: 1.5px solid rgba(56,189,248,0.2) !important;
      backdrop-filter: blur(24px);
      box-shadow: inset 0 2px 4px rgba(0,60,120,0.04), 0 0 40px rgba(56,189,248,0.05);
      height: 42px !important;
      font-size: 14px;
      padding-left: 42px !important;
      color: #0c1929 !important;
      transition: all 0.3s cubic-bezier(.25,1,.5,1);
    }
    [data-theme="liquid-glass"] .search-box input::placeholder {
      color: #5b7a9d !important;
    }
    [data-theme="liquid-glass"] .search-box input:focus {
      border-color: var(--glass-water) !important;
      box-shadow: 0 0 0 3px rgba(56,189,248,0.15), 0 0 40px rgba(56,189,248,0.1) !important;
      background: rgba(255,255,255,0.75) !important;
    }
    [data-theme="liquid-glass"] .search-box .search-shortcut {
      background: rgba(56,189,248,0.1) !important;
      border: 1px solid rgba(56,189,248,0.2) !important;
      border-radius: 9999px !important;
      color: var(--glass-deep) !important;
      font-weight: 600;
      padding: 2px 10px !important;
    }

    /* ===== LIQUID GLASS: Buttons â€” Water-glass capsules ===== */
    [data-theme="liquid-glass"] .btn {
      border-radius: 9999px !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      background: rgba(255,255,255,0.55) !important;
      backdrop-filter: blur(16px);
      font-weight: 600;
      color: #0c1929 !important;
      padding: 8px 18px !important;
      transition: all 0.4s cubic-bezier(.25,1,.5,1) !important;
      position: relative;
      overflow: hidden;
      text-shadow: 0 0.5px 0 rgba(255,255,255,0.5);
    }
    [data-theme="liquid-glass"] .btn:hover {
      background: rgba(255,255,255,0.8) !important;
      border-color: rgba(56,189,248,0.35) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 20px rgba(0,60,120,0.08), inset 0 1px 0 rgba(255,255,255,0.6) !important;
    }
    [data-theme="liquid-glass"] .btn-icon {
      border-radius: 14px !important;
      padding: 0 !important;
    }

    /* Glass primary button â€” Deep water gradient */
    [data-theme="liquid-glass"] .btn-primary {
      background: linear-gradient(135deg, #0369a1, #0284c7, #0ea5e9) !important;
      color: white !important;
      border: none !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 0 4px 16px rgba(2,132,199,0.25) !important;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }
    [data-theme="liquid-glass"] .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.5s;
      background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 40%, #7dd3fc 75%, #bae6fd 100%);
      border-radius: 9999px;
    }
    [data-theme="liquid-glass"] .btn-primary:hover::before {
      opacity: 1;
    }
    [data-theme="liquid-glass"] .btn-primary:hover {
      transform: translateY(-2px) scale(1.02) !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.4), 0 8px 30px rgba(2,132,199,0.3) !important;
    }
    [data-theme="liquid-glass"] .btn-primary:active {
      transform: scale(0.95) !important;
    }

    /* ===== LIQUID GLASS: Toolbar â€” Frosted strip ===== */
    [data-theme="liquid-glass"] .toolbar {
      background: rgba(255,255,255,0.35) !important;
      backdrop-filter: blur(40px) saturate(1.5) !important;
      border-bottom: 1px solid rgba(255,255,255,0.4) !important;
      border-radius: 0;
    }
    [data-theme="liquid-glass"] .sort-select {
      border-radius: 9999px !important;
      background-color: rgba(255,255,255,0.5) !important;
      border: 1.5px solid rgba(56,189,248,0.15) !important;
      font-weight: 600;
      color: #0c1929 !important;
    }
    [data-theme="liquid-glass"] .view-toggle {
      border-radius: 14px !important;
      background: rgba(255,255,255,0.45) !important;
      border: 1.5px solid rgba(56,189,248,0.12) !important;
      overflow: hidden;
    }
    [data-theme="liquid-glass"] .view-toggle button.active {
      background: rgba(56,189,248,0.15) !important;
      color: var(--glass-deep) !important;
      box-shadow: inset 0 0 12px rgba(56,189,248,0.15);
      font-weight: 700;
    }

    /* ===== LIQUID GLASS: Stats Bar â€” Glass pill badges ===== */
    [data-theme="liquid-glass"] .stats-bar {
      background: rgba(255,255,255,0.3) !important;
      border-bottom: 1px solid rgba(255,255,255,0.35) !important;
      backdrop-filter: blur(24px);
      gap: 16px !important;
      padding: 10px 24px !important;
    }
    [data-theme="liquid-glass"] .stat-item {
      background: rgba(255,255,255,0.55);
      padding: 6px 16px;
      border-radius: 9999px;
      border: 1.5px solid rgba(56,189,248,0.15);
      font-weight: 600;
      font-size: 12px;
      color: #1e3a5f;
      backdrop-filter: blur(12px);
      transition: all 0.3s cubic-bezier(.25,1,.5,1);
    }
    [data-theme="liquid-glass"] .stat-item:hover {
      border-color: rgba(56,189,248,0.35);
      box-shadow: inset 0 0 12px rgba(56,189,248,0.08), 0 4px 16px rgba(0,60,120,0.06);
      transform: translateY(-1px);
      background: rgba(255,255,255,0.7);
    }
    [data-theme="liquid-glass"] .stat-item i {
      color: var(--glass-water) !important;
    }

    /* ===== LIQUID GLASS: File Cards â€” Frosted panels with refraction border ===== */
    [data-theme="liquid-glass"] .file-card {
      background: rgba(255,255,255,0.5) !important;
      border: 1.5px solid rgba(255,255,255,0.6) !important;
      border-radius: 24px !important;
      box-shadow: 0 4px 24px rgba(0,60,120,0.06), inset 0 1px 0 rgba(255,255,255,0.5);
      backdrop-filter: blur(20px) saturate(1.3);
      transition: all 0.35s cubic-bezier(.25,1,.5,1) !important;
      overflow: hidden;
    }
    [data-theme="liquid-glass"] .file-card:hover {
      border-color: rgba(56,189,248,0.35) !important;
      transform: translateY(-4px) !important;
      box-shadow: 0 12px 40px rgba(0,60,120,0.1), 0 0 0 1px rgba(56,189,248,0.1), inset 0 1px 0 rgba(255,255,255,0.6) !important;
      background: rgba(255,255,255,0.65) !important;
    }
    [data-theme="liquid-glass"] .file-card-preview {
      background: linear-gradient(180deg, rgba(219,234,254,0.5) 0%, rgba(224,242,254,0.4) 100%) !important;
      border-radius: 20px 20px 0 0 !important;
      position: relative;
      overflow: hidden;
    }
    /* Water shimmer on card preview */
    [data-theme="liquid-glass"] .file-card-preview::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(105deg, transparent 30%, rgba(255,255,255,0.5) 45%, rgba(56,189,248,0.08) 50%, rgba(255,255,255,0.5) 55%, transparent 70%);
      transform: translateX(-100%);
      animation: glassShimmer 4s ease-in-out infinite 2s;
      pointer-events: none;
    }
    [data-theme="liquid-glass"] .file-card-body {
      padding: 16px 18px !important;
    }
    [data-theme="liquid-glass"] .file-card-name {
      color: #0c1929;
      font-weight: 600;
      letter-spacing: -0.3px;
    }
    [data-theme="liquid-glass"] .file-card-type {
      border-radius: 9999px !important;
      font-weight: 600;
    }
    [data-theme="liquid-glass"] .file-card-actions .btn-icon {
      background: rgba(255,255,255,0.6) !important;
      backdrop-filter: blur(20px) saturate(1.3) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      border-radius: 12px !important;
      color: #1e3a5f !important;
      box-shadow: 0 4px 16px rgba(0,60,120,0.06), inset 0 1px 0 rgba(255,255,255,0.4);
    }
    [data-theme="liquid-glass"] .file-card-actions .btn-icon:hover {
      background: rgba(255,255,255,0.85) !important;
      color: var(--glass-water) !important;
      transform: scale(1.08);
      box-shadow: 0 4px 20px rgba(0,60,120,0.1);
    }
    [data-theme="liquid-glass"] .file-card-checkbox {
      border-radius: 10px !important;
      background: rgba(255,255,255,0.5) !important;
      backdrop-filter: blur(12px);
      border: 2px solid rgba(56,189,248,0.2) !important;
    }
    [data-theme="liquid-glass"] .file-card.selected .file-card-checkbox {
      background: var(--glass-water) !important;
      border-color: var(--glass-water) !important;
    }
    [data-theme="liquid-glass"] .file-card.selected {
      border-color: rgba(56,189,248,0.4) !important;
      box-shadow: 0 0 0 3px rgba(56,189,248,0.12), 0 8px 30px rgba(0,60,120,0.08) !important;
    }

    /* ===== LIQUID GLASS: List View ===== */
    [data-theme="liquid-glass"] .file-list-item {
      border-radius: 16px !important;
      transition: all 0.3s cubic-bezier(.25,1,.5,1);
      backdrop-filter: blur(12px);
    }
    [data-theme="liquid-glass"] .file-list-item:hover {
      background: rgba(255,255,255,0.55) !important;
      border-color: rgba(56,189,248,0.15) !important;
    }
    [data-theme="liquid-glass"] .file-list-item .file-icon-mini {
      border-radius: 12px !important;
    }

    /* ===== LIQUID GLASS: Category Headers ===== */
    [data-theme="liquid-glass"] .category-header {
      border-radius: 20px !important;
      background: rgba(255,255,255,0.45) !important;
      backdrop-filter: blur(20px);
      border: 1.5px solid rgba(255,255,255,0.4) !important;
      font-weight: 700;
      color: #0c1929;
    }

    /* ===== LIQUID GLASS: PDF Viewer â€” Premium frosted glass ===== */
    [data-theme="liquid-glass"] .viewer-overlay {
      background: rgba(200,220,245,0.65) !important;
      backdrop-filter: blur(24px) !important;
    }
    [data-theme="liquid-glass"] .viewer-header {
      background: rgba(255,255,255,0.72) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border-bottom: 1px solid rgba(0,60,120,0.08) !important;
      box-shadow: 0 2px 20px rgba(0,60,120,0.08) !important;
      border-radius: 0 0 24px 24px !important;
    }
    [data-theme="liquid-glass"] .viewer-header .viewer-title {
      color: #0c1929 !important;
      font-weight: 700;
    }
    [data-theme="liquid-glass"] .viewer-header .btn,
    [data-theme="liquid-glass"] .viewer-header .btn-icon,
    [data-theme="liquid-glass"] .viewer-controls .btn {
      background: rgba(255,255,255,0.55) !important;
      border: 1.5px solid rgba(0,60,120,0.1) !important;
      border-radius: 14px !important;
      color: #1e3a5f !important;
      backdrop-filter: blur(12px);
    }
    [data-theme="liquid-glass"] .viewer-header .btn:hover,
    [data-theme="liquid-glass"] .viewer-header .btn-icon:hover,
    [data-theme="liquid-glass"] .viewer-controls .btn:hover {
      background: rgba(255,255,255,0.85) !important;
      color: #0369a1 !important;
      border-color: rgba(56,189,248,0.3) !important;
      box-shadow: 0 4px 16px rgba(0,60,120,0.1) !important;
    }
    [data-theme="liquid-glass"] .viewer-controls .btn-success {
      background: rgba(16, 185, 129, 0.12) !important;
      border-color: rgba(16, 185, 129, 0.25) !important;
      color: #047857 !important;
    }
    [data-theme="liquid-glass"] .viewer-controls .btn-success:hover {
      background: rgba(16, 185, 129, 0.22) !important;
      color: #065f46 !important;
    }
    [data-theme="liquid-glass"] .viewer-header .viewer-zoom-group .btn-icon {
      border-radius: 12px !important;
    }
    [data-theme="liquid-glass"] .viewer-header select {
      border-radius: 12px !important;
      background: rgba(255,255,255,0.55) !important;
      border: 1.5px solid rgba(0,60,120,0.1) !important;
      color: #0c1929 !important;
      font-weight: 600;
    }
    /* Page nav â€” dark text on glass */
    [data-theme="liquid-glass"] .viewer-page-nav {
      background: rgba(255,255,255,0.45) !important;
      border: 1px solid rgba(0,60,120,0.08) !important;
      color: #1e3a5f !important;
    }
    [data-theme="liquid-glass"] .viewer-page-nav input {
      background: rgba(255,255,255,0.6) !important;
      border: 1px solid rgba(0,60,120,0.1) !important;
      color: #0c1929 !important;
    }
    [data-theme="liquid-glass"] .viewer-page-nav input:focus {
      border-color: #38bdf8 !important;
      box-shadow: 0 0 0 2px rgba(56,189,248,0.25) !important;
    }
    [data-theme="liquid-glass"] .viewer-page-nav span,
    [data-theme="liquid-glass"] .viewer-header span {
      color: #475569 !important;
    }
    /* Sidebar â€” glass on light */
    [data-theme="liquid-glass"] .viewer-sidebar {
      background: rgba(255,255,255,0.5) !important;
      border-right: 1px solid rgba(0,60,120,0.06) !important;
      backdrop-filter: blur(30px) !important;
    }
    [data-theme="liquid-glass"] .viewer-sidebar .thumb-item {
      border-bottom: 1px solid rgba(0,60,120,0.04) !important;
      color: #1e3a5f !important;
    }
    [data-theme="liquid-glass"] .viewer-sidebar .thumb-item:hover {
      background: rgba(56,189,248,0.06) !important;
    }
    [data-theme="liquid-glass"] .viewer-sidebar .thumb-item.active {
      background: rgba(56,189,248,0.1) !important;
      border-left: 3px solid #38bdf8 !important;
    }
    /* Loading overlay */
    [data-theme="liquid-glass"] .viewer-loading {
      color: #1e3a5f !important;
    }
    [data-theme="liquid-glass"] .viewer-loading div {
      color: #475569 !important;
    }
    /* Scroll progress */
    [data-theme="liquid-glass"] .pdf-scroll-progress {
      background: rgba(255,255,255,0.4) !important;
    }
    [data-theme="liquid-glass"] .pdf-scroll-progress-fill {
      background: linear-gradient(90deg, #38bdf8, #0ea5e9) !important;
    }
    [data-theme="liquid-glass"] .pdf-page-jump {
      background: rgba(255,255,255,0.8) !important;
      color: #0c1929 !important;
      border: 1px solid rgba(0,60,120,0.1) !important;
      backdrop-filter: blur(20px) !important;
    }

    /* ===== LIQUID GLASS: Image Viewer ===== */
    [data-theme="liquid-glass"] .image-viewer-overlay {
      background: rgba(219,234,254,0.6) !important;
      backdrop-filter: blur(24px) !important;
    }
    [data-theme="liquid-glass"] .image-viewer-header {
      background: rgba(255,255,255,0.5) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border-bottom: 1px solid rgba(255,255,255,0.5) !important;
    }
    [data-theme="liquid-glass"] .image-viewer-sidebar {
      background: rgba(255,255,255,0.4) !important;
      border-left: 1px solid rgba(255,255,255,0.4) !important;
      backdrop-filter: blur(40px) !important;
    }

    /* ===== LIQUID GLASS: DOCX Viewer ===== */
    [data-theme="liquid-glass"] .docx-viewer-overlay {
      background: rgba(219,234,254,0.6) !important;
      backdrop-filter: blur(24px) !important;
    }
    [data-theme="liquid-glass"] .docx-viewer-header {
      background: rgba(255,255,255,0.5) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
    }
    [data-theme="liquid-glass"] .docx-content-wrapper {
      background: rgba(255,255,255,0.7) !important;
      backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 8px 40px rgba(0,60,120,0.06);
    }

    /* ===== LIQUID GLASS: Modal Dialogs â€” Large rounded frosted glass ===== */
    [data-theme="liquid-glass"] .modal-content,
    [data-theme="liquid-glass"] .stats-modal-content,
    [data-theme="liquid-glass"] .shortcuts-content {
      border-radius: 32px !important;
      background: rgba(255,255,255,0.65) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.6) !important;
      box-shadow: 0 24px 80px rgba(0,60,120,0.12), inset 0 1px 0 rgba(255,255,255,0.6) !important;
      color: #0c1929;
    }
    [data-theme="liquid-glass"] .modal-overlay,
    [data-theme="liquid-glass"] .stats-modal,
    [data-theme="liquid-glass"] .shortcuts-modal {
      background: rgba(219,234,254,0.5) !important;
      backdrop-filter: blur(12px) !important;
    }

    /* ===== LIQUID GLASS: FAB â€” Water droplet style ===== */
    [data-theme="liquid-glass"] .fab {
      background: linear-gradient(135deg, #0284c7, #38bdf8) !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      box-shadow: 0 8px 32px rgba(2,132,199,0.3), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      color: white !important;
      animation: glassPulseGlow 3s ease-in-out infinite;
    }
    [data-theme="liquid-glass"] .fab:hover {
      transform: scale(1.1) translateY(-2px) !important;
      box-shadow: 0 12px 40px rgba(2,132,199,0.4), inset 0 1px 0 rgba(255,255,255,0.5) !important;
    }
    [data-theme="liquid-glass"] .fab-menu {
      background: rgba(255,255,255,0.6) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      border-radius: 24px !important;
      box-shadow: 0 16px 60px rgba(0,60,120,0.12) !important;
    }

    /* ===== LIQUID GLASS: Upload Modal ===== */
    [data-theme="liquid-glass"] .upload-modal-content {
      border-radius: 32px !important;
      background: rgba(255,255,255,0.65) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5);
      box-shadow: 0 24px 80px rgba(0,60,120,0.12);
    }
    [data-theme="liquid-glass"] .upload-dropzone {
      border-radius: 24px !important;
      border: 2px dashed rgba(56,189,248,0.35) !important;
      background: rgba(219,234,254,0.2) !important;
      transition: all 0.3s ease;
    }
    [data-theme="liquid-glass"] .upload-dropzone:hover,
    [data-theme="liquid-glass"] .upload-dropzone.dragover {
      border-color: var(--glass-water) !important;
      background: rgba(219,234,254,0.35) !important;
      box-shadow: inset 0 0 30px rgba(56,189,248,0.08);
    }

    /* ===== LIQUID GLASS: Selection Bar ===== */
    [data-theme="liquid-glass"] .selection-bar {
      border-radius: 20px !important;
      background: rgba(255,255,255,0.7) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      box-shadow: 0 8px 30px rgba(0,60,120,0.08) !important;
      color: #0c1929;
    }

    /* ===== LIQUID GLASS: Badge ===== */
    [data-theme="liquid-glass"] .badge {
      border-radius: 9999px !important;
      font-weight: 700;
      background: linear-gradient(90deg, rgba(56,189,248,0.12), rgba(99,102,241,0.12), rgba(56,189,248,0.12)) !important;
      background-size: 200% auto;
      animation: glassBadgeShimmer 4s ease-in-out infinite;
      color: var(--glass-deep);
      border: 1px solid rgba(56,189,248,0.2);
    }

    /* ===== LIQUID GLASS: Empty State ===== */
    [data-theme="liquid-glass"] .empty-state {
      animation: glassReveal 0.8s ease-out;
    }
    [data-theme="liquid-glass"] .empty-state i {
      color: var(--glass-sky);
      filter: drop-shadow(0 4px 12px rgba(56,189,248,0.2));
    }

    /* ===== LIQUID GLASS: Scrollbar ===== */
    [data-theme="liquid-glass"] ::-webkit-scrollbar-thumb {
      background: rgba(56,189,248,0.25) !important;
      border-radius: 8px;
    }
    [data-theme="liquid-glass"] ::-webkit-scrollbar-thumb:hover {
      background: rgba(56,189,248,0.4) !important;
    }
    [data-theme="liquid-glass"] ::-webkit-scrollbar-track {
      background: transparent !important;
    }

    /* ===== LIQUID GLASS: Context Menu ===== */
    [data-theme="liquid-glass"] .context-menu {
      border-radius: 20px !important;
      background: rgba(255,255,255,0.7) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      box-shadow: 0 12px 48px rgba(0,60,120,0.12), inset 0 1px 0 rgba(255,255,255,0.5) !important;
      padding: 8px !important;
    }
    [data-theme="liquid-glass"] .context-menu-item {
      border-radius: 12px !important;
      font-weight: 500;
      color: #0c1929;
    }
    [data-theme="liquid-glass"] .context-menu-item:hover {
      background: rgba(56,189,248,0.1) !important;
      color: var(--glass-deep);
    }

    /* ===== LIQUID GLASS: Toast notifications ===== */
    [data-theme="liquid-glass"] .toast {
      border-radius: 20px !important;
      background: rgba(255,255,255,0.8) !important;
      backdrop-filter: blur(40px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      box-shadow: 0 8px 30px rgba(0,60,120,0.08), inset 0 1px 0 rgba(255,255,255,0.5) !important;
      color: #0c1929;
      font-weight: 500;
    }

    /* ===== LIQUID GLASS: Rename modal ===== */
    [data-theme="liquid-glass"] .rename-modal-content {
      border-radius: 28px !important;
      background: rgba(255,255,255,0.7) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
    }
    [data-theme="liquid-glass"] .rename-modal-content input {
      border-radius: 14px !important;
      background: rgba(255,255,255,0.5) !important;
      border: 1.5px solid rgba(56,189,248,0.2) !important;
      color: #0c1929;
      font-weight: 500;
    }
    [data-theme="liquid-glass"] .rename-modal-content input:focus {
      border-color: var(--glass-water) !important;
      box-shadow: 0 0 0 3px rgba(56,189,248,0.15) !important;
    }

    /* ===== LIQUID GLASS: File type badges ===== */
    [data-theme="liquid-glass"] .file-type-pdf {
      background: rgba(220,38,38,0.08) !important;
      color: #991b1b !important;
      font-weight: 700;
    }
    [data-theme="liquid-glass"] .file-type-doc,
    [data-theme="liquid-glass"] .file-type-docx {
      background: rgba(56,189,248,0.1) !important;
      color: var(--glass-deep) !important;
      font-weight: 700;
    }
    [data-theme="liquid-glass"] .file-type-img {
      background: rgba(5,150,105,0.08) !important;
      color: #065f46 !important;
      font-weight: 700;
    }

    /* ===== LIQUID GLASS: Content area water caustic ===== */
    [data-theme="liquid-glass"] .content-area {
      position: relative;
    }
    [data-theme="liquid-glass"] .content-area::before {
      content: '';
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(2);
      width: 100vw;
      height: 60vh;
      background: radial-gradient(ellipse at center bottom,
        rgba(56,189,248,0.06) 0%,
        rgba(14,165,233,0.04) 25%,
        rgba(99,102,241,0.04) 50%,
        transparent 80%
      );
      filter: blur(50px);
      pointer-events: none;
      z-index: 0;
    }

    /* ===== LIQUID GLASS: Theme picker card highlight ===== */
    [data-theme="liquid-glass"] .theme-card.active {
      border-color: var(--glass-water) !important;
      box-shadow: 0 0 0 3px rgba(56,189,248,0.2), 0 8px 30px rgba(0,60,120,0.1) !important;
    }

    /* ===== LIQUID GLASS: Command palette ===== */
    [data-theme="liquid-glass"] .command-palette {
      background: rgba(255,255,255,0.7) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      border-radius: 24px !important;
      box-shadow: 0 24px 80px rgba(0,60,120,0.12) !important;
    }
    [data-theme="liquid-glass"] .command-palette input {
      background: transparent !important;
      color: #0c1929 !important;
      font-weight: 500;
    }
    [data-theme="liquid-glass"] .command-palette-item {
      border-radius: 12px !important;
      color: #0c1929;
    }
    [data-theme="liquid-glass"] .command-palette-item:hover,
    [data-theme="liquid-glass"] .command-palette-item.active {
      background: rgba(56,189,248,0.1) !important;
    }

    /* ===== LIQUID GLASS: Mini player ===== */
    [data-theme="liquid-glass"] .mini-player {
      border-radius: 24px !important;
      background: rgba(255,255,255,0.65) !important;
      backdrop-filter: blur(40px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      box-shadow: 0 8px 30px rgba(0,60,120,0.08), inset 0 1px 0 rgba(255,255,255,0.5) !important;
    }

    /* ===== LIQUID GLASS: Reading progress bar ===== */
    [data-theme="liquid-glass"] .reading-progress {
      background: rgba(56,189,248,0.1) !important;
    }
    [data-theme="liquid-glass"] .reading-progress-bar {
      background: linear-gradient(90deg, #0284c7, #38bdf8, #7dd3fc) !important;
      box-shadow: 0 0 12px rgba(56,189,248,0.3);
    }

    /* ===== LIQUID GLASS: Theme picker panel ===== */
    [data-theme="liquid-glass"] .theme-picker .theme-picker-content {
      background: rgba(255,255,255,0.65) !important;
      backdrop-filter: blur(60px) saturate(200%) !important;
      border: 1.5px solid rgba(255,255,255,0.5) !important;
      border-radius: 32px !important;
    }

    /* ===== LIQUID GLASS: Global text contrast boost ===== */
    [data-theme="liquid-glass"] h1,
    [data-theme="liquid-glass"] h2,
    [data-theme="liquid-glass"] h3,
    [data-theme="liquid-glass"] h4 {
      color: #0c1929 !important;
      font-weight: 700;
    }
    [data-theme="liquid-glass"] p,
    [data-theme="liquid-glass"] span,
    [data-theme="liquid-glass"] label {
      color: #1e3a5f;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: var(--transition);
    }

    /* ===== ANIMATED BACKGROUND ===== */
    .bg-effects {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .bg-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
      animation: orbFloat 20s ease-in-out infinite;
    }

    .bg-orb:nth-child(1) {
      width: 600px; height: 600px;
      background: #7c3aed;
      top: -200px; left: -100px;
      animation-delay: 0s;
    }

    .bg-orb:nth-child(2) {
      width: 500px; height: 500px;
      background: #3b82f6;
      top: 50%; right: -150px;
      animation-delay: -7s;
    }

    .bg-orb:nth-child(3) {
      width: 400px; height: 400px;
      background: #a855f7;
      bottom: -100px; left: 30%;
      animation-delay: -14s;
    }

    @keyframes orbFloat {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(50px, -80px) scale(1.1); }
      50% { transform: translate(-30px, 50px) scale(0.9); }
      75% { transform: translate(60px, 30px) scale(1.05); }
    }

    /* ===== ANIMATED BG CANVAS ===== */
    #bgCanvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    .grid-overlay {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(124, 58, 237, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(124, 58, 237, 0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      z-index: 0;
      pointer-events: none;
    }

    /* Hide grid for themes that don't need it */
    [data-theme="google"] .grid-overlay,
    [data-theme="liquid-glass"] .grid-overlay,
    [data-theme="vscode-light"] .grid-overlay { opacity: 0; }

    [data-theme="vscode-dark"] .grid-overlay {
      background-image:
        linear-gradient(rgba(86, 156, 214, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(86, 156, 214, 0.03) 1px, transparent 1px);
    }

    [data-theme="techi"] .grid-overlay {
      background-image:
        linear-gradient(rgba(0, 255, 213, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 213, 0.04) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* ===== THEME PICKER MODAL ===== */
    .theme-picker {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 900;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      animation: fadeIn 0.25s ease;
    }
    .theme-picker.active { display: flex; }

    .theme-picker-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      width: 560px;
      max-width: 92vw;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .theme-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .theme-picker-header h3 {
      font-size: 18px;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .theme-card {
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0;
      cursor: pointer;
      transition: var(--transition);
      overflow: hidden;
      background: var(--bg-card);
    }
    .theme-card:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .theme-card.active {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .theme-card-preview {
      height: 72px;
      position: relative;
      overflow: hidden;
    }

    .theme-card-info {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .theme-card-info .theme-name {
      font-size: 12.5px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .theme-card-info .theme-icon {
      font-size: 14px;
    }

    /* ===== MATRIX RAIN (Easter Egg) ===== */
    #matrixCanvas {
      position: fixed;
      inset: 0;
      z-index: 9999;
      pointer-events: none;
      display: none;
      opacity: 0.7;
    }

    /* ===== PARTICLES (Easter Egg) ===== */
    .particle-burst {
      position: fixed;
      width: 8px; height: 8px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10000;
      animation: particleFly 1s ease-out forwards;
    }

    @keyframes particleFly {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0) translate(var(--tx), var(--ty)); }
    }

    /* ===== APP WRAPPER ===== */
    .app { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; }

    /* ===== HEADER ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-glass);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left { display: flex; align-items: center; gap: 16px; flex-shrink: 0; }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      text-decoration: none;
      color: var(--text-primary);
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }

    .logo:hover .logo-icon { transform: rotate(180deg) scale(1.1); }

    .logo-icon::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.2));
    }

    .logo-text { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }
    .logo-text span { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .logo-version {
      font-size: 10px;
      background: var(--accent-gradient);
      color: white;
      padding: 2px 6px;
      border-radius: 99px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .header-center { flex: 1; max-width: 500px; }

    .search-box {
      position: relative;
      width: 100%;
    }

    .search-box input {
      width: 100%;
      height: 40px;
      padding: 0 16px 0 40px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: var(--transition);
    }

    .search-box input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .search-box input::placeholder { color: var(--text-muted); }

    .search-box i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 14px;
    }

    .search-box .search-shortcut {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      text-decoration: none;
    }

    .btn:hover { background: var(--bg-hover); border-color: var(--border-hover); transform: translateY(-1px); }

    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
    }

    .btn-primary {
      background: var(--accent-gradient);
      border: none;
      color: white;
      font-weight: 600;
    }

    .btn-primary:hover {
      box-shadow: var(--shadow-glow);
      transform: translateY(-2px);
    }

    .btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }

    .btn-success { border-color: var(--success); color: var(--success); }
    .btn-success:hover { background: rgba(16, 185, 129, 0.1); }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      background: var(--accent-primary);
      color: white;
      min-width: 20px;
      justify-content: center;
    }

    /* ===== TOOLBAR ===== */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      gap: 16px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
    }

    .toolbar-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .toolbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .sort-select {
      height: 36px;
      padding: 0 32px 0 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      appearance: none;
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239898b0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      outline: none;
      transition: var(--transition);
    }

    .sort-select:focus { border-color: var(--accent-primary); }

    .view-toggle {
      display: flex;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .view-toggle button {
      width: 36px;
      height: 34px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: var(--transition);
    }

    .view-toggle button.active {
      background: var(--accent-primary);
      color: white;
    }

    .selection-bar {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      background: var(--accent-primary);
      color: white;
      font-size: 13px;
      font-weight: 500;
      animation: slideDown 0.3s ease;
    }

    .selection-bar.visible { display: flex; }

    .selection-bar .btn {
      border-color: rgba(255,255,255,0.3);
      color: white;
      background: rgba(255,255,255,0.1);
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ===== STATS BAR ===== */
    .stats-bar {
      display: flex;
      gap: 24px;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .stat-item i { color: var(--accent-secondary); font-size: 14px; }
    .stat-item strong { color: var(--text-primary); font-weight: 600; }

    /* ===== MAIN CONTENT ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .content-area {
      flex: 1;
      padding: 24px;
    }

    /* ===== GRID VIEW ===== */
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .file-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      group: true;
    }

    .file-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
    }

    .file-card.selected {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .file-card-preview {
      height: 160px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .file-card-preview canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .file-card-preview .file-type-icon {
      font-size: 48px;
      color: var(--text-muted);
      opacity: 0.5;
    }

    .file-card-preview .preview-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(transparent 40%, var(--bg-card));
      opacity: 0;
      transition: var(--transition);
    }

    .file-card:hover .preview-overlay { opacity: 1; }

    .file-card-checkbox {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
      opacity: 0;
      transition: var(--transition);
      color: white;
      font-size: 11px;
    }

    .file-card:hover .file-card-checkbox,
    .file-card.selected .file-card-checkbox { opacity: 1; }
    .file-card.selected .file-card-checkbox {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .file-card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: var(--transition);
      z-index: 2;
    }

    .file-card:hover .file-card-actions { opacity: 1; }

    .file-card-actions .btn-icon {
      width: 32px;
      height: 32px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      border: none;
      color: white;
      border-radius: 8px;
      font-size: 12px;
    }

    .file-card-actions .btn-icon:hover { background: var(--accent-primary); }

    .file-card-body {
      padding: 16px;
    }

    .file-card-name {
      font-weight: 600;
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
    }

    .file-card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    .file-card-type {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 99px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .file-type-pdf { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .file-type-doc, .file-type-docx { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .file-type-ppt, .file-type-pptx { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .file-type-txt { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .file-type-img { background: rgba(168, 85, 247, 0.15); color: #a855f7; }

    /* ===== LIST VIEW ===== */
    .file-list { display: flex; flex-direction: column; gap: 2px; }

    .file-list-item {
      display: grid;
      grid-template-columns: 40px 1fr 100px 140px 100px 120px;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
    }

    .file-list-item:hover {
      background: var(--bg-hover);
      border-color: var(--border);
    }

    .file-list-item.selected {
      background: rgba(124, 58, 237, 0.08);
      border-color: var(--accent-primary);
    }

    .file-list-item .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 5px;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 10px;
      color: transparent;
    }

    .file-list-item.selected .checkbox {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .file-list-item .file-info {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .file-list-item .file-icon-mini {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .file-list-item .file-name {
      font-weight: 500;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-list-item .file-size,
    .file-list-item .file-date,
    .file-list-item .file-type-tag {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .file-list-item .file-actions {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
      opacity: 0;
      transition: var(--transition);
    }

    .file-list-item:hover .file-actions { opacity: 1; }

    /* ===== PDF VIEWER MODAL â€” PREMIUM REDESIGN ===== */
    .viewer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(30px) saturate(150%);
      -webkit-backdrop-filter: blur(30px) saturate(150%);
      animation: viewerOpen 0.4s cubic-bezier(.25,1,.5,1);
    }

    .viewer-overlay.active { display: flex; flex-direction: column; }

    @keyframes viewerOpen {
      from { opacity: 0; transform: scale(0.97); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 24px;
      background: rgba(20, 20, 30, 0.7);
      backdrop-filter: blur(40px) saturate(180%);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      gap: 16px;
      flex-shrink: 0;
      z-index: 10;
    }

    .viewer-title {
      font-weight: 600;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      color: rgba(255,255,255,0.9);
      letter-spacing: -0.2px;
    }

    .viewer-controls {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .viewer-controls .btn {
      background: rgba(255,255,255,0.06) !important;
      border: 1px solid rgba(255,255,255,0.08) !important;
      color: rgba(255,255,255,0.8) !important;
      border-radius: 10px !important;
      width: 36px;
      height: 34px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
    }
    .viewer-controls .btn:hover {
      background: rgba(255,255,255,0.12) !important;
      border-color: rgba(255,255,255,0.15) !important;
      color: white !important;
      transform: translateY(-1px) !important;
    }
    .viewer-controls .btn-success {
      background: rgba(16, 185, 129, 0.15) !important;
      border-color: rgba(16, 185, 129, 0.2) !important;
      color: #34d399 !important;
    }
    .viewer-controls .btn-success:hover {
      background: rgba(16, 185, 129, 0.25) !important;
    }

    .viewer-page-nav {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 4px 14px;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .viewer-page-nav input {
      width: 50px;
      text-align: center;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-family: 'JetBrains Mono', monospace;
      padding: 4px;
      outline: none;
    }

    .viewer-page-nav input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(124,58,237,0.3);
    }

    .viewer-page-divider {
      color: rgba(255,255,255,0.5);
      font-size: 13px;
    }

    .viewer-zoom-label {
      font-size: 12px;
      min-width: 40px;
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-family: 'JetBrains Mono', monospace;
    }

    .viewer-body {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    .viewer-sidebar {
      width: 200px;
      background: rgba(15, 15, 25, 0.8);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255,255,255,0.06);
      overflow-y: auto;
      flex-shrink: 0;
      display: none;
    }

    .viewer-sidebar.visible { display: block; }

    .viewer-sidebar .thumb-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      transition: all 0.25s ease;
      position: relative;
    }

    .viewer-sidebar .thumb-item:hover { background: rgba(255,255,255,0.04); }
    .viewer-sidebar .thumb-item.active {
      background: rgba(124, 58, 237, 0.12);
      border-left: 3px solid var(--accent-primary);
    }

    .viewer-sidebar .thumb-item canvas {
      width: 100%;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .viewer-sidebar .thumb-item .page-num {
      text-align: center;
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      margin-top: 6px;
      font-weight: 500;
    }

    .viewer-canvas-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 20px 80px;
      background: linear-gradient(180deg, #0f0f15 0%, #141420 50%, #0f0f15 100%);
      scroll-behavior: smooth;
      gap: 24px;
    }

    /* Single page canvas (legacy, kept for PiP) */
    .viewer-canvas-container > canvas#viewerCanvas {
      display: none;
    }

    /* All-pages scroll container */
    .pdf-pages-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 28px;
      width: fit-content;
      min-width: 100%;
    }

    .pdf-page-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: pdfPageReveal 0.5s ease both;
    }

    @keyframes pdfPageReveal {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .pdf-page-wrapper canvas {
      box-shadow:
        0 2px 4px rgba(0,0,0,0.2),
        0 8px 24px rgba(0,0,0,0.3),
        0 24px 60px rgba(0,0,0,0.25);
      border-radius: 6px;
      background: white;
      display: block;
      transition: box-shadow 0.3s ease;
    }

    .pdf-page-wrapper:hover canvas {
      box-shadow:
        0 2px 4px rgba(0,0,0,0.2),
        0 8px 24px rgba(0,0,0,0.35),
        0 32px 80px rgba(0,0,0,0.3),
        0 0 0 1px rgba(124,58,237,0.15);
    }

    .pdf-page-label {
      margin-top: 10px;
      font-size: 12px;
      font-weight: 500;
      color: rgba(255,255,255,0.3);
      letter-spacing: 0.5px;
      user-select: none;
      padding: 4px 16px;
      border-radius: 99px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.04);
      transition: all 0.25s ease;
    }

    .pdf-page-wrapper:hover .pdf-page-label {
      color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.08);
    }

    /* Scroll progress indicator */
    .pdf-scroll-progress {
      position: fixed;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 120px;
      background: rgba(255,255,255,0.06);
      border-radius: 99px;
      z-index: 1001;
      display: none;
      overflow: hidden;
    }
    .viewer-overlay.active .pdf-scroll-progress { display: block; }

    .pdf-scroll-progress-fill {
      width: 100%;
      background: var(--accent-gradient);
      border-radius: 99px;
      transition: height 0.15s ease;
    }

    /* Page jump tooltip */
    .pdf-page-jump {
      position: fixed;
      right: 32px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(20,20,30,0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px;
      padding: 8px 16px;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      z-index: 1002;
      display: none;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .viewer-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(10, 10, 15, 0.9);
      z-index: 10;
      gap: 16px;
    }

    .viewer-loading .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-container {
      width: 260px;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 99px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--accent-gradient);
      border-radius: 99px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* ===== UPLOAD MODAL ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 520px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { transform: scale(0.9) translateY(20px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: var(--transition);
    }

    .modal-close:hover { background: var(--danger); color: white; }

    /* ===== UPLOAD DROP ZONE ===== */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 48px 24px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      position: relative;
    }

    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent-primary);
      background: rgba(124, 58, 237, 0.05);
    }

    .drop-zone.dragover {
      transform: scale(1.02);
      box-shadow: 0 0 40px var(--accent-glow);
    }

    .drop-zone-icon {
      font-size: 48px;
      color: var(--accent-secondary);
      margin-bottom: 16px;
    }

    .drop-zone-text {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .drop-zone-hint {
      font-size: 13px;
      color: var(--text-muted);
    }

    .drop-zone input[type=file] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-list {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .upload-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: 13px;
    }

    .upload-item i { font-size: 20px; color: var(--accent-secondary); }
    .upload-item .upload-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .upload-item .upload-size { color: var(--text-muted); font-size: 12px; }
    .upload-item .upload-status { font-size: 14px; }

    .upload-progress {
      width: 100%;
      margin-top: 16px;
    }

    .upload-progress .progress-bar-container {
      width: 100%;
      height: 6px;
    }

    /* ===== RENAME INPUT ===== */
    .rename-input {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--accent-primary);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      margin-bottom: 16px;
    }

    /* ===== PRINT MODAL ===== */
    .print-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .print-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .print-field span {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .print-field input,
    .print-field select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }

    .print-field input:focus,
    .print-field select:focus {
      border-color: var(--accent-primary);
    }

    .print-checkbox {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .print-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-primary);
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 5000;
      display: flex;
      flex-direction: column-reverse;
      gap: 8px;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      font-size: 14px;
      animation: toastIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
      max-width: 400px;
      backdrop-filter: blur(16px);
    }

    .toast.exit { animation: toastOut 0.3s ease forwards; }

    .toast-icon { font-size: 18px; flex-shrink: 0; }
    .toast-success .toast-icon { color: var(--success); }
    .toast-error .toast-icon { color: var(--danger); }
    .toast-info .toast-icon { color: var(--info); }
    .toast-warning .toast-icon { color: var(--warning); }

    @keyframes toastIn {
      from { transform: translateX(100%) scale(0.8); opacity: 0; }
      to { transform: translateX(0) scale(1); opacity: 1; }
    }

    @keyframes toastOut {
      to { transform: translateX(120%); opacity: 0; }
    }

    /* ===== COMMAND PALETTE ===== */
    .command-palette-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 3000;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      align-items: flex-start;
      justify-content: center;
      padding-top: 15vh;
    }

    .command-palette-overlay.active { display: flex; }

    .command-palette {
      width: 560px;
      max-width: 90vw;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      animation: modalIn 0.2s ease;
    }

    .command-palette input {
      width: 100%;
      padding: 16px 20px;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      outline: none;
    }

    .command-palette-results {
      max-height: 320px;
      overflow-y: auto;
    }

    .command-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      cursor: pointer;
      transition: var(--transition);
    }

    .command-item:hover, .command-item.active { background: var(--bg-hover); }
    .command-item i { width: 20px; text-align: center; color: var(--text-muted); }
    .command-item span { font-size: 14px; }
    .command-item .shortcut {
      margin-left: auto;
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* ===== FLOATING ACTION BUTTON ===== */
    .fab-container {
      position: fixed;
      bottom: 24px;
      left: 24px;
      z-index: 500;
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      align-items: center;
    }

    .fab {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent-gradient);
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      box-shadow: var(--shadow-md), var(--shadow-glow);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .fab:hover { transform: scale(1.1) rotate(90deg); }

    .fab-menu {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .fab-menu.open { display: flex; }

    .fab-menu-item {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      position: relative;
    }

    .fab-menu-item:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
      transform: scale(1.15);
    }

    .fab-menu-item .tooltip {
      position: absolute;
      left: calc(100% + 12px);
      white-space: nowrap;
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      pointer-events: none;
      opacity: 0;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    .fab-menu-item:hover .tooltip { opacity: 1; }

    /* ===== READING PROGRESS ===== */
    .reading-progress {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      height: 3px;
      z-index: 99;
      background: transparent;
    }

    .reading-progress-fill {
      height: 100%;
      background: var(--accent-gradient);
      width: 0%;
      transition: width 0.2s ease;
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 24px;
      text-align: center;
    }

    .empty-state-icon {
      font-size: 72px;
      margin-bottom: 24px;
      opacity: 0.3;
      animation: emptyBounce 3s ease-in-out infinite;
    }

    @keyframes emptyBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .empty-state h3 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 15px;
      color: var(--text-secondary);
      max-width: 420px;
      line-height: 1.6;
    }

    /* ===== CONTEXT MENU ===== */
    .context-menu {
      display: none;
      position: fixed;
      z-index: 4000;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 6px;
      min-width: 200px;
      box-shadow: var(--shadow-lg);
      animation: modalIn 0.15s ease;
    }

    .context-menu.active { display: block; }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: var(--transition);
      color: var(--text-primary);
    }

    .context-menu-item:hover { background: var(--bg-hover); }
    .context-menu-item i { width: 16px; color: var(--text-muted); font-size: 13px; }
    .context-menu-item.danger { color: var(--danger); }
    .context-menu-item.danger i { color: var(--danger); }
    .context-menu-divider { height: 1px; background: var(--border); margin: 4px 0; }
    .context-menu-label {
      padding: 6px 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 700;
    }
    .context-menu-item.classroom { color: var(--primary); }
    .context-menu-item.classroom i { color: var(--primary); }

    /* Classroom badge on file cards */
    .classroom-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--primary);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 20px;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 4px;
      letter-spacing: .03em;
    }
    .classroom-badge i { font-size: 9px; }

    /* Classroom toggle button */
    .classroom-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: var(--transition);
    }
    .classroom-toggle:hover { background: var(--bg-hover); }
    .classroom-toggle.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .classroom-toggle i { font-size: 12px; }

    /* ===== KEYBOARD SHORTCUTS MODAL ===== */
    .shortcuts-list { display: flex; flex-direction: column; gap: 8px; }
    .shortcut-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .shortcut-row:last-child { border: none; }
    .shortcut-keys {
      display: flex;
      gap: 4px;
    }
    .shortcut-key {
      display: inline-flex;
      padding: 3px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
    }
    .shortcut-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* ===== MINI PLAYER (PiP) ===== */
    .mini-player {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 320px;
      height: 420px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 800;
      overflow: hidden;
      resize: both;
      flex-direction: column;
    }

    .mini-player.active {
      display: flex;
      animation: modalIn 0.3s ease;
    }

    .mini-player-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      cursor: move;
      font-size: 12px;
      font-weight: 600;
    }

    .mini-player-body {
      flex: 1;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1a1a1a;
      padding: 8px;
    }

    .mini-player-body canvas { max-width: 100%; max-height: 100%; }

    .mini-player-footer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header { padding: 0 12px; height: 56px; }
      .header-center { display: none; }
      .logo-text { display: none; }
      .toolbar { padding: 12px; }
      .content-area { padding: 12px; }
      .file-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
      .file-list-item { grid-template-columns: 30px 1fr 80px 80px; }
      .file-list-item .file-date,
      .file-list-item .file-type-tag { display: none; }
      .stats-bar { gap: 12px; padding: 8px 12px; }
      .fab-container { bottom: 16px; left: 16px; }
      .mini-player { width: 260px; height: 360px; bottom: 16px; right: 16px; }
      .print-grid { grid-template-columns: 1fr; }
    }

    /* ===== DRAG OVERLAY ===== */
    .global-drop-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 6000;
      background: rgba(124, 58, 237, 0.1);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      border: 3px dashed var(--accent-primary);
    }

    .global-drop-overlay.active { display: flex; }

    .global-drop-overlay .drop-content {
      text-align: center;
      color: var(--accent-primary);
    }

    .global-drop-overlay .drop-content i { font-size: 72px; margin-bottom: 16px; }
    .global-drop-overlay .drop-content p { font-size: 24px; font-weight: 700; }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

    /* ===== ANIMATIONS ===== */
    .shake { animation: shake 0.5s ease; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
    }

    .confetti-piece {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 10000;
      pointer-events: none;
    }

    @keyframes confettiFall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* ===== IMAGE VIEWER ===== */
    .image-viewer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.92);
      backdrop-filter: blur(12px);
      flex-direction: column;
      animation: fadeIn 0.3s ease;
    }
    .image-viewer-overlay.active { display: flex; }

    .image-viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      gap: 12px;
      flex-shrink: 0;
    }

    .image-viewer-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
      padding: 20px;
      position: relative;
    }

    .image-viewer-body img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
      cursor: zoom-in;
    }

    .image-viewer-body img.zoomed {
      max-width: none;
      max-height: none;
      cursor: zoom-out;
    }

    .image-viewer-info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-glass);
      backdrop-filter: blur(16px);
      padding: 8px 20px;
      border-radius: 99px;
      font-size: 12px;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      display: flex;
      gap: 16px;
      white-space: nowrap;
    }

    /* Gallery nav for images */
    .image-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: var(--transition);
      backdrop-filter: blur(8px);
    }
    .image-nav-btn:hover { background: var(--accent-primary); color: white; }
    .image-nav-btn.prev { left: 20px; }
    .image-nav-btn.next { right: 20px; }

    /* ===== DOCX VIEWER ===== */
    .docx-viewer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      flex-direction: column;
      animation: fadeIn 0.3s ease;
    }
    .docx-viewer-overlay.active { display: flex; }

    .docx-viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      gap: 12px;
      flex-shrink: 0;
    }

    .docx-viewer-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 40px 40px 80px;
      display: flex;
      justify-content: center;
      background: #e8e8e8;
    }

    .docx-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
      align-items: center;
    }

    .docx-toolbar-group {
      display: flex;
      gap: 6px;
      align-items: center;
      padding-right: 8px;
      margin-right: 2px;
      border-right: 1px solid var(--border);
    }

    .docx-toolbar-group:last-child {
      border-right: none;
      padding-right: 0;
      margin-right: 0;
    }

    .docx-tool-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 12px;
    }

    .docx-tool-btn:hover {
      border-color: var(--border-hover);
      background: var(--bg-hover);
    }

    .docx-tool-select,
    .docx-tool-input {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      height: 32px;
      padding: 0 10px;
      font-size: 12px;
      font-family: inherit;
    }

    .docx-tool-input {
      padding: 0;
      width: 34px;
    }

    .docx-content {
      max-width: 816px;
      width: 100%;
      background: #fff;
      color: #1a1a1a;
      padding: 72px 80px;
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.06);
      font-family: 'Georgia', 'Times New Roman', serif;
      font-size: 14.5px;
      line-height: 1.75;
      min-height: fit-content;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      align-self: flex-start;
    }

    .docx-content[contenteditable="true"] {
      box-shadow: 0 24px 60px rgba(0,0,0,0.26), 0 0 0 2px rgba(99, 102, 241, 0.25);
      outline: none;
    }

    .docx-content h1 {
      font-family: 'Inter', sans-serif;
      font-size: 26px;
      font-weight: 800;
      margin: 0 0 18px;
      color: #111;
      line-height: 1.3;
    }
    .docx-content h2 {
      font-family: 'Inter', sans-serif;
      font-size: 21px;
      font-weight: 700;
      margin: 28px 0 12px;
      color: #1a1a1a;
      line-height: 1.35;
    }
    .docx-content h3 {
      font-family: 'Inter', sans-serif;
      font-size: 17px;
      font-weight: 600;
      margin: 22px 0 8px;
      color: #222;
      line-height: 1.4;
    }
    .docx-content h4, .docx-content h5, .docx-content h6 {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      margin: 18px 0 6px;
      color: #333;
    }

    .docx-content p {
      margin: 8px 0 12px;
      text-align: justify;
      text-justify: inter-word;
    }

    .docx-content p:empty {
      margin: 6px 0;
      min-height: 0.5em;
    }

    .docx-content strong { font-weight: 700; }
    .docx-content em { font-style: italic; }

    .docx-content ul, .docx-content ol {
      padding-left: 2em;
      margin: 8px 0 12px;
    }
    .docx-content li {
      margin: 4px 0;
    }

    .docx-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 16px 0;
      font-size: 13.5px;
    }
    .docx-content td, .docx-content th {
      border: 1px solid #d4d4d4;
      padding: 8px 12px;
      text-align: left;
      vertical-align: top;
    }
    .docx-content th {
      background: #f0f0f0;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
    }
    .docx-content img { max-width: 100%; height: auto; margin: 12px 0; }

    .docx-content blockquote {
      border-left: 3px solid #6366f1;
      padding: 8px 16px;
      margin: 12px 0;
      background: #f8f8fc;
      color: #444;
      font-style: italic;
    }

    .docx-content a {
      color: #4f46e5;
      text-decoration: underline;
    }

    /* ===== CATEGORY GROUP HEADERS ===== */
    .category-group-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 4px 8px;
      margin-top: 8px;
      border-bottom: 1px solid var(--border);
    }

    .category-group-header:first-child { margin-top: 0; }

    .category-group-header .cat-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .category-group-header h3 {
      font-size: 14px;
      font-weight: 700;
      flex: 1;
    }

    .category-group-header .cat-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 2px 10px;
      border-radius: 99px;
    }

    /* Logged-in user indicator */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px 4px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--text-secondary);
      cursor: default;
    }
    .user-badge i { color: var(--accent); }
    .btn-logout {
      padding: 4px 10px;
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      color: var(--text-muted);
      font-size: 11px;
      font-family: inherit;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }
    .btn-logout:hover {
      color: var(--danger);
      border-color: var(--danger);
    }

    /* ===== 2026 REMASTER LAYER ===== */
    @keyframes remasterGlowFloat {
      0%, 100% { transform: translate3d(0,0,0) scale(1); opacity: .35; }
      50% { transform: translate3d(0,-12px,0) scale(1.08); opacity: .55; }
    }
    @keyframes remasterPanelIn {
      from { opacity: 0; transform: translateY(8px) scale(.99); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes remasterCardIn {
      from { opacity: 0; transform: translateY(18px) scale(.985); filter: blur(2px); }
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    .app::before,
    .app::after {
      content: '';
      position: fixed;
      pointer-events: none;
      z-index: 0;
      border-radius: 50%;
      filter: blur(65px);
      animation: remasterGlowFloat 9s ease-in-out infinite;
    }
    .app::before {
      width: 280px;
      height: 280px;
      top: 70px;
      right: -70px;
      background: radial-gradient(circle, rgba(14,165,233,.33), rgba(14,165,233,0) 70%);
    }
    .app::after {
      width: 320px;
      height: 320px;
      left: -120px;
      bottom: 70px;
      background: radial-gradient(circle, rgba(16,185,129,.22), rgba(16,185,129,0) 70%);
      animation-delay: -3s;
    }
    .header,
    .toolbar,
    .selection-bar {
      backdrop-filter: blur(18px) saturate(125%);
      -webkit-backdrop-filter: blur(18px) saturate(125%);
      border-color: color-mix(in srgb, var(--border), #60a5fa 20%);
    }
    .header {
      box-shadow: 0 14px 32px rgba(2, 6, 23, 0.28);
      animation: remasterPanelIn .45s ease both;
    }
    .toolbar {
      border-radius: 18px;
      margin: 12px 14px 0;
      animation: remasterPanelIn .5s ease both;
      animation-delay: .06s;
    }
    .content-area {
      padding-top: 18px;
    }
    .btn,
    .btn-icon,
    .search-input,
    select {
      transition: transform .18s ease, box-shadow .22s ease, border-color .22s ease, background .22s ease;
    }
    .btn:hover,
    .btn-icon:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(2, 6, 23, .2);
    }
    .search-input:focus,
    select:focus {
      border-color: color-mix(in srgb, var(--accent-primary), white 20%);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary), transparent 75%);
    }
    .file-grid {
      gap: 16px;
    }
    .file-card {
      border-width: 1.5px;
      box-shadow: 0 10px 24px rgba(2, 6, 23, .16);
      animation: remasterCardIn .45s ease both;
      transform-origin: center bottom;
    }
    .file-card:nth-child(2n) { animation-delay: .03s; }
    .file-card:nth-child(3n) { animation-delay: .06s; }
    .file-card:hover {
      transform: translateY(-7px) scale(1.012);
      box-shadow: 0 18px 34px rgba(2, 6, 23, .24);
    }
    .file-card-preview {
      border-radius: 12px 12px 0 0;
      overflow: hidden;
    }
    .file-card-name {
      letter-spacing: .1px;
    }
    .file-card-meta {
      margin-top: 7px;
    }
    .modal {
      border-width: 1.5px;
      box-shadow: 0 26px 54px rgba(2, 6, 23, .3);
    }
    .command-palette {
      border-width: 1.5px;
      box-shadow: 0 30px 60px rgba(2, 6, 23, .35);
      backdrop-filter: blur(20px) saturate(120%);
      -webkit-backdrop-filter: blur(20px) saturate(120%);
    }
    .command-item {
      border-radius: 10px;
      margin: 3px 6px;
    }
    .context-menu {
      border-width: 1.5px;
      box-shadow: 0 20px 40px rgba(2, 6, 23, .35);
    }
    .stats-card,
    .theme-picker-panel,
    .docx-content-wrapper,
    .image-viewer-panel {
      box-shadow: 0 18px 40px rgba(2, 6, 23, .24);
    }
    @media (max-width: 768px) {
      .toolbar {
        margin: 10px 10px 0;
        border-radius: 14px;
      }
      .file-grid {
        gap: 12px;
      }
      .file-card:hover {
        transform: translateY(-4px) scale(1.006);
      }
      .app::before {
        width: 220px;
        height: 220px;
      }
      .app::after {
        width: 220px;
        height: 220px;
      }
    }

    /* ===== 2026 DESKTOP DEEP REMASTER ===== */
    @keyframes driveDeskIn {
      from { opacity: 0; transform: translateY(16px) scale(.992); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @media (min-width: 980px) {
      .header {
        height: 74px;
        padding: 0 18px;
      }
      .header-left {
        gap: 18px;
      }
      .header-center {
        max-width: 680px;
      }
      .search-input {
        padding: 11px 14px;
        border-width: 1.5px;
      }
      .toolbar {
        margin: 14px 18px 0;
        padding: 12px 14px;
        min-height: 70px;
      }
      .content-area {
        padding: 20px 18px 28px;
      }
      .category-group-header {
        padding: 18px 4px 10px;
      }
      .file-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 18px;
      }
      .file-card {
        border-radius: 16px;
        overflow: hidden;
      }
      .file-card-body {
        padding: 12px;
      }
      .file-list {
        border-radius: 16px;
        overflow: hidden;
      }
      .file-list-item {
        padding-top: 12px;
        padding-bottom: 12px;
      }
      .viewer-header,
      .image-viewer-header,
      .docx-viewer-header {
        height: 70px;
        border-bottom-width: 1.5px;
      }
      .viewer-body {
        padding: 16px;
      }
      .modal {
        border-radius: 20px;
        animation: driveDeskIn .42s ease both;
      }
      .theme-picker-panel {
        border-radius: 20px;
      }
      .theme-card {
        border-width: 1.5px;
      }
      .theme-card:hover {
        transform: translateY(-4px);
      }
      .command-palette {
        border-radius: 16px;
      }
      .fab {
        width: 64px;
        height: 64px;
        box-shadow: 0 18px 34px color-mix(in srgb, var(--accent-primary), transparent 74%);
      }
      .fab-menu-item {
        box-shadow: 0 12px 24px rgba(2, 6, 23, .22);
      }
      #statsContent > div {
        animation: driveDeskIn .36s ease both;
      }
      #statsContent > div:nth-child(2n) {
        animation-delay: .03s;
      }
    }
  </style>
</head>

<body>
  <!-- Background Effects -->

  <canvas id="bgCanvas"></canvas>
  <div class="bg-effects">
    <div class="bg-orb"></div>
    <div class="bg-orb"></div>
    <div class="bg-orb"></div>
  </div>
  <div class="grid-overlay"></div>
  <canvas id="matrixCanvas"></canvas>

  <!-- Reading Progress -->
  <div class="reading-progress"><div class="reading-progress-fill" id="readingProgress"></div></div>

  <!-- App -->
  <div class="app">

    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <a href="/" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-full);font-size:12px;color:var(--text-secondary);text-decoration:none;margin-right:8px;transition:border-color 0.2s" title="Back to Hub"><i class="fas fa-arrow-left"></i> Hub</a>
        <a class="logo" id="logo" title="Click me a few times ;)">
          <div class="logo-icon"><i class="fas fa-folder-open"></i></div>
          <div class="logo-text"><span>Prenxy Drive</span></div>
          <div class="logo-version">v2.5</div>
        </a>
      </div>

      <div class="header-center">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search documents..." autocomplete="off">
          <span class="search-shortcut">Ctrl+K</span>
        </div>
      </div>

      <div class="header-right">
        <button class="btn btn-icon" id="btnTheme" title="Toggle Theme (T)">
          <i class="fas fa-moon"></i>
        </button>
        <button class="btn btn-icon" id="btnShortcuts" title="Keyboard Shortcuts (?)">
          <i class="fas fa-keyboard"></i>
        </button>
        <button class="btn btn-icon" id="btnStats" title="Dashboard">
          <i class="fas fa-chart-bar"></i>
        </button>
        <button class="btn btn-primary" id="btnUpload">
          <i class="fas fa-cloud-upload-alt"></i>
          <span>Upload</span>
        </button>
        <div class="user-badge" id="userBadge">
          <i class="fas fa-user-circle"></i>
          <span id="userBadgeName">user</span>
        </div>
        <button class="btn-logout" id="btnLogout" title="Sign Out">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <!-- Selection Bar -->
    <div class="selection-bar" id="selectionBar">
      <span id="selectionCount">0 selected</span>
      <div style="flex:1"></div>
      <button class="btn" id="btnBulkDownload"><i class="fas fa-download"></i> Download</button>
      <button class="btn" id="btnBulkDelete"><i class="fas fa-trash"></i> Delete</button>
      <button class="btn" id="btnClearSelection"><i class="fas fa-times"></i> Cancel</button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <select class="sort-select" id="sortSelect">
          <option value="name-asc">Name A-Z</option>
          <option value="name-desc">Name Z-A</option>
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="size-desc">Largest First</option>
          <option value="size-asc">Smallest First</option>
          <option value="type">File Type</option>
          <option value="category">Group by Category</option>
        </select>

        <select class="sort-select" id="filterType">
          <option value="all">All Types</option>
          <option value="pdf">PDF</option>
          <option value="doc">Word / DOCX</option>
          <option value="ppt">PowerPoint</option>
          <option value="txt">Text</option>
          <option value="img">Images (All)</option>
        </select>

        <button class="btn" id="btnSelectAll">
          <i class="far fa-check-square"></i> Select All
        </button>
        <button class="classroom-toggle" id="btnClassroom" style="display:none" onclick="app.toggleClassroom()">
          <i class="fas fa-chalkboard-teacher"></i> Classroom
        </button>
      </div>

      <div class="toolbar-right">
        <span style="font-size: 13px; color: var(--text-muted);" id="fileCount">0 files</span>
        <div class="view-toggle">
          <button id="viewGrid" class="active" title="Grid View"><i class="fas fa-th-large"></i></button>
          <button id="viewList" title="List View"><i class="fas fa-list"></i></button>
        </div>
        <button class="btn btn-icon" id="btnRefresh" title="Refresh (R)"><i class="fas fa-sync-alt"></i></button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-item"><i class="fas fa-folder-open"></i> <strong id="statFiles">0</strong> files</div>
      <div class="stat-item"><i class="fas fa-hdd"></i> <strong id="statSize">0 B</strong> total</div>
      <div class="stat-item"><i class="fas fa-file-pdf"></i> <strong id="statPdfs">0</strong> PDFs</div>
      <div class="stat-item"><i class="fas fa-file-image"></i> <strong id="statImages">0</strong> images</div>
      <div class="stat-item"><i class="fas fa-file-word"></i> <strong id="statDocs">0</strong> docs</div>
      <div class="stat-item"><i class="fas fa-eye"></i> <strong id="statViews">0</strong> views</div>
      <div class="stat-item"><i class="fas fa-download"></i> <strong id="statDownloads">0</strong> downloads</div>
      <div class="stat-item"><i class="fas fa-clock"></i> uptime <strong id="statUptime">0s</strong></div>
    </div>

    <!-- Main Content -->
    <main class="main">
      <div class="content-area" id="contentArea">
        <!-- Files render here -->
      </div>
    </main>
  </div>

  <!-- PDF Viewer Modal -->
  <div class="viewer-overlay" id="viewerOverlay">
    <div class="viewer-header">
      <button class="btn btn-icon" id="viewerClose" title="Close (Esc)"><i class="fas fa-times"></i></button>
      <span class="viewer-title" id="viewerTitle">Document</span>
      <div class="viewer-controls">
        <button class="btn btn-icon" id="viewerSidebar" title="Toggle Thumbnails"><i class="fas fa-columns"></i></button>
        <div class="viewer-page-nav">
          <button class="btn btn-icon" id="viewerPrev" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
          <input type="number" id="viewerPageInput" min="1" value="1">
          <span class="viewer-page-divider">/ <span id="viewerTotalPages">0</span></span>
          <button class="btn btn-icon" id="viewerNext" title="Next Page"><i class="fas fa-chevron-right"></i></button>
        </div>
        <button class="btn btn-icon" id="viewerZoomOut" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
        <span class="viewer-zoom-label" id="viewerZoomLabel">100%</span>
        <button class="btn btn-icon" id="viewerZoomIn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
        <button class="btn btn-icon" id="viewerFitWidth" title="Fit Width"><i class="fas fa-arrows-alt-h"></i></button>
        <button class="btn btn-icon" id="viewerRotate" title="Rotate"><i class="fas fa-redo"></i></button>
        <button class="btn btn-icon" id="viewerPiP" title="Mini Player"><i class="fas fa-compress"></i></button>
        <button class="btn btn-icon" id="viewerOCR" title="OCR Text"><i class="fas fa-spell-check"></i></button>
        <button class="btn btn-icon" id="viewerPrint" title="Print Options"><i class="fas fa-print"></i></button>
        <button class="btn btn-icon btn-success" id="viewerDownload" title="Download"><i class="fas fa-download"></i></button>
      </div>
    </div>

    <div class="viewer-body">
      <div class="viewer-sidebar" id="viewerSidebarPanel">
        <!-- Thumbnails -->
      </div>
      <div class="viewer-canvas-container" id="viewerCanvasContainer">
        <canvas id="viewerCanvas" style="display:none"></canvas>
        <div class="pdf-pages-container" id="pdfPagesContainer">
          <!-- All page canvases rendered here -->
        </div>
        <div class="viewer-loading" id="viewerLoading" style="display:none">
          <div class="spinner"></div>
          <div style="font-size:14px;color:rgba(255,255,255,0.6)">Loading document...</div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" id="viewerProgressBar"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pdf-scroll-progress" id="pdfScrollProgress">
      <div class="pdf-scroll-progress-fill" id="pdfScrollProgressFill"></div>
    </div>
    <div class="pdf-page-jump" id="pdfPageJump">Page 1</div>
  </div>

  <!-- Mini Player -->
  <div class="mini-player" id="miniPlayer">
    <div class="mini-player-header" id="miniPlayerHeader">
      <span id="miniPlayerTitle">Mini Player</span>
      <div style="display:flex;gap:4px">
        <button class="btn btn-icon" style="width:24px;height:24px;font-size:10px" id="miniExpand" title="Expand"><i class="fas fa-expand"></i></button>
        <button class="btn btn-icon" style="width:24px;height:24px;font-size:10px" id="miniClose" title="Close"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <div class="mini-player-body"><canvas id="miniCanvas"></canvas></div>
    <div class="mini-player-footer">
      <button class="btn btn-icon" style="width:28px;height:28px;font-size:11px" id="miniPrev"><i class="fas fa-chevron-left"></i></button>
      <span style="font-size:12px" id="miniPageInfo">1/1</span>
      <button class="btn btn-icon" style="width:28px;height:28px;font-size:11px" id="miniNext"><i class="fas fa-chevron-right"></i></button>
      <button class="btn btn-icon btn-success" style="width:28px;height:28px;font-size:11px" id="miniDownload"><i class="fas fa-download"></i></button>
    </div>
  </div>

  <!-- Image Viewer -->
  <div class="image-viewer-overlay" id="imageViewer">
    <div class="image-viewer-header">
      <button class="btn btn-icon" id="imgViewerClose" title="Close (Esc)"><i class="fas fa-times"></i></button>
      <span class="viewer-title" id="imgViewerTitle">Image</span>
      <div class="viewer-controls">
        <button class="btn btn-icon" id="imgZoomIn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
        <button class="btn btn-icon" id="imgZoomOut" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
        <button class="btn btn-icon" id="imgRotate" title="Rotate"><i class="fas fa-redo"></i></button>
        <button class="btn btn-icon" id="imgFitScreen" title="Fit Screen"><i class="fas fa-expand"></i></button>
        <button class="btn btn-icon" id="imgOpenTab" title="Open in New Tab"><i class="fas fa-external-link-alt"></i></button>
        <button class="btn btn-icon btn-success" id="imgDownload" title="Download"><i class="fas fa-download"></i></button>
      </div>
    </div>
    <div class="image-viewer-body" id="imgViewerBody">
      <button class="image-nav-btn prev" id="imgPrev"><i class="fas fa-chevron-left"></i></button>
      <img id="imgViewerImg" src="" alt="Preview">
      <button class="image-nav-btn next" id="imgNext"><i class="fas fa-chevron-right"></i></button>
      <div class="image-viewer-info" id="imgViewerInfo">
        <span id="imgInfoName">image.png</span>
        <span id="imgInfoSize">0 KB</span>
        <span id="imgInfoDims">0 x 0</span>
        <span id="imgInfoIndex">1 / 1</span>
      </div>
    </div>
  </div>

  <!-- DOCX Viewer -->
  <div class="docx-viewer-overlay" id="docxViewer">
    <div class="docx-viewer-header">
      <button class="btn btn-icon" id="docxViewerClose" title="Close (Esc)"><i class="fas fa-times"></i></button>
      <span class="viewer-title" id="docxViewerTitle">Document</span>
      <div class="viewer-controls">
        <button class="btn btn-icon" id="docxEditToggle" title="Enable Editing"><i class="fas fa-pen"></i></button>
        <button class="btn btn-icon" id="docxPrint" title="Print Options"><i class="fas fa-print"></i></button>
        <button class="btn btn-icon" id="docxSavePdf" title="Save as PDF"><i class="fas fa-file-pdf"></i></button>
        <button class="btn btn-icon" id="docxExportHtml" title="Download Edited HTML"><i class="fas fa-file-code"></i></button>
        <button class="btn btn-icon" id="docxOpenTab" title="Open in New Tab"><i class="fas fa-external-link-alt"></i></button>
        <button class="btn btn-icon btn-success" id="docxDownload" title="Download"><i class="fas fa-download"></i></button>
      </div>
    </div>
    <div class="docx-toolbar" id="docxToolbar" style="display:none">
      <div class="docx-toolbar-group">
        <select class="docx-tool-select" id="docxBlockFormat">
          <option value="P">Paragraph</option>
          <option value="H1">Heading 1</option>
          <option value="H2">Heading 2</option>
          <option value="H3">Heading 3</option>
          <option value="BLOCKQUOTE">Quote</option>
        </select>
      </div>
      <div class="docx-toolbar-group">
        <button class="docx-tool-btn" data-cmd="bold" title="Bold"><i class="fas fa-bold"></i></button>
        <button class="docx-tool-btn" data-cmd="italic" title="Italic"><i class="fas fa-italic"></i></button>
        <button class="docx-tool-btn" data-cmd="underline" title="Underline"><i class="fas fa-underline"></i></button>
        <button class="docx-tool-btn" data-cmd="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
      </div>
      <div class="docx-toolbar-group">
        <button class="docx-tool-btn" data-cmd="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
        <button class="docx-tool-btn" data-cmd="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
      </div>
      <div class="docx-toolbar-group">
        <button class="docx-tool-btn" data-cmd="justifyLeft" title="Align Left"><i class="fas fa-align-left"></i></button>
        <button class="docx-tool-btn" data-cmd="justifyCenter" title="Align Center"><i class="fas fa-align-center"></i></button>
        <button class="docx-tool-btn" data-cmd="justifyRight" title="Align Right"><i class="fas fa-align-right"></i></button>
      </div>
      <div class="docx-toolbar-group">
        <input class="docx-tool-input" type="color" id="docxForeColor" title="Text Color" value="#111111">
        <input class="docx-tool-input" type="color" id="docxBackColor" title="Highlight Color" value="#fff59d">
      </div>
      <div class="docx-toolbar-group">
        <button class="docx-tool-btn" id="docxLinkBtn" title="Insert Link"><i class="fas fa-link"></i></button>
        <button class="docx-tool-btn" data-cmd="unlink" title="Remove Link"><i class="fas fa-unlink"></i></button>
      </div>
      <div class="docx-toolbar-group">
        <button class="docx-tool-btn" data-cmd="undo" title="Undo"><i class="fas fa-undo"></i></button>
        <button class="docx-tool-btn" data-cmd="redo" title="Redo"><i class="fas fa-redo"></i></button>
      </div>
    </div>
    <div class="docx-viewer-body">
      <div class="docx-content" id="docxContent">
        <div style="text-align:center;padding:60px;color:#999">
          <div class="spinner" style="margin:0 auto 16px;border:3px solid #eee;border-top-color:#7c3aed"></div>
          Loading document...
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal (continued) -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal">
      <div class="modal-header">
        <h2><i class="fas fa-cloud-upload-alt" style="color:var(--accent-secondary);margin-right:8px"></i> Upload Files</h2>
        <button class="modal-close" id="uploadModalClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.png,.jpg,.jpeg,.gif,.webp,.svg,.bmp,.tiff,.tif,.ico,.avif,.heic,.heif">
        <div class="drop-zone-icon"><i class="fas fa-cloud-upload-alt"></i></div>
        <div class="drop-zone-text">Drop files here or click to browse</div>
        <div class="drop-zone-hint">PDF, Word, PowerPoint, Text, Images (PNG, JPG, GIF, SVG, WebP, BMP, AVIF, TIFF...) &bull; Max 500MB</div>
      </div>
      <div class="upload-list" id="uploadList"></div>
      <div class="upload-progress" id="uploadProgress" style="display:none">
        <div class="progress-bar-container"><div class="progress-bar-fill" id="uploadProgressBar"></div></div>
      </div>
      <div style="margin-top:16px;text-align:right;display:none" id="uploadActions">
        <button class="btn btn-primary" id="btnStartUpload"><i class="fas fa-upload"></i> Upload All</button>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div class="modal-overlay" id="renameModal">
    <div class="modal">
      <div class="modal-header">
        <h2><i class="fas fa-pen" style="color:var(--accent-secondary);margin-right:8px"></i> Rename File</h2>
        <button class="modal-close" id="renameModalClose"><i class="fas fa-times"></i></button>
      </div>
      <input class="rename-input" id="renameInput" type="text" placeholder="New filename...">
      <div style="text-align:right">
        <button class="btn" id="renameCancel" style="margin-right:8px">Cancel</button>
        <button class="btn btn-primary" id="renameSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Print Modal -->
  <div class="modal-overlay" id="printModal">
    <div class="modal" style="max-width:620px">
      <div class="modal-header">
        <h2><i class="fas fa-print" style="color:var(--accent-secondary);margin-right:8px"></i> Print Options</h2>
        <button class="modal-close" id="printModalClose"><i class="fas fa-times"></i></button>
      </div>
      <div id="printTargetLabel" style="font-size:12px;color:var(--text-muted);margin-bottom:12px"></div>
      <div class="print-grid">
        <label class="print-field">
          <span>Page Range</span>
          <select id="printPageMode">
            <option value="all">All Pages</option>
            <option value="current">Current Page</option>
            <option value="custom">Custom</option>
          </select>
        </label>
        <label class="print-field" id="printCustomPagesWrap" style="display:none">
          <span>Custom Pages</span>
          <input id="printCustomPages" type="text" placeholder="1-3,5,8">
        </label>
        <label class="print-field">
          <span>Copies</span>
          <input id="printCopies" type="number" min="1" max="20" value="1">
        </label>
        <label class="print-field">
          <span>Paper Size</span>
          <select id="printPaperSize">
            <option value="a4">A4</option>
            <option value="letter">Letter</option>
            <option value="legal">Legal</option>
            <option value="a3">A3</option>
          </select>
        </label>
        <label class="print-field">
          <span>Orientation</span>
          <select id="printOrientation">
            <option value="auto">Auto</option>
            <option value="portrait">Portrait</option>
            <option value="landscape">Landscape</option>
          </select>
        </label>
        <label class="print-field">
          <span>Margins</span>
          <select id="printMargins">
            <option value="normal">Normal</option>
            <option value="none">None</option>
            <option value="wide">Wide</option>
          </select>
        </label>
        <label class="print-field">
          <span>Color Mode</span>
          <select id="printColorMode">
            <option value="color">Color</option>
            <option value="grayscale">Grayscale</option>
          </select>
        </label>
        <label class="print-field">
          <span>Scale (%)</span>
          <input id="printScale" type="number" min="40" max="200" value="100">
        </label>
      </div>
      <label class="print-checkbox">
        <input type="checkbox" id="printHeaderToggle">
        <span>Print filename and date on top of each page</span>
      </label>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;gap:12px">
        <button class="btn" id="printSaveAsPdfBtn"><i class="fas fa-file-pdf"></i> Save as PDF</button>
        <div style="display:flex;gap:8px">
          <button class="btn" id="printCancelBtn">Cancel</button>
          <button class="btn btn-primary" id="printStartBtn"><i class="fas fa-print"></i> Print</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OCR Modal -->
  <div class="modal-overlay" id="ocrModal">
    <div class="modal" style="max-width:820px">
      <div class="modal-header">
        <h2><i class="fas fa-spell-check" style="color:var(--accent-secondary);margin-right:8px"></i> PDF OCR</h2>
        <button class="modal-close" id="ocrModalClose"><i class="fas fa-times"></i></button>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
        <div id="ocrMeta" style="font-size:12px;color:var(--text-muted)">No OCR run yet.</div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="ocrRunBtn"><i class="fas fa-play"></i> Run OCR</button>
          <button class="btn" id="ocrCopyBtn"><i class="fas fa-copy"></i> Copy</button>
          <button class="btn btn-primary" id="ocrDownloadBtn"><i class="fas fa-download"></i> Download TXT</button>
        </div>
      </div>
      <textarea id="ocrTextArea" style="width:100%;min-height:360px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;padding:12px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.45;resize:vertical" placeholder="OCR output will appear here..."></textarea>
    </div>
  </div>

  <!-- Shortcuts Modal -->
  <div class="modal-overlay" id="shortcutsModal">
    <div class="modal" style="max-width:480px">
      <div class="modal-header">
        <h2><i class="fas fa-keyboard" style="color:var(--accent-secondary);margin-right:8px"></i> Shortcuts</h2>
        <button class="modal-close" id="shortcutsModalClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="shortcuts-list">
        <div class="shortcut-row"><span class="shortcut-desc">Search files</span><div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">K</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Upload files</span><div class="shortcut-keys"><span class="shortcut-key">U</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Toggle theme</span><div class="shortcut-keys"><span class="shortcut-key">T</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Refresh list</span><div class="shortcut-keys"><span class="shortcut-key">R</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Grid view</span><div class="shortcut-keys"><span class="shortcut-key">G</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">List view</span><div class="shortcut-keys"><span class="shortcut-key">L</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Select all</span><div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">A</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Previous page</span><div class="shortcut-keys"><span class="shortcut-key">â†</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Next page</span><div class="shortcut-keys"><span class="shortcut-key">â†’</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Close viewer</span><div class="shortcut-keys"><span class="shortcut-key">Esc</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Zoom in/out</span><div class="shortcut-keys"><span class="shortcut-key">+</span><span class="shortcut-key">-</span></div></div>
        <div class="shortcut-row"><span class="shortcut-desc">Command palette</span><div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">P</span></div></div>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div class="modal-overlay" id="statsModal">
    <div class="modal" style="max-width:1100px">
      <div class="modal-header">
        <h2><i class="fas fa-chart-bar" style="color:var(--accent-secondary);margin-right:8px"></i> Dashboard</h2>
        <button class="modal-close" id="statsModalClose"><i class="fas fa-times"></i></button>
      </div>
      <div id="statsContent" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="command-palette-overlay" id="commandPalette">
    <div class="command-palette">
      <input type="text" id="commandInput" placeholder="Type a command or file name...">
      <div class="command-palette-results" id="commandResults"></div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu"></div>

  <!-- Global Drop Overlay -->
  <div class="global-drop-overlay" id="globalDropOverlay">
    <div class="drop-content">
      <i class="fas fa-cloud-upload-alt"></i>
      <p>Drop files to upload</p>
    </div>
  </div>

  <!-- FAB -->
  <div class="fab-container">
    <div class="fab-menu" id="fabMenu">
      <button class="fab-menu-item" id="fabUpload"><i class="fas fa-upload"></i><span class="tooltip">Upload Files</span></button>
      <button class="fab-menu-item" id="fabTheme"><i class="fas fa-palette"></i><span class="tooltip">Toggle Theme</span></button>
      <button class="fab-menu-item" id="fabTop"><i class="fas fa-arrow-up"></i><span class="tooltip">Back to Top</span></button>
      <button class="fab-menu-item" id="fabRandom"><i class="fas fa-random"></i><span class="tooltip">Random Doc</span></button>
    </div>
    <button class="fab" id="fabBtn"><i class="fas fa-plus"></i></button>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Theme Picker Modal -->
  <div class="theme-picker" id="themePicker">
    <div class="theme-picker-panel">
      <div class="theme-picker-header">
        <h3><i class="fas fa-palette"></i> Choose Theme</h3>
        <button class="btn btn-icon" id="themePickerClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="theme-grid" id="themeGrid">
        <div class="theme-card" data-theme-id="classic" onclick="app.selectTheme('classic')">
          <div class="theme-card-preview" style="background:linear-gradient(135deg,#0a0a0f,#1a1a2e);position:relative">
            <div style="position:absolute;width:60px;height:60px;border-radius:50%;background:#7c3aed;filter:blur(25px);opacity:0.4;top:8px;left:15px"></div>
            <div style="position:absolute;width:40px;height:40px;border-radius:50%;background:#3b82f6;filter:blur(20px);opacity:0.3;bottom:5px;right:20px"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">ðŸŒ™</span><span class="theme-name">Classic</span></div>
        </div>
        <div class="theme-card" data-theme-id="light" onclick="app.selectTheme('light')">
          <div class="theme-card-preview" style="background:linear-gradient(135deg,#f5f3ff,#ede9fe);position:relative">
            <div style="position:absolute;width:50px;height:50px;border-radius:50%;background:#7c3aed;filter:blur(20px);opacity:0.15;top:10px;left:20px"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">â˜€ï¸</span><span class="theme-name">Light</span></div>
        </div>
        <div class="theme-card" data-theme-id="asteroid" onclick="app.selectTheme('asteroid')">
          <div class="theme-card-preview" style="background:linear-gradient(135deg,#030014,#1a0f33);position:relative">
            <div style="position:absolute;width:4px;height:4px;border-radius:50%;background:#fff;top:12px;left:25px;box-shadow:0 0 4px #fff"></div>
            <div style="position:absolute;width:3px;height:3px;border-radius:50%;background:#ffd166;top:30px;left:60px;box-shadow:0 0 6px #ff9f1c"></div>
            <div style="position:absolute;width:35px;height:8px;border-radius:50%;background:linear-gradient(90deg,#ff6b35,#ff9f1c);filter:blur(3px);opacity:0.7;top:20px;left:80px;transform:rotate(-25deg)"></div>
            <div style="position:absolute;width:2px;height:2px;border-radius:50%;background:#fff;top:50px;left:40px"></div>
            <div style="position:absolute;width:3px;height:3px;border-radius:50%;background:#ddd;top:8px;right:30px"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">â˜„ï¸</span><span class="theme-name">Asteroid</span></div>
        </div>
        <div class="theme-card" data-theme-id="techi" onclick="app.selectTheme('techi')">
          <div class="theme-card-preview" style="background:linear-gradient(135deg,#001a1a,#003333);position:relative">
            <div style="position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 8px,rgba(0,255,213,0.03) 8px,rgba(0,255,213,0.03) 9px);"></div>
            <div style="position:absolute;width:80px;height:1px;background:linear-gradient(90deg,transparent,#00ffd5,transparent);top:25px;left:20px;opacity:0.5"></div>
            <div style="position:absolute;width:60px;height:1px;background:linear-gradient(90deg,transparent,#00ffd5,transparent);top:45px;left:40px;opacity:0.3"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">ðŸ’»</span><span class="theme-name">Techi</span></div>
        </div>
        <div class="theme-card" data-theme-id="vscode-dark" onclick="app.selectTheme('vscode-dark')">
          <div class="theme-card-preview" style="background:#1e1e1e;position:relative">
            <div style="position:absolute;top:8px;left:10px;right:10px;height:10px;background:#2d2d30;border-radius:2px"></div>
            <div style="position:absolute;top:22px;left:10px;width:30px;height:6px;background:#569cd6;border-radius:1px;opacity:0.7"></div>
            <div style="position:absolute;top:22px;left:46px;width:50px;height:6px;background:#4ec9b0;border-radius:1px;opacity:0.5"></div>
            <div style="position:absolute;top:32px;left:10px;width:70px;height:6px;background:#ce9178;border-radius:1px;opacity:0.4"></div>
            <div style="position:absolute;top:42px;left:10px;width:45px;height:6px;background:#c586c0;border-radius:1px;opacity:0.5"></div>
            <div style="position:absolute;top:52px;left:10px;width:55px;height:6px;background:#dcdcaa;border-radius:1px;opacity:0.4"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">ðŸ”·</span><span class="theme-name">VS Code Dark</span></div>
        </div>
        <div class="theme-card" data-theme-id="vscode-light" onclick="app.selectTheme('vscode-light')">
          <div class="theme-card-preview" style="background:#f3f3f3;position:relative">
            <div style="position:absolute;top:8px;left:10px;right:10px;height:10px;background:#e8e8e8;border-radius:2px"></div>
            <div style="position:absolute;top:22px;left:10px;width:30px;height:6px;background:#0066b8;border-radius:1px;opacity:0.7"></div>
            <div style="position:absolute;top:22px;left:46px;width:50px;height:6px;background:#267f99;border-radius:1px;opacity:0.5"></div>
            <div style="position:absolute;top:32px;left:10px;width:70px;height:6px;background:#a31515;border-radius:1px;opacity:0.4"></div>
            <div style="position:absolute;top:42px;left:10px;width:45px;height:6px;background:#af00db;border-radius:1px;opacity:0.5"></div>
            <div style="position:absolute;top:52px;left:10px;width:55px;height:6px;background:#795e26;border-radius:1px;opacity:0.4"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">ðŸ”¶</span><span class="theme-name">VS Code Light</span></div>
        </div>
        <div class="theme-card" data-theme-id="google" onclick="app.selectTheme('google')">
          <div class="theme-card-preview" style="background:#fff;position:relative">
            <div style="position:absolute;top:22px;left:50%;transform:translateX(-50%);display:flex;gap:4px">
              <div style="width:14px;height:14px;border-radius:50%;background:#4285f4"></div>
              <div style="width:14px;height:14px;border-radius:50%;background:#ea4335"></div>
              <div style="width:14px;height:14px;border-radius:50%;background:#fbbc04"></div>
              <div style="width:14px;height:14px;border-radius:50%;background:#34a853"></div>
            </div>
            <div style="position:absolute;bottom:10px;left:20px;right:20px;height:8px;background:#f1f3f4;border-radius:20px"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">ðŸ”</span><span class="theme-name">Google</span></div>
        </div>
        <div class="theme-card" data-theme-id="liquid-glass" onclick="app.selectTheme('liquid-glass')">
          <div class="theme-card-preview" style="background:linear-gradient(180deg,#d4e4ff 0%,#e8f0ff 40%,#f0f6ff 100%);position:relative;overflow:hidden">
            <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(100,160,255,0.25),transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(0,200,255,0.15),transparent 50%);"></div>
            <div style="position:absolute;width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,0.35);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.5);top:5px;left:15px;box-shadow:inset 0 0 20px rgba(255,255,255,0.3),0 4px 20px rgba(100,160,255,0.15)"></div>
            <div style="position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.25);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.4);bottom:5px;right:15px;box-shadow:inset 0 0 12px rgba(255,255,255,0.2)"></div>
            <div style="position:absolute;bottom:0;left:0;right:0;height:20px;background:linear-gradient(0deg,rgba(100,180,255,0.12),transparent);"></div>
          </div>
          <div class="theme-card-info"><span class="theme-icon">ðŸ’§</span><span class="theme-name">Liquid Glass (Default)</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- pdf.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- mammoth.js for DOCX rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <script>
  (() => {
    'use strict';

    // ===== STATE =====
    const state = {
      files: [],
      filteredFiles: [],
      selectedFiles: new Set(),
      viewMode: localStorage.getItem('viewMode') || 'grid',
      theme: localStorage.getItem('theme') || 'liquid-glass',
      sortBy: localStorage.getItem('sortBy') || 'name-asc',
      filterType: 'all',
      favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
      currentPdf: null,
      currentPage: 1,
      totalPages: 0,
      pdfDoc: null,
      zoom: 1.0,
      rotation: 0,
      miniPlayerActive: false,
      miniPdf: null,
      miniPage: 1,
      logoClicks: 0,
      konamiIndex: 0,
      searchDebounce: null,
      // Image viewer state
      imgViewerFile: null,
      imgZoom: 1,
      imgRotation: 0,
      imgGalleryFiles: [],
      imgGalleryIndex: 0,
      docxViewerFile: null,
      docxEditing: false,
      docxOriginalHtml: '',
      docxDirty: false,
      ocrText: '',
      printTarget: null,
      pageViewports: [],
      renderTasks: new Map(),
      pageObserver: null,
      role: null,
      classroomShared: [],   // admin: list of filenames shared to classroom
      classroomFiles: [],    // student: files from admin's classroom
      showClassroom: false,  // student: toggle classroom view
      adminAccounts: [],
    };

    const konamiCode = [38,38,40,40,37,39,37,39,66,65]; // â†‘â†‘â†“â†“â†â†’â†â†’BA

    // ===== AUTH HELPERS =====
    function getAuthToken() { return localStorage.getItem('authToken'); }
    function setAuthToken(token) { localStorage.setItem('authToken', token); }
    function clearAuthToken() { localStorage.removeItem('authToken'); localStorage.removeItem('authUser'); }
    function getAuthUser() { return localStorage.getItem('authUser') || 'user'; }

    function authHeaders(extra = {}) {
      const token = getAuthToken();
      const h = { ...extra };
      if (token) h['Authorization'] = 'Bearer ' + token;
      return h;
    }

    async function authFetch(url, opts = {}) {
      opts.headers = authHeaders(opts.headers || {});
      const res = await fetch(url, opts);
      if (res.status === 401) { handleAuthFail(); throw new Error('AUTH_REQUIRED'); }
      return res;
    }

    function getDocUrl(filename) {
      const token = getAuthToken();
      const base = `/documents/${encodeURIComponent(filename)}`;
      return token ? base + '?token=' + encodeURIComponent(token) : base;
    }

    function getDownloadUrl(filename) {
      const token = getAuthToken();
      const base = `/api/download/${encodeURIComponent(filename)}`;
      return token ? base + '?token=' + encodeURIComponent(token) : base;
    }

    function handleAuthFail() {
      clearAuthToken();
      window.location.href = '/';
    }

    function showLoginScreen() {
      window.location.href = '/';
    }

    function hideLoginScreen() {
      // login is now on the hub page â€” no overlay to hide
    }

    async function verifyAuth() {
      const token = getAuthToken();
      if (!token) { showLoginScreen(); return false; }
      try {
        const res = await fetch('/api/auth/verify', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) { showLoginScreen(); return false; }
        const data = await res.json();
        if (!data.valid) { showLoginScreen(); return false; }
        localStorage.setItem('authUser', data.username);
        state.role = data.role;
        hideLoginScreen();
        return true;
      } catch { showLoginScreen(); return false; }
    }

    // ===== DOM REFS =====
    const $ = id => document.getElementById(id);
    const el = {
      searchInput: $('searchInput'),
      contentArea: $('contentArea'),
      sortSelect: $('sortSelect'),
      filterType: $('filterType'),
      fileCount: $('fileCount'),
      selectionBar: $('selectionBar'),
      selectionCount: $('selectionCount'),
      viewerOverlay: $('viewerOverlay'),
      viewerTitle: $('viewerTitle'),
      viewerCanvas: $('viewerCanvas'),
      viewerCanvasContainer: $('viewerCanvasContainer'),
      viewerLoading: $('viewerLoading'),
      viewerProgressBar: $('viewerProgressBar'),
      viewerPageInput: $('viewerPageInput'),
      viewerTotalPages: $('viewerTotalPages'),
      viewerZoomLabel: $('viewerZoomLabel'),
      viewerSidebarPanel: $('viewerSidebarPanel'),
      uploadModal: $('uploadModal'),
      uploadList: $('uploadList'),
      uploadActions: $('uploadActions'),
      uploadProgress: $('uploadProgress'),
      uploadProgressBar: $('uploadProgressBar'),
      fileInput: $('fileInput'),
      dropZone: $('dropZone'),
      renameModal: $('renameModal'),
      renameInput: $('renameInput'),
      printModal: $('printModal'),
      printTargetLabel: $('printTargetLabel'),
      printPageMode: $('printPageMode'),
      printCustomPagesWrap: $('printCustomPagesWrap'),
      printCustomPages: $('printCustomPages'),
      printCopies: $('printCopies'),
      printPaperSize: $('printPaperSize'),
      printOrientation: $('printOrientation'),
      printMargins: $('printMargins'),
      printColorMode: $('printColorMode'),
      printScale: $('printScale'),
      printHeaderToggle: $('printHeaderToggle'),
      ocrModal: $('ocrModal'),
      ocrMeta: $('ocrMeta'),
      ocrTextArea: $('ocrTextArea'),
      shortcutsModal: $('shortcutsModal'),
      statsModal: $('statsModal'),
      statsContent: $('statsContent'),
      commandPalette: $('commandPalette'),
      commandInput: $('commandInput'),
      commandResults: $('commandResults'),
      contextMenu: $('contextMenu'),
      globalDropOverlay: $('globalDropOverlay'),
      miniPlayer: $('miniPlayer'),
      miniCanvas: $('miniCanvas'),
      miniPlayerTitle: $('miniPlayerTitle'),
      miniPageInfo: $('miniPageInfo'),
      fabMenu: $('fabMenu'),
      toastContainer: $('toastContainer'),
      readingProgress: $('readingProgress'),
      matrixCanvas: $('matrixCanvas'),
      // Image viewer
      imageViewer: $('imageViewer'),
      imgViewerImg: $('imgViewerImg'),
      imgViewerTitle: $('imgViewerTitle'),
      imgViewerBody: $('imgViewerBody'),
      imgInfoName: $('imgInfoName'),
      imgInfoSize: $('imgInfoSize'),
      imgInfoDims: $('imgInfoDims'),
      imgInfoIndex: $('imgInfoIndex'),
      // DOCX viewer
      docxViewer: $('docxViewer'),
      docxViewerTitle: $('docxViewerTitle'),
      docxToolbar: $('docxToolbar'),
      docxContent: $('docxContent'),
      // PDF pages container
      pdfPagesContainer: $('pdfPagesContainer'),
      pdfScrollProgress: $('pdfScrollProgress'),
      pdfScrollProgressFill: $('pdfScrollProgressFill'),
      pdfPageJump: $('pdfPageJump'),
    };

    // ===== HELPERS =====
    function formatSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatDate(d) {
      const date = new Date(d);
      const now = new Date();
      const diff = now - date;
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
      if (diff < 604800000) return Math.floor(diff/86400000) + 'd ago';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatUptime(ms) {
      const s = Math.floor(ms / 1000);
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s/60) + 'm';
      if (s < 86400) return Math.floor(s/3600) + 'h ' + (Math.floor(s/60)%60) + 'm';
      return Math.floor(s/86400) + 'd';
    }

    function getFileIcon(type) {
      const icons = {
        pdf: 'fas fa-file-pdf',
        doc: 'fas fa-file-word',
        docx: 'fas fa-file-word',
        ppt: 'fas fa-file-powerpoint',
        pptx: 'fas fa-file-powerpoint',
        txt: 'fas fa-file-alt',
        png: 'fas fa-file-image',
        jpg: 'fas fa-file-image',
        jpeg: 'fas fa-file-image',
        gif: 'fas fa-file-image',
        webp: 'fas fa-file-image',
        svg: 'fas fa-file-image',
        bmp: 'fas fa-file-image',
        tiff: 'fas fa-file-image',
        tif: 'fas fa-file-image',
        ico: 'fas fa-file-image',
        avif: 'fas fa-file-image',
        heic: 'fas fa-file-image',
        heif: 'fas fa-file-image',
      };
      return icons[type] || 'fas fa-file';
    }

    function getFileColor(type) {
      const colors = { pdf: '#ef4444', doc: '#3b82f6', docx: '#3b82f6', ppt: '#f59e0b', pptx: '#f59e0b', txt: '#10b981',
        png: '#a855f7', jpg: '#a855f7', jpeg: '#a855f7', gif: '#ec4899', webp: '#06b6d4',
        svg: '#14b8a6', bmp: '#8b5cf6', tiff: '#8b5cf6', tif: '#8b5cf6', ico: '#6366f1',
        avif: '#06b6d4', heic: '#f97316', heif: '#f97316' };
      return colors[type] || '#a855f7';
    }

    function isImageType(type) {
      return ['png','jpg','jpeg','gif','webp','svg','bmp','tiff','tif','ico','avif','heic','heif'].includes(type);
    }

    function isDocType(type) {
      return ['doc','docx'].includes(type);
    }

    function getFileCategory(type) {
      if (type === 'pdf') return 'PDF Documents';
      if (isImageType(type)) return 'Images';
      if (isDocType(type)) return 'Word Documents';
      if (['ppt','pptx'].includes(type)) return 'Presentations';
      if (type === 'txt') return 'Text Files';
      return 'Other';
    }

    function getCategoryIcon(cat) {
      const icons = {
        'PDF Documents': 'fas fa-file-pdf',
        'Images': 'fas fa-images',
        'Word Documents': 'fas fa-file-word',
        'Presentations': 'fas fa-file-powerpoint',
        'Text Files': 'fas fa-file-alt',
        'Other': 'fas fa-file',
      };
      return icons[cat] || 'fas fa-file';
    }

    function getCategoryColor(cat) {
      const colors = {
        'PDF Documents': '#ef4444',
        'Images': '#a855f7',
        'Word Documents': '#3b82f6',
        'Presentations': '#f59e0b',
        'Text Files': '#10b981',
        'Other': '#6b7280',
      };
      return colors[cat] || '#6b7280';
    }

    function getTypeClass(type) {
      if (isImageType(type)) return 'file-type-img';
      if (isDocType(type)) return 'file-type-doc';
      return `file-type-${type}`;
    }

    // ===== TOAST =====
    function toast(message, type = 'info') {
      const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle', warning: 'fa-exclamation-triangle' };
      const t = document.createElement('div');
      t.className = `toast toast-${type}`;
      t.innerHTML = `<i class="fas ${icons[type]} toast-icon"></i><span>${message}</span>`;
      el.toastContainer.appendChild(t);
      setTimeout(() => { t.classList.add('exit'); setTimeout(() => t.remove(), 300); }, 4000);
    }

    // ===== THEME =====
    function setTheme(theme) {
      state.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const btn = $('btnTheme');
      const icons = {
        classic: 'fa-moon', light: 'fa-sun', asteroid: 'fa-meteor',
        techi: 'fa-microchip', 'vscode-dark': 'fa-code', 'vscode-light': 'fa-code',
        google: 'fa-google', 'liquid-glass': 'fa-droplet'
      };
      btn.innerHTML = `<i class="fas ${icons[theme] || 'fa-palette'}"></i>`;

      // Update bg orbs visibility
      const bgEffects = document.querySelector('.bg-effects');
      const orbThemes = ['classic', 'light', 'asteroid'];
      bgEffects.style.display = orbThemes.includes(theme) ? '' : 'none';

      // Update orb colors per theme
      const orbs = document.querySelectorAll('.bg-orb');
      if (theme === 'asteroid') {
        orbs[0].style.background = '#ff6b35';
        orbs[1].style.background = '#7b2ff7';
        orbs[2].style.background = '#ff9f1c';
      } else {
        orbs[0].style.background = '#7c3aed';
        orbs[1].style.background = '#3b82f6';
        orbs[2].style.background = '#a855f7';
      }

      // Mark active theme card
      document.querySelectorAll('.theme-card').forEach(c => {
        c.classList.toggle('active', c.dataset.themeId === theme);
      });

      // Start / switch animated background
      startAnimatedBackground(theme);
    }

    function toggleTheme() {
      // Open theme picker instead of simple toggle
      $('themePicker').classList.add('active');
    }

    function selectTheme(theme) {
      setTheme(theme);
      $('themePicker').classList.remove('active');
      toast(`Theme: ${theme.charAt(0).toUpperCase() + theme.slice(1)}`, 'info');
    }

    // ===== ANIMATED BACKGROUND ENGINE =====
    let bgAnimId = null;
    function startAnimatedBackground(theme) {
      const canvas = $('bgCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Cancel any running animation
      if (bgAnimId) { cancelAnimationFrame(bgAnimId); bgAnimId = null; }

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

      // ===== ASTEROID THEME: Starfield + shooting asteroids =====
      if (theme === 'asteroid') {
        const stars = [];
        for (let i = 0; i < 200; i++) {
          stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 2 + 0.5,
            speed: Math.random() * 0.3 + 0.05,
            brightness: Math.random() * 0.7 + 0.3,
            twinkleSpeed: Math.random() * 0.02 + 0.005,
            twinklePhase: Math.random() * Math.PI * 2,
          });
        }
        const asteroids = [];
        function spawnAsteroid() {
          if (asteroids.length < 3 && Math.random() < 0.003) {
            asteroids.push({
              x: canvas.width + 20,
              y: Math.random() * canvas.height * 0.6,
              vx: -(Math.random() * 4 + 2),
              vy: Math.random() * 1.5 + 0.5,
              size: Math.random() * 4 + 2,
              tail: [],
            });
          }
        }
        function animAsteroid() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Stars
          const t = Date.now();
          for (const s of stars) {
            s.twinklePhase += s.twinkleSpeed;
            const alpha = s.brightness * (0.5 + 0.5 * Math.sin(s.twinklePhase));
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255,255,255,${alpha})`;
            ctx.fill();
          }

          // Asteroids
          spawnAsteroid();
          for (let i = asteroids.length - 1; i >= 0; i--) {
            const a = asteroids[i];
            a.x += a.vx;
            a.y += a.vy;
            a.tail.push({ x: a.x, y: a.y });
            if (a.tail.length > 30) a.tail.shift();

            // Tail
            for (let j = 0; j < a.tail.length; j++) {
              const tp = a.tail[j];
              const alpha = (j / a.tail.length) * 0.5;
              const sz = a.size * (j / a.tail.length) * 0.7;
              ctx.beginPath();
              ctx.arc(tp.x, tp.y, sz, 0, Math.PI * 2);
              ctx.fillStyle = `rgba(255,159,28,${alpha})`;
              ctx.fill();
            }

            // Head
            ctx.beginPath();
            ctx.arc(a.x, a.y, a.size, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(a.x, a.y, 0, a.x, a.y, a.size);
            grad.addColorStop(0, '#ffd166');
            grad.addColorStop(0.5, '#ff9f1c');
            grad.addColorStop(1, '#ff6b35');
            ctx.fillStyle = grad;
            ctx.fill();

            // Glow
            ctx.beginPath();
            ctx.arc(a.x, a.y, a.size * 3, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,107,53,0.08)';
            ctx.fill();

            if (a.x < -50 || a.y > canvas.height + 50) asteroids.splice(i, 1);
          }
          bgAnimId = requestAnimationFrame(animAsteroid);
        }
        animAsteroid();

      // ===== TECHI THEME: Circuit board / scan lines =====
      } else if (theme === 'techi') {
        const nodes = [];
        for (let i = 0; i < 50; i++) {
          nodes.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.4,
            vy: (Math.random() - 0.5) * 0.4,
            size: Math.random() * 2 + 1,
          });
        }
        let scanY = 0;
        function animTechi() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Scan line
          scanY = (scanY + 0.5) % canvas.height;
          const scanGrad = ctx.createLinearGradient(0, scanY - 30, 0, scanY + 30);
          scanGrad.addColorStop(0, 'rgba(0,255,213,0)');
          scanGrad.addColorStop(0.5, 'rgba(0,255,213,0.04)');
          scanGrad.addColorStop(1, 'rgba(0,255,213,0)');
          ctx.fillStyle = scanGrad;
          ctx.fillRect(0, scanY - 30, canvas.width, 60);

          // Nodes + connections
          for (const n of nodes) {
            n.x += n.vx; n.y += n.vy;
            if (n.x < 0 || n.x > canvas.width) n.vx *= -1;
            if (n.y < 0 || n.y > canvas.height) n.vy *= -1;

            ctx.beginPath();
            ctx.arc(n.x, n.y, n.size, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,255,213,0.4)';
            ctx.fill();
          }

          // Connections
          for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
              const dx = nodes[i].x - nodes[j].x;
              const dy = nodes[i].y - nodes[j].y;
              const d = Math.sqrt(dx * dx + dy * dy);
              if (d < 150) {
                ctx.beginPath();
                ctx.moveTo(nodes[i].x, nodes[i].y);
                ctx.lineTo(nodes[j].x, nodes[j].y);
                ctx.strokeStyle = `rgba(0,255,213,${0.08 * (1 - d / 150)})`;
                ctx.lineWidth = 0.5;
                ctx.stroke();
              }
            }
          }

          // Data packets along connections occasionally
          if (Math.random() < 0.02) {
            const n1 = nodes[Math.floor(Math.random() * nodes.length)];
            ctx.beginPath();
            ctx.arc(n1.x, n1.y, 4, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,255,213,0.6)';
            ctx.fill();
          }

          bgAnimId = requestAnimationFrame(animTechi);
        }
        animTechi();

      // ===== VS CODE DARK: Subtle floating code brackets =====
      } else if (theme === 'vscode-dark') {
        const symbols = ['{', '}', '<', '>', '/', ';', '(', ')', '=', '#', '//', '/*', '[]'];
        const particles = [];
        for (let i = 0; i < 25; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            char: symbols[Math.floor(Math.random() * symbols.length)],
            size: Math.random() * 14 + 10,
            alpha: Math.random() * 0.06 + 0.02,
            speed: Math.random() * 0.2 + 0.05,
            drift: (Math.random() - 0.5) * 0.15,
          });
        }
        function animVSCodeDark() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = 'JetBrains Mono, monospace';
          for (const p of particles) {
            p.y -= p.speed;
            p.x += p.drift;
            if (p.y < -30) { p.y = canvas.height + 30; p.x = Math.random() * canvas.width; }
            ctx.font = `${p.size}px 'JetBrains Mono', monospace`;
            ctx.fillStyle = `rgba(86,156,214,${p.alpha})`;
            ctx.fillText(p.char, p.x, p.y);
          }
          bgAnimId = requestAnimationFrame(animVSCodeDark);
        }
        animVSCodeDark();

      // ===== VS CODE LIGHT: Very subtle floating brackets =====
      } else if (theme === 'vscode-light') {
        const symbols = ['{', '}', '<', '>', ';', '(', ')', '='];
        const particles = [];
        for (let i = 0; i < 15; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            char: symbols[Math.floor(Math.random() * symbols.length)],
            size: Math.random() * 14 + 10,
            alpha: Math.random() * 0.04 + 0.01,
            speed: Math.random() * 0.15 + 0.03,
            drift: (Math.random() - 0.5) * 0.1,
          });
        }
        function animVSCodeLight() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          for (const p of particles) {
            p.y -= p.speed;
            p.x += p.drift;
            if (p.y < -30) { p.y = canvas.height + 30; p.x = Math.random() * canvas.width; }
            ctx.font = `${p.size}px 'JetBrains Mono', monospace`;
            ctx.fillStyle = `rgba(0,102,184,${p.alpha})`;
            ctx.fillText(p.char, p.x, p.y);
          }
          bgAnimId = requestAnimationFrame(animVSCodeLight);
        }
        animVSCodeLight();

      // ===== GOOGLE: Material You luminous blobs + subtle grid =====
      } else if (theme === 'google') {
        const colors = [
          { r: 66, g: 133, b: 244 },   // Google Blue
          { r: 234, g: 67, b: 53 },     // Google Red
          { r: 251, g: 188, b: 4 },     // Google Yellow
          { r: 52, g: 168, b: 83 },      // Google Green
        ];
        const blobs = [];
        for (let i = 0; i < 5; i++) {
          blobs.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.4,
            vy: (Math.random() - 0.5) * 0.4,
            color: colors[i % colors.length],
            size: Math.random() * 200 + 120,
            alpha: Math.random() * 0.05 + 0.015,
            phase: Math.random() * Math.PI * 2,
          });
        }
        // Tiny sparkle dots
        const sparkles = [];
        for (let i = 0; i < 20; i++) {
          sparkles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.15,
            vy: (Math.random() - 0.5) * 0.15,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 3 + 1,
            alpha: Math.random() * 0.12 + 0.03,
            phase: Math.random() * Math.PI * 2,
          });
        }
        let gTime = 0;
        function animGoogle() {
          gTime += 0.003;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          // Luminous blobs
          for (const b of blobs) {
            b.x += b.vx; b.y += b.vy;
            if (b.x < -b.size || b.x > canvas.width + b.size) b.vx *= -1;
            if (b.y < -b.size || b.y > canvas.height + b.size) b.vy *= -1;
            const pulse = Math.sin(gTime * 2 + b.phase) * 0.3 + 1;
            const grad = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.size * pulse);
            grad.addColorStop(0, `rgba(${b.color.r},${b.color.g},${b.color.b},${b.alpha * 1.5})`);
            grad.addColorStop(0.5, `rgba(${b.color.r},${b.color.g},${b.color.b},${b.alpha * 0.5})`);
            grad.addColorStop(1, `rgba(${b.color.r},${b.color.g},${b.color.b},0)`);
            ctx.fillStyle = grad;
            ctx.fillRect(b.x - b.size * pulse, b.y - b.size * pulse, b.size * 2 * pulse, b.size * 2 * pulse);
          }
          // Sparkle dots
          for (const s of sparkles) {
            s.x += s.vx; s.y += s.vy;
            if (s.x < 0 || s.x > canvas.width) s.vx *= -1;
            if (s.y < 0 || s.y > canvas.height) s.vy *= -1;
            const twinkle = Math.sin(gTime * 4 + s.phase) * 0.5 + 0.5;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${s.color.r},${s.color.g},${s.color.b},${s.alpha * twinkle})`;
            ctx.fill();
          }
          bgAnimId = requestAnimationFrame(animGoogle);
        }
        animGoogle();

      // ===== LIQUID GLASS: Water caustics + ripples + floating glass bubbles =====
      } else if (theme === 'liquid-glass') {
        // Water caustic light rays
        const causticRays = [];
        for (let i = 0; i < 12; i++) {
          causticRays.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 300 + 150,
            speed: (Math.random() - 0.5) * 0.3,
            phase: Math.random() * Math.PI * 2,
            drift: (Math.random() - 0.5) * 0.15,
          });
        }

        // Ripple rings
        const ripples = [];
        function spawnRipple() {
          ripples.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height * 0.8 + canvas.height * 0.1,
            radius: 0,
            maxRadius: Math.random() * 120 + 60,
            alpha: 0.12 + Math.random() * 0.08,
            speed: 0.4 + Math.random() * 0.3,
          });
        }
        for (let i = 0; i < 4; i++) {
          const r = { x: Math.random() * canvas.width, y: Math.random() * canvas.height,
            radius: Math.random() * 80, maxRadius: Math.random() * 120 + 60,
            alpha: 0.1, speed: 0.4 + Math.random() * 0.3 };
          ripples.push(r);
        }

        // Glass bubbles floating up gently
        const bubbles = [];
        for (let i = 0; i < 18; i++) {
          bubbles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 6 + 2,
            vy: -(Math.random() * 0.25 + 0.05),
            vx: (Math.random() - 0.5) * 0.1,
            wobblePhase: Math.random() * Math.PI * 2,
            wobbleSpeed: 0.01 + Math.random() * 0.015,
            alpha: Math.random() * 0.25 + 0.1,
          });
        }

        let waterTime = 0;
        let rippleTimer = 0;

        function animLiquidGlass() {
          waterTime += 0.004;
          rippleTimer++;

          // Spawn new ripple every ~180 frames
          if (rippleTimer % 180 === 0) spawnRipple();

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Deep water gradient base
          const waterGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
          waterGrad.addColorStop(0, 'rgba(186,230,253,0.04)');
          waterGrad.addColorStop(0.5, 'rgba(56,189,248,0.03)');
          waterGrad.addColorStop(1, 'rgba(14,165,233,0.05)');
          ctx.fillStyle = waterGrad;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Water caustic light rays (dappled light through water)
          for (const ray of causticRays) {
            const cx = ray.x + Math.sin(waterTime * 1.5 + ray.phase) * 80;
            const cy = ray.y + Math.cos(waterTime * 1.2 + ray.phase) * 40;
            ray.x += ray.drift;
            if (ray.x < -ray.size) ray.x = canvas.width + ray.size;
            if (ray.x > canvas.width + ray.size) ray.x = -ray.size;

            const breathe = 0.7 + Math.sin(waterTime * 2 + ray.phase) * 0.3;
            const sz = ray.size * breathe;

            const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, sz);
            const hue = 195 + Math.sin(waterTime + ray.phase) * 15;
            grad.addColorStop(0, `hsla(${hue}, 80%, 70%, ${0.04 * breathe})`);
            grad.addColorStop(0.4, `hsla(${hue}, 70%, 65%, ${0.02 * breathe})`);
            grad.addColorStop(1, 'transparent');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(cx, cy, sz, 0, Math.PI * 2);
            ctx.fill();
          }

          // Ripple rings expanding outward
          for (let i = ripples.length - 1; i >= 0; i--) {
            const rp = ripples[i];
            rp.radius += rp.speed;
            const progress = rp.radius / rp.maxRadius;
            const alpha = rp.alpha * (1 - progress);

            if (progress >= 1) {
              ripples.splice(i, 1);
              continue;
            }

            ctx.beginPath();
            ctx.arc(rp.x, rp.y, rp.radius, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(56, 189, 248, ${alpha})`;
            ctx.lineWidth = 1.5 * (1 - progress);
            ctx.stroke();

            // Inner ring (double ripple)
            if (rp.radius > 15) {
              ctx.beginPath();
              ctx.arc(rp.x, rp.y, rp.radius * 0.6, 0, Math.PI * 2);
              ctx.strokeStyle = `rgba(186, 230, 253, ${alpha * 0.5})`;
              ctx.lineWidth = 1 * (1 - progress);
              ctx.stroke();
            }
          }

          // Glass bubbles floating upward
          for (const b of bubbles) {
            b.y += b.vy;
            b.wobblePhase += b.wobbleSpeed;
            b.x += b.vx + Math.sin(b.wobblePhase) * 0.3;

            // Reset bubble when it goes above screen
            if (b.y < -b.size * 2) {
              b.y = canvas.height + b.size * 2;
              b.x = Math.random() * canvas.width;
            }

            // Glass bubble with highlight
            const bGrad = ctx.createRadialGradient(
              b.x - b.size * 0.25, b.y - b.size * 0.25, b.size * 0.1,
              b.x, b.y, b.size
            );
            bGrad.addColorStop(0, `rgba(255, 255, 255, ${b.alpha * 0.8})`);
            bGrad.addColorStop(0.5, `rgba(186, 230, 253, ${b.alpha * 0.3})`);
            bGrad.addColorStop(0.8, `rgba(56, 189, 248, ${b.alpha * 0.15})`);
            bGrad.addColorStop(1, 'transparent');

            ctx.beginPath();
            ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
            ctx.fillStyle = bGrad;
            ctx.fill();

            // Highlight dot (glass refraction)
            ctx.beginPath();
            ctx.arc(b.x - b.size * 0.3, b.y - b.size * 0.3, b.size * 0.2, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${b.alpha * 0.6})`;
            ctx.fill();
          }

          // Subtle wave line at bottom
          ctx.beginPath();
          ctx.moveTo(0, canvas.height);
          for (let x = 0; x <= canvas.width; x += 4) {
            const wave1 = Math.sin(x * 0.008 + waterTime * 3) * 12;
            const wave2 = Math.sin(x * 0.015 + waterTime * 2) * 6;
            const wave3 = Math.sin(x * 0.003 + waterTime * 1.5) * 20;
            const y = canvas.height - 40 + wave1 + wave2 + wave3;
            ctx.lineTo(x, y);
          }
          ctx.lineTo(canvas.width, canvas.height);
          ctx.closePath();
          const waveGrad = ctx.createLinearGradient(0, canvas.height - 60, 0, canvas.height);
          waveGrad.addColorStop(0, 'rgba(56, 189, 248, 0.03)');
          waveGrad.addColorStop(1, 'rgba(14, 165, 233, 0.06)');
          ctx.fillStyle = waveGrad;
          ctx.fill();

          bgAnimId = requestAnimationFrame(animLiquidGlass);
        }
        animLiquidGlass();

      // ===== DEFAULT DARK/LIGHT: Just clear canvas, orbs handle it =====
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    // ===== CLASSROOM HELPERS =====
    async function fetchClassroomData() {
      if (!getAuthToken()) return;
      try {
        if (state.role === 'admin') {
          // Admin: get their shared list
          const res = await authFetch('/api/admin/classroom');
          const data = await res.json();
          state.classroomShared = data.map(s => s.filename);
        }
        // Everyone: fetch classroom files (students see admin's, admin sees own)
        const res2 = await authFetch('/api/classroom/files');
        state.classroomFiles = await res2.json();
      } catch {}
      // Show classroom button for students or admins with shares
      const btn = $('btnClassroom');
      if (btn) {
        btn.style.display = (state.role === 'student' || state.classroomShared.length > 0) ? '' : 'none';
        if (state.showClassroom) btn.classList.add('active');
        else btn.classList.remove('active');
      }
    }

    function toggleClassroom() {
      state.showClassroom = !state.showClassroom;
      const btn = $('btnClassroom');
      if (btn) {
        if (state.showClassroom) btn.classList.add('active');
        else btn.classList.remove('active');
      }
      applyFilters();
      renderFiles();
      updateFileCount();
    }

    async function shareToClassroom(filename) {
      try {
        const res = await authFetch('/api/admin/classroom/share/' + encodeURIComponent(filename), { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          toast('Sent to classroom!', 'success');
          state.classroomShared.push(filename);
          fetchClassroomData();
        } else {
          toast(data.error || 'Failed', 'error');
        }
      } catch { toast('Failed to share', 'error'); }
    }

    async function unshareFromClassroom(filename) {
      try {
        const res = await authFetch('/api/admin/classroom/unshare/' + encodeURIComponent(filename), { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          toast('Removed from classroom', 'info');
          state.classroomShared = state.classroomShared.filter(f => f !== filename);
          fetchClassroomData();
        }
      } catch { toast('Failed', 'error'); }
    }

    function getClassroomDocUrl(filename) {
      const token = getAuthToken();
      const base = '/api/classroom/documents/' + encodeURIComponent(filename);
      return token ? base + '?token=' + encodeURIComponent(token) : base;
    }

    function getClassroomDownloadUrl(filename) {
      const token = getAuthToken();
      const base = '/api/classroom/download/' + encodeURIComponent(filename);
      return token ? base + '?token=' + encodeURIComponent(token) : base;
    }

    // ===== FETCH FILES =====
    async function fetchFiles() {
      if (!getAuthToken()) return;
      try {
        const res = await authFetch('/api/pdfs');
        state.files = await res.json();
        applyFilters();
        renderFiles();
        updateFileCount();
      } catch (e) {
        toast('Failed to load files', 'error');
      }
      fetchClassroomData();
    }

    // ===== FETCH STATS =====
    async function fetchStats() {
      if (!getAuthToken()) return;
      try {
        const res = await authFetch('/api/stats');
        const data = await res.json();
        $('statFiles').textContent = data.totalFiles;
        $('statSize').textContent = formatSize(data.totalSize);
        $('statPdfs').textContent = data.pdfCount || 0;
        $('statImages').textContent = data.imgCount || 0;
        $('statDocs').textContent = data.docCount || 0;
        $('statViews').textContent = data.totalViews;
        $('statDownloads').textContent = data.totalDownloads;
        $('statUptime').textContent = formatUptime(data.uptime);
      } catch {}
    }

    // ===== SORT & FILTER =====
    function applyFilters() {
      let files = [...state.files];

      // Filter by type
      if (state.filterType !== 'all') {
        if (state.filterType === 'img') {
          files = files.filter(f => isImageType(f.type));
        } else if (state.filterType === 'doc') {
          files = files.filter(f => isDocType(f.type));
        } else if (state.filterType === 'ppt') {
          files = files.filter(f => ['ppt','pptx'].includes(f.type));
        } else {
          files = files.filter(f => f.type === state.filterType);
        }
      }

      // Search
      const query = el.searchInput.value.toLowerCase().trim();
      if (query) {
        files = files.filter(f => f.name.toLowerCase().includes(query));
      }

      // Sort
      const [key, dir] = state.sortBy.split('-');
      files.sort((a, b) => {
        if (key === 'name') return dir === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
        if (key === 'date') return dir === 'asc' ? new Date(a.modified) - new Date(b.modified) : new Date(b.modified) - new Date(a.modified);
        if (key === 'size') return dir === 'asc' ? a.size - b.size : b.size - a.size;
        if (key === 'type') return a.type.localeCompare(b.type);
        return 0;
      });

      // Favorites first
      const favSet = new Set(state.favorites);
      files.sort((a, b) => {
        const aFav = favSet.has(a.name) ? 0 : 1;
        const bFav = favSet.has(b.name) ? 0 : 1;
        return aFav - bFav;
      });

      state.filteredFiles = files;
    }

    function updateFileCount() {
      el.fileCount.textContent = `${state.filteredFiles.length} file${state.filteredFiles.length !== 1 ? 's' : ''}`;
    }

    // ===== RENDER FILES =====
    function renderFiles() {
      // If classroom mode is active for students, show classroom files
      if (state.showClassroom) {
        renderClassroomView();
        return;
      }

      const files = state.filteredFiles;

      if (files.length === 0) {
        el.contentArea.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“„</div>
            <h3>No documents found</h3>
            <p>${el.searchInput.value ? 'Try a different search term' : 'Upload some files to get started! Drop files anywhere or click the Upload button.'}</p>
            ${!el.searchInput.value ? '<button class="btn btn-primary" style="margin-top:20px" onclick="document.getElementById(\'btnUpload\').click()"><i class="fas fa-upload"></i> Upload Now</button>' : ''}
          </div>
        `;
        return;
      }

      // Category grouping mode
      if (state.sortBy === 'category') {
        renderCategoryView(files);
        return;
      }

      if (state.viewMode === 'grid') {
        renderGridView(files);
      } else {
        renderListView(files);
      }
    }

    function renderClassroomView() {
      const files = state.classroomFiles;
      if (!files || files.length === 0) {
        el.contentArea.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“š</div>
            <h3>No classroom documents</h3>
            <p>${state.role === 'admin' ? 'Right-click any file and choose "Send to Classroom" to share it with your students.' : 'Your teacher hasn\'t shared any documents yet.'}</p>
          </div>
        `;
        return;
      }
      const html = `<div class="file-grid">${files.map(f => `
        <div class="file-card" data-name="${esc(f.name)}" style="position:relative"
             ondblclick="app.openClassroomFile('${esc(f.name)}')">
          <div class="classroom-badge"><i class="fas fa-chalkboard-teacher"></i> Classroom</div>
          <div class="file-card-actions">
            <button class="btn-icon" onclick="event.stopPropagation(); app.downloadClassroomFile('${esc(f.name)}')" title="Download">
              <i class="fas fa-download"></i>
            </button>
          </div>
          <div class="file-card-preview" onclick="app.openClassroomFile('${esc(f.name)}')">
            ${f.type === 'pdf' ? `<i class="fas fa-file-pdf file-type-icon" style="color:#e74c3c"></i>` :
              isImageType(f.type) ? `<img src="${getClassroomDocUrl(f.name)}" style="width:100%;height:100%;object-fit:cover" alt="" loading="lazy">` :
              `<i class="${getFileIcon(f.type)} file-type-icon" style="color:${getFileColor(f.type)}"></i>`
            }
            <div class="preview-overlay"></div>
          </div>
          <div class="file-card-body" onclick="app.openClassroomFile('${esc(f.name)}')">
            <div class="file-card-name" title="${esc(f.name)}">${esc(f.name)}</div>
            <div class="file-card-meta">
              <span class="file-card-type ${getTypeClass(f.type)}">${f.type.toUpperCase()}</span>
              <span>${formatSize(f.size)}</span>
            </div>
          </div>
        </div>
      `).join('')}</div>`;
      el.contentArea.innerHTML = html;
    }

    function renderGridView(files) {
      const isFav = name => state.favorites.includes(name);
      const isSharedToClassroom = name => state.role === 'admin' && state.classroomShared.includes(name);
      const html = `<div class="file-grid">${files.map(f => `
        <div class="file-card ${state.selectedFiles.has(f.name) ? 'selected' : ''}" data-name="${esc(f.name)}" style="position:relative"
             oncontextmenu="app.showContextMenu(event, '${esc(f.name)}')"
             ondblclick="app.openFile('${esc(f.name)}')">
          ${isSharedToClassroom(f.name) ? '<div class="classroom-badge"><i class="fas fa-chalkboard-teacher"></i> Shared</div>' : ''}
          <div class="file-card-checkbox" onclick="event.stopPropagation(); app.toggleSelect('${esc(f.name)}')">
            ${state.selectedFiles.has(f.name) ? '<i class="fas fa-check"></i>' : ''}
          </div>
          <div class="file-card-actions">
            <button class="btn-icon" onclick="event.stopPropagation(); app.toggleFav('${esc(f.name)}')" title="${isFav(f.name) ? 'Unfavorite' : 'Favorite'}">
              <i class="${isFav(f.name) ? 'fas' : 'far'} fa-star" style="${isFav(f.name) ? 'color:#f59e0b' : ''}"></i>
            </button>
            <button class="btn-icon" onclick="event.stopPropagation(); app.downloadFile('${esc(f.name)}')" title="Download">
              <i class="fas fa-download"></i>
            </button>
          </div>
          <div class="file-card-preview" onclick="app.openFile('${esc(f.name)}')">
            ${f.type === 'pdf' ? `<canvas id="thumb-${cssId(f.name)}"></canvas>` :
              isImageType(f.type) ? `<img src="${getDocUrl(f.name)}" style="width:100%;height:100%;object-fit:cover" alt="" loading="lazy">` :
              `<i class="${getFileIcon(f.type)} file-type-icon" style="color:${getFileColor(f.type)}"></i>`
            }
            <div class="preview-overlay"></div>
          </div>
          <div class="file-card-body" onclick="app.openFile('${esc(f.name)}')">
            <div class="file-card-name" title="${esc(f.name)}">${isFav(f.name) ? '<i class="fas fa-star" style="color:#f59e0b;font-size:11px;margin-right:4px"></i>' : ''}${esc(f.name)}</div>
            <div class="file-card-meta">
              <span class="file-card-type ${getTypeClass(f.type)}">${f.type.toUpperCase()}</span>
              <span>${formatSize(f.size)}</span>
            </div>
          </div>
        </div>
      `).join('')}</div>`;

      el.contentArea.innerHTML = html;
      // Generate PDF thumbnails
      files.filter(f => f.type === 'pdf').forEach(f => generateThumbnail(f.name));
    }

    function renderListView(files) {
      const isFav = name => state.favorites.includes(name);
      const html = `<div class="file-list">
        <div class="file-list-item" style="font-weight:600;font-size:12px;color:var(--text-muted);cursor:default;border:none">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Modified</div>
          <div>Size</div>
          <div style="text-align:right">Actions</div>
        </div>
        ${files.map(f => `
        <div class="file-list-item ${state.selectedFiles.has(f.name) ? 'selected' : ''}" data-name="${esc(f.name)}"
             oncontextmenu="app.showContextMenu(event, '${esc(f.name)}')"
             ondblclick="app.openFile('${esc(f.name)}')"
             onclick="app.toggleSelect('${esc(f.name)}')">
          <div class="checkbox" onclick="event.stopPropagation(); app.toggleSelect('${esc(f.name)}')">
            ${state.selectedFiles.has(f.name) ? '<i class="fas fa-check"></i>' : ''}
          </div>
          <div class="file-info">
            <div class="file-icon-mini" style="background:${getFileColor(f.type)}22;color:${getFileColor(f.type)}">
              <i class="${getFileIcon(f.type)}"></i>
            </div>
            <span class="file-name">${isFav(f.name) ? '<i class="fas fa-star" style="color:#f59e0b;font-size:10px;margin-right:4px"></i>' : ''}${esc(f.name)}</span>
          </div>
          <span class="file-type-tag"><span class="file-card-type ${getTypeClass(f.type)}">${f.type.toUpperCase()}</span></span>
          <span class="file-date">${formatDate(f.modified)}</span>
          <span class="file-size">${formatSize(f.size)}</span>
          <div class="file-actions">
            <button class="btn btn-icon" style="width:28px;height:28px;font-size:11px" onclick="event.stopPropagation(); app.toggleFav('${esc(f.name)}')" title="Favorite">
              <i class="${isFav(f.name) ? 'fas' : 'far'} fa-star" style="${isFav(f.name) ? 'color:#f59e0b' : ''}"></i>
            </button>
            <button class="btn btn-icon" style="width:28px;height:28px;font-size:11px" onclick="event.stopPropagation(); app.openFile('${esc(f.name)}')" title="Open">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-icon" style="width:28px;height:28px;font-size:11px" onclick="event.stopPropagation(); app.downloadFile('${esc(f.name)}')" title="Download">
              <i class="fas fa-download"></i>
            </button>
            <button class="btn btn-icon" style="width:28px;height:28px;font-size:11px;color:var(--danger)" onclick="event.stopPropagation(); app.deleteFile('${esc(f.name)}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('')}</div>`;

      el.contentArea.innerHTML = html;
    }

    function renderCategoryView(files) {
      // Group files by category
      const categoryOrder = ['PDF Documents', 'Images', 'Word Documents', 'Presentations', 'Text Files', 'Other'];
      const groups = {};
      files.forEach(f => {
        const cat = getFileCategory(f.type);
        if (!groups[cat]) groups[cat] = [];
        groups[cat].push(f);
      });

      const isFav = name => state.favorites.includes(name);
      let html = '';

      categoryOrder.forEach(cat => {
        const items = groups[cat];
        if (!items || !items.length) return;
        const color = getCategoryColor(cat);
        const icon = getCategoryIcon(cat);

        html += `
          <div class="category-group-header">
            <div class="cat-icon" style="background:${color}22;color:${color}"><i class="${icon}"></i></div>
            <h3>${cat}</h3>
            <span class="cat-count">${items.length} file${items.length !== 1 ? 's' : ''}</span>
          </div>
          <div class="file-grid" style="margin-bottom:12px">
        `;

        items.forEach(f => {
          html += `
            <div class="file-card ${state.selectedFiles.has(f.name) ? 'selected' : ''}" data-name="${esc(f.name)}"
                 oncontextmenu="app.showContextMenu(event, '${esc(f.name)}')"
                 ondblclick="app.openFile('${esc(f.name)}')">
              <div class="file-card-checkbox" onclick="event.stopPropagation(); app.toggleSelect('${esc(f.name)}')">
                ${state.selectedFiles.has(f.name) ? '<i class="fas fa-check"></i>' : ''}
              </div>
              <div class="file-card-actions">
                <button class="btn-icon" onclick="event.stopPropagation(); app.toggleFav('${esc(f.name)}')" title="${isFav(f.name) ? 'Unfavorite' : 'Favorite'}">
                  <i class="${isFav(f.name) ? 'fas' : 'far'} fa-star" style="${isFav(f.name) ? 'color:#f59e0b' : ''}"></i>
                </button>
                <button class="btn-icon" onclick="event.stopPropagation(); app.downloadFile('${esc(f.name)}')" title="Download">
                  <i class="fas fa-download"></i>
                </button>
              </div>
              <div class="file-card-preview" onclick="app.openFile('${esc(f.name)}')">
                ${f.type === 'pdf' ? `<canvas id="thumb-${cssId(f.name)}"></canvas>` :
                  isImageType(f.type) ? `<img src="${getDocUrl(f.name)}" style="width:100%;height:100%;object-fit:cover" alt="" loading="lazy">` :
                  `<i class="${getFileIcon(f.type)} file-type-icon" style="color:${getFileColor(f.type)}"></i>`
                }
                <div class="preview-overlay"></div>
              </div>
              <div class="file-card-body" onclick="app.openFile('${esc(f.name)}')">
                <div class="file-card-name" title="${esc(f.name)}">${isFav(f.name) ? '<i class="fas fa-star" style="color:#f59e0b;font-size:11px;margin-right:4px"></i>' : ''}${esc(f.name)}</div>
                <div class="file-card-meta">
                  <span class="file-card-type ${getTypeClass(f.type)}">${f.type.toUpperCase()}</span>
                  <span>${formatSize(f.size)}</span>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      });

      el.contentArea.innerHTML = html;
      files.filter(f => f.type === 'pdf').forEach(f => generateThumbnail(f.name));
    }

    function esc(str) { return str.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
    function cssId(str) { return str.replace(/[^a-zA-Z0-9]/g, '_'); }

    // ===== PDF THUMBNAILS =====
    async function generateThumbnail(filename) {
      try {
        const canvasEl = document.getElementById(`thumb-${cssId(filename)}`);
        if (!canvasEl) return;
        const pdf = await pdfjsLib.getDocument({ url: getDocUrl(filename), withCredentials: false }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 0.5 });
        canvasEl.width = viewport.width;
        canvasEl.height = viewport.height;
        await page.render({ canvasContext: canvasEl.getContext('2d'), viewport }).promise;
      } catch {}
    }

    // ===== PDF VIEWER =====
    async function openFile(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (isImageType(ext)) {
        openImageViewer(filename);
        return;
      }
      if (ext === 'docx') {
        openDocxViewer(filename);
        return;
      }
      if (ext === 'txt') {
        window.open(getDocUrl(filename), '_blank');
        return;
      }
      if (ext === 'ppt' || ext === 'pptx') {
        await convertPresentationToPdfAndOpen(filename);
        return;
      }
      if (ext !== 'pdf') {
        downloadFile(filename);
        return;
      }

      state.currentPdf = filename;
      state.currentPage = 1;
      state.zoom = 1.0;
      state.rotation = 0;
      el.viewerOverlay.classList.add('active');
      el.viewerTitle.textContent = filename;
      el.viewerLoading.style.display = 'flex';
      el.viewerProgressBar.style.width = '0%';
      el.pdfPagesContainer.innerHTML = '';
      document.body.style.overflow = 'hidden';

      try {
        const loadingTask = pdfjsLib.getDocument({ url: getDocUrl(filename), withCredentials: false });
        loadingTask.onProgress = (p) => {
          if (p.total) {
            el.viewerProgressBar.style.width = Math.round((p.loaded / p.total) * 100) + '%';
          }
        };
        state.pdfDoc = await loadingTask.promise;
        state.totalPages = state.pdfDoc.numPages;
        el.viewerTotalPages.textContent = state.totalPages;
        el.viewerPageInput.max = state.totalPages;
        el.viewerLoading.style.display = 'none';
        renderAllPages();
        generateViewerThumbnails();
        setupScrollTracking();
      } catch(e) {
        toast('Failed to load PDF', 'error');
        closeViewer();
      }
    }

    async function convertPresentationToPdfAndOpen(filename) {
      toast('Converting presentation for viewer...', 'info');
      try {
        const res = await authFetch(`/api/convert/presentation-to-pdf/${encodeURIComponent(filename)}`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'Failed to convert presentation');
        }
        toast('Presentation converted to PDF preview', 'success');
        await openFile(data.pdfName);
      } catch (e) {
        toast(e.message || 'Could not open presentation', 'error');
      }
    }

    // ===== ADVANCED PDF RENDERING ENGINE =====
    // Uses IntersectionObserver for lazy rendering, DPR-aware sharp canvases,
    // proper layout via CSS width/height (no transform: scale), scroll preservation,
    // and render cancellation for smooth zoom.

    // Cancel all in-flight page renders
    function cancelAllRenders() {
      for (const [pageNum, task] of state.renderTasks) {
        try { task.cancel(); } catch(e) {}
      }
      state.renderTasks.clear();
    }

    // Render a single page onto its canvas with DPR-aware crisp rendering
    async function renderSinglePage(pe, forceRerender = false) {
      if (!state.pdfDoc) return;
      if (pe.rendered && !forceRerender) return;

      // Cancel any existing render for this page
      const existingTask = state.renderTasks.get(pe.pageNum);
      if (existingTask) {
        try { existingTask.cancel(); } catch(e) {}
        state.renderTasks.delete(pe.pageNum);
      }

      try {
        const page = await state.pdfDoc.getPage(pe.pageNum);
        const dpr = window.devicePixelRatio || 1;
        const displayViewport = page.getViewport({ scale: state.zoom, rotation: state.rotation });
        const renderViewport = page.getViewport({ scale: state.zoom * dpr, rotation: state.rotation });

        // Set canvas buffer size (actual pixels for sharp HiDPI rendering)
        pe.canvas.width = Math.floor(renderViewport.width);
        pe.canvas.height = Math.floor(renderViewport.height);

        // Set CSS display size (layout-affecting, no transform needed)
        pe.canvas.style.width = Math.floor(displayViewport.width) + 'px';
        pe.canvas.style.height = Math.floor(displayViewport.height) + 'px';

        const ctx = pe.canvas.getContext('2d');
        const renderTask = page.render({ canvasContext: ctx, viewport: renderViewport });
        state.renderTasks.set(pe.pageNum, renderTask);

        await renderTask.promise;
        state.renderTasks.delete(pe.pageNum);
        pe.rendered = true;
      } catch(e) {
        if (e && e.name !== 'RenderingCancelledException') {
          console.warn(`Failed to render page ${pe.pageNum}`, e);
        }
      }
    }

    // Setup IntersectionObserver for lazy page rendering
    function setupLazyRendering() {
      if (state.pageObserver) {
        state.pageObserver.disconnect();
      }

      state.pageObserver = new IntersectionObserver((entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            const pageNum = parseInt(entry.target.dataset.page);
            const pe = state.pageElements.find(p => p.pageNum === pageNum);
            if (pe && !pe.rendered) {
              renderSinglePage(pe);
            }
          }
        }
      }, {
        root: el.viewerCanvasContainer,
        rootMargin: '200% 0px', // Pre-render pages 2 viewports ahead/behind
        threshold: 0
      });

      for (const pe of state.pageElements) {
        state.pageObserver.observe(pe.wrapper);
      }
    }

    // Render ALL pages into scroll container (full initialization)
    async function renderAllPages() {
      if (!state.pdfDoc) return;
      cancelAllRenders();
      el.pdfPagesContainer.innerHTML = '';
      state.pageElements = [];
      state.pageViewports = [];

      // Get base viewports for all pages (scale=1, current rotation)
      for (let i = 1; i <= state.totalPages; i++) {
        const page = await state.pdfDoc.getPage(i);
        const baseVp = page.getViewport({ scale: 1.0, rotation: state.rotation });
        state.pageViewports.push(baseVp);
      }

      // Create DOM elements with correct CSS sizes
      for (let i = 0; i < state.totalPages; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = 'pdf-page-wrapper';
        wrapper.dataset.page = i + 1;
        wrapper.style.animationDelay = `${Math.min(i * 0.05, 0.5)}s`;

        const canvas = document.createElement('canvas');
        const label = document.createElement('div');
        label.className = 'pdf-page-label';
        label.textContent = `Page ${i + 1} of ${state.totalPages}`;

        // Set CSS display size immediately to prevent layout shifts
        const vp = state.pageViewports[i];
        const cssWidth = Math.floor(vp.width * state.zoom);
        const cssHeight = Math.floor(vp.height * state.zoom);
        canvas.style.width = cssWidth + 'px';
        canvas.style.height = cssHeight + 'px';
        // Minimal buffer initially; real render happens lazily
        canvas.width = 1;
        canvas.height = 1;

        wrapper.appendChild(canvas);
        wrapper.appendChild(label);
        el.pdfPagesContainer.appendChild(wrapper);
        state.pageElements.push({ wrapper, canvas, pageNum: i + 1, rendered: false });
      }

      // Setup lazy rendering via IntersectionObserver
      setupLazyRendering();

      // Eagerly render first few visible pages for immediate display
      const visibleCount = Math.min(5, state.totalPages);
      const renderPromises = [];
      for (let i = 0; i < visibleCount; i++) {
        renderPromises.push(renderSinglePage(state.pageElements[i]));
      }
      await Promise.all(renderPromises);

      el.viewerZoomLabel.textContent = Math.round(state.zoom * 100) + '%';
      el.readingProgress.querySelector('.reading-progress-fill').style.width = ((1 / state.totalPages) * 100) + '%';
    }

    // Get scroll anchor point (which page is centered + offset ratio)
    function getScrollAnchor() {
      const container = el.viewerCanvasContainer;
      const containerRect = container.getBoundingClientRect();
      const containerCenter = containerRect.top + containerRect.height / 2;
      let bestIdx = 0;
      let bestDist = Infinity;

      if (state.pageElements) {
        for (let i = 0; i < state.pageElements.length; i++) {
          const pe = state.pageElements[i];
          const rect = pe.wrapper.getBoundingClientRect();
          const pageCenter = rect.top + rect.height / 2;
          const dist = Math.abs(pageCenter - containerCenter);
          if (dist < bestDist) {
            bestDist = dist;
            bestIdx = i;
          }
        }
      }

      const pe = state.pageElements[bestIdx];
      const rect = pe.wrapper.getBoundingClientRect();
      const offsetRatio = (containerCenter - rect.top) / rect.height;
      return { pageIndex: bestIdx, offsetRatio };
    }

    // Restore scroll position from anchor
    function restoreScrollAnchor(anchor) {
      const container = el.viewerCanvasContainer;
      const pe = state.pageElements[anchor.pageIndex];
      if (!pe) return;
      const wrapperTop = pe.wrapper.offsetTop;
      const wrapperHeight = pe.wrapper.offsetHeight;
      const targetCenter = wrapperTop + wrapperHeight * anchor.offsetRatio;
      container.scrollTop = targetCenter - container.clientHeight / 2;
    }

    // Re-render pages after zoom/rotation â€” proper sizing + scroll preservation
    let _zoomDebounce = null;

    function rerenderAllPages() {
      if (!state.pdfDoc || !state.pageElements || !state.pageViewports.length) return;

      // Save scroll anchor before resizing
      const anchor = getScrollAnchor();

      // Cancel in-flight renders
      cancelAllRenders();

      // Immediately resize all canvases via CSS (lightweight, no re-render)
      for (let i = 0; i < state.pageElements.length; i++) {
        const pe = state.pageElements[i];
        const vp = state.pageViewports[i];
        const cssWidth = Math.floor(vp.width * state.zoom);
        const cssHeight = Math.floor(vp.height * state.zoom);
        pe.canvas.style.width = cssWidth + 'px';
        pe.canvas.style.height = cssHeight + 'px';
        pe.rendered = false; // Mark for re-render at new resolution
      }

      // Restore scroll position after layout change
      restoreScrollAnchor(anchor);

      el.viewerZoomLabel.textContent = Math.round(state.zoom * 100) + '%';

      // Debounce the expensive re-render of visible pages
      clearTimeout(_zoomDebounce);
      _zoomDebounce = setTimeout(() => {
        // Re-trigger IntersectionObserver to render newly visible pages
        if (state.pageObserver) {
          state.pageObserver.disconnect();
        }
        setupLazyRendering();
      }, 150);
    }

    // Track scroll to update current page indicator
    function setupScrollTracking() {
      const container = el.viewerCanvasContainer;
      let scrollTimeout;
      container.addEventListener('scroll', () => {
        // Find which page is most visible
        const containerRect = container.getBoundingClientRect();
        const containerCenter = containerRect.top + containerRect.height / 2;
        let closestPage = 1;
        let closestDist = Infinity;

        if (state.pageElements) {
          for (const pe of state.pageElements) {
            const rect = pe.wrapper.getBoundingClientRect();
            const pageCenter = rect.top + rect.height / 2;
            const dist = Math.abs(pageCenter - containerCenter);
            if (dist < closestDist) {
              closestDist = dist;
              closestPage = pe.pageNum;
            }
          }
        }

        if (closestPage !== state.currentPage) {
          state.currentPage = closestPage;
          el.viewerPageInput.value = closestPage;
          // Update thumbnails
          document.querySelectorAll('.thumb-item').forEach((t, i) => {
            t.classList.toggle('active', i + 1 === closestPage);
          });
        }

        // Update scroll progress bar
        const scrollPct = container.scrollTop / (container.scrollHeight - container.clientHeight);
        el.pdfScrollProgressFill.style.height = Math.round(scrollPct * 100) + '%';

        // Reading progress
        el.readingProgress.querySelector('.reading-progress-fill').style.width = ((closestPage / state.totalPages) * 100) + '%';

        // Show page jump tooltip
        el.pdfPageJump.textContent = `Page ${closestPage}`;
        el.pdfPageJump.style.display = 'block';
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          el.pdfPageJump.style.display = 'none';
        }, 1200);
      });
    }

    // Scroll to a specific page
    function scrollToPage(num) {
      if (!state.pageElements || num < 1 || num > state.totalPages) return;
      const pe = state.pageElements[num - 1];
      if (pe && pe.wrapper) {
        pe.wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        state.currentPage = num;
        el.viewerPageInput.value = num;
        document.querySelectorAll('.thumb-item').forEach((t, i) => {
          t.classList.toggle('active', i + 1 === num);
        });
      }
    }

    // Legacy single-page renderPage (still used by mini player)
    async function renderPage(num) {
      if (!state.pdfDoc) return;
      state.currentPage = num;
      el.viewerPageInput.value = num;

      const page = await state.pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: state.zoom * 1.5, rotation: state.rotation });
      const canvas = el.viewerCanvas;
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

      el.viewerZoomLabel.textContent = Math.round(state.zoom * 100) + '%';

      // Update thumbnail active state
      document.querySelectorAll('.thumb-item').forEach((t, i) => {
        t.classList.toggle('active', i + 1 === num);
      });

      // Reading progress
      el.readingProgress.querySelector('.reading-progress-fill').style.width = ((num / state.totalPages) * 100) + '%';
    }

    async function generateViewerThumbnails() {
      el.viewerSidebarPanel.innerHTML = '';
      for (let i = 1; i <= Math.min(state.totalPages, 50); i++) {
        const item = document.createElement('div');
        item.className = `thumb-item ${i === 1 ? 'active' : ''}`;
        item.innerHTML = `<canvas></canvas><div class="page-num">Page ${i}</div>`;
        item.onclick = () => scrollToPage(i);
        el.viewerSidebarPanel.appendChild(item);

        // Render thumbnail async
        try {
          const page = await state.pdfDoc.getPage(i);
          const vp = page.getViewport({ scale: 0.3 });
          const c = item.querySelector('canvas');
          c.width = vp.width;
          c.height = vp.height;
          await page.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
        } catch {}
      }
    }

    function closeViewer() {
      el.viewerOverlay.classList.remove('active');
      document.body.style.overflow = '';
      cancelAllRenders();
      if (state.pageObserver) { state.pageObserver.disconnect(); state.pageObserver = null; }
      clearTimeout(_zoomDebounce);
      state.pdfDoc = null;
      state.pageElements = null;
      state.pageViewports = [];
      el.pdfPagesContainer.innerHTML = '';
      el.readingProgress.querySelector('.reading-progress-fill').style.width = '0%';
      el.pdfScrollProgressFill.style.height = '0%';
    }

    // ===== MINI PLAYER =====
    async function openMiniPlayer() {
      if (!state.pdfDoc || !state.currentPdf) return;
      state.miniPdf = state.pdfDoc;
      state.miniPage = state.currentPage;
      el.miniPlayerTitle.textContent = state.currentPdf.length > 30 ? state.currentPdf.substring(0, 27) + '...' : state.currentPdf;
      state.miniPlayerActive = true;
      el.miniPlayer.classList.add('active');
      closeViewer();
      renderMiniPage();
    }

    async function renderMiniPage() {
      if (!state.miniPdf) return;
      const page = await state.miniPdf.getPage(state.miniPage);
      const vp = page.getViewport({ scale: 0.8 });
      const c = el.miniCanvas;
      c.width = vp.width;
      c.height = vp.height;
      await page.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
      el.miniPageInfo.textContent = `${state.miniPage}/${state.miniPdf.numPages}`;
    }

    function closeMiniPlayer() {
      el.miniPlayer.classList.remove('active');
      state.miniPlayerActive = false;
      state.miniPdf = null;
    }

    // ===== IMAGE VIEWER =====
    function openImageViewer(filename) {
      state.imgViewerFile = filename;
      state.imgZoom = 1;
      state.imgRotation = 0;

      // Build gallery from current filtered files
      state.imgGalleryFiles = state.filteredFiles.filter(f => isImageType(f.type)).map(f => f.name);
      state.imgGalleryIndex = state.imgGalleryFiles.indexOf(filename);
      if (state.imgGalleryIndex === -1) state.imgGalleryIndex = 0;

      loadImageInViewer(filename);
      el.imageViewer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function loadImageInViewer(filename) {
      state.imgViewerFile = filename;
      const url = getDocUrl(filename);
      el.imgViewerImg.style.transform = `scale(${state.imgZoom}) rotate(${state.imgRotation}deg)`;
      el.imgViewerImg.src = url;
      el.imgViewerImg.onload = function() {
        el.imgInfoDims.textContent = `${this.naturalWidth} Ã— ${this.naturalHeight}`;
      };
      el.imgViewerTitle.textContent = filename;
      el.imgInfoName.textContent = filename;

      // Find file size from state
      const file = state.filteredFiles.find(f => f.name === filename) || state.files.find(f => f.name === filename);
      el.imgInfoSize.textContent = file ? formatSize(file.size) : '';
      el.imgInfoIndex.textContent = `${state.imgGalleryIndex + 1} / ${state.imgGalleryFiles.length}`;
    }

    function closeImageViewer() {
      el.imageViewer.classList.remove('active');
      el.imgViewerImg.src = '';
      document.body.style.overflow = '';
      state.imgViewerFile = null;
    }

    function imgNavigateGallery(dir) {
      if (!state.imgGalleryFiles.length) return;
      state.imgGalleryIndex = (state.imgGalleryIndex + dir + state.imgGalleryFiles.length) % state.imgGalleryFiles.length;
      state.imgZoom = 1;
      state.imgRotation = 0;
      loadImageInViewer(state.imgGalleryFiles[state.imgGalleryIndex]);
    }

    function imgZoomIn() {
      state.imgZoom = Math.min(state.imgZoom + 0.25, 5);
      el.imgViewerImg.style.transform = `scale(${state.imgZoom}) rotate(${state.imgRotation}deg)`;
    }

    function imgZoomOut() {
      state.imgZoom = Math.max(state.imgZoom - 0.25, 0.25);
      el.imgViewerImg.style.transform = `scale(${state.imgZoom}) rotate(${state.imgRotation}deg)`;
    }

    function imgRotate() {
      state.imgRotation = (state.imgRotation + 90) % 360;
      el.imgViewerImg.style.transform = `scale(${state.imgZoom}) rotate(${state.imgRotation}deg)`;
    }

    function imgFitScreen() {
      state.imgZoom = 1;
      state.imgRotation = 0;
      el.imgViewerImg.style.transform = 'scale(1) rotate(0deg)';
    }

    // ===== DOCX VIEWER =====
    async function openDocxViewer(filename) {
      el.docxViewer.classList.add('active');
      el.docxViewerTitle.textContent = filename;
      el.docxToolbar.style.display = 'none';
      el.docxContent.contentEditable = 'false';
      el.docxContent.innerHTML = '<div style="text-align:center;padding:60px"><i class="fas fa-spinner fa-spin" style="font-size:40px;color:#6366f1"></i><p style="margin-top:16px;color:#aaa">Loading document...</p></div>';
      document.body.style.overflow = 'hidden';
      state.docxViewerFile = filename;
      state.docxEditing = false;
      state.docxDirty = false;
      state.docxOriginalHtml = '';
      $('docxEditToggle').title = 'Enable Editing';
      $('docxEditToggle').innerHTML = '<i class="fas fa-pen"></i>';

      try {
        const resp = await authFetch(`/documents/${encodeURIComponent(filename)}`);
        const arrayBuffer = await resp.arrayBuffer();
        const result = await mammoth.convertToHtml({ arrayBuffer });
        const html = result.value || '<p style="color:#aaa;text-align:center;padding:40px">Document is empty or could not be rendered.</p>';
        el.docxContent.innerHTML = html;
        state.docxOriginalHtml = html;
        if (result.messages && result.messages.length) {
          console.log('Mammoth warnings:', result.messages);
        }
      } catch (e) {
        el.docxContent.innerHTML = '<div style="text-align:center;padding:60px;color:#ef4444"><i class="fas fa-exclamation-triangle" style="font-size:40px"></i><p style="margin-top:16px">Failed to load document</p></div>';
        toast('Failed to render DOCX file', 'error');
      }
    }

    function closeDocxViewer() {
      el.docxViewer.classList.remove('active');
      el.docxContent.innerHTML = '';
      el.docxContent.contentEditable = 'false';
      el.docxToolbar.style.display = 'none';
      state.docxEditing = false;
      state.docxOriginalHtml = '';
      state.docxDirty = false;
      document.body.style.overflow = '';
      state.docxViewerFile = null;
    }

    function setDocxEditing(enabled) {
      if (!state.docxViewerFile) return;
      state.docxEditing = enabled;
      el.docxContent.contentEditable = enabled ? 'true' : 'false';
      el.docxToolbar.style.display = enabled ? 'flex' : 'none';
      $('docxEditToggle').title = enabled ? 'Disable Editing' : 'Enable Editing';
      $('docxEditToggle').innerHTML = enabled ? '<i class="fas fa-lock-open"></i>' : '<i class="fas fa-pen"></i>';
      if (enabled) {
        el.docxContent.focus();
        toast('DOCX editing enabled', 'info');
      }
    }

    function applyDocxCommand(cmd, value = null) {
      if (!state.docxEditing) return;
      document.execCommand('styleWithCSS', false, true);
      document.execCommand(cmd, false, value);
      state.docxDirty = true;
      el.docxContent.focus();
    }

    function exportEditedDocxHtml() {
      if (!state.docxViewerFile) return;
      const base = state.docxViewerFile.replace(/\.[^.]+$/, '');
      const name = `${base}_edited.html`;
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(base)}</title></head><body>${el.docxContent.innerHTML}</body></html>`;
      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
      toast(`Exported ${name}`, 'success');
    }

    function maybeConfirmDocxDiscard() {
      if (state.docxEditing && state.docxDirty) {
        return confirm('Discard unsaved DOCX edits?');
      }
      return true;
    }

    // ===== PRINT =====
    function parsePageRange(input, maxPages) {
      const set = new Set();
      const chunks = input.split(',').map(s => s.trim()).filter(Boolean);
      for (const chunk of chunks) {
        if (chunk.includes('-')) {
          const [startRaw, endRaw] = chunk.split('-').map(s => parseInt(s.trim(), 10));
          if (Number.isNaN(startRaw) || Number.isNaN(endRaw)) return null;
          const start = Math.min(startRaw, endRaw);
          const end = Math.max(startRaw, endRaw);
          if (start < 1 || end > maxPages) return null;
          for (let i = start; i <= end; i++) set.add(i);
        } else {
          const pageNum = parseInt(chunk, 10);
          if (Number.isNaN(pageNum) || pageNum < 1 || pageNum > maxPages) return null;
          set.add(pageNum);
        }
      }
      return [...set].sort((a, b) => a - b);
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function buildPrintOptions() {
      const copies = Math.max(1, Math.min(20, parseInt(el.printCopies.value, 10) || 1));
      const scalePct = Math.max(40, Math.min(200, parseInt(el.printScale.value, 10) || 100));
      const options = {
        pageMode: el.printPageMode.value,
        customPages: el.printCustomPages.value.trim(),
        copies,
        paperSize: el.printPaperSize.value,
        orientation: el.printOrientation.value,
        margins: el.printMargins.value,
        colorMode: el.printColorMode.value,
        scalePct,
        includeHeader: el.printHeaderToggle.checked,
      };
      el.printCopies.value = String(copies);
      el.printScale.value = String(scalePct);
      return options;
    }

    function openPrintModal(type) {
      const file = type === 'pdf' ? state.currentPdf : state.docxViewerFile;
      if (!file) return;
      state.printTarget = { type, file };
      el.printTargetLabel.textContent = `${file} (${type.toUpperCase()})`;
      el.printPageMode.disabled = type !== 'pdf';
      el.printCustomPages.disabled = type !== 'pdf';
      el.printCustomPagesWrap.style.display = type === 'pdf' && el.printPageMode.value === 'custom' ? '' : 'none';
      el.printSaveAsPdfBtn.style.display = '';
      el.printModal.classList.add('active');
    }

    function closePrintModal() {
      el.printModal.classList.remove('active');
      state.printTarget = null;
    }

    async function startPrint(saveAsPdf = false) {
      if (!state.printTarget) return;
      const opts = buildPrintOptions();
      try {
        if (state.printTarget.type === 'pdf') {
          await printPdfWithOptions(state.printTarget.file, opts, saveAsPdf);
        } else {
          if (saveAsPdf) {
            await saveDocxAsPdf(state.printTarget.file);
          } else {
            await printDocxWithOptions(state.printTarget.file, opts);
          }
        }
        closePrintModal();
      } catch (error) {
        toast(error.message || 'Print failed', 'error');
      }
    }

    function resolvePageSize(paperSize) {
      const map = {
        a4: '210mm 297mm',
        letter: '8.5in 11in',
        legal: '8.5in 14in',
        a3: '297mm 420mm'
      };
      return map[paperSize] || map.a4;
    }

    function resolvePageMargin(marginMode) {
      if (marginMode === 'none') return '0';
      if (marginMode === 'wide') return '20mm';
      return '12mm';
    }

    async function openPrintFrame(html) {
      const frame = document.createElement('iframe');
      frame.style.position = 'fixed';
      frame.style.right = '-9999px';
      frame.style.bottom = '0';
      frame.style.width = '1px';
      frame.style.height = '1px';
      frame.setAttribute('aria-hidden', 'true');
      document.body.appendChild(frame);

      const frameDoc = frame.contentDocument || frame.contentWindow.document;
      frameDoc.open();
      frameDoc.write(html);
      frameDoc.close();

      await new Promise(resolve => setTimeout(resolve, 250));
      frame.contentWindow.focus();
      frame.contentWindow.print();
      setTimeout(() => frame.remove(), 2500);
    }

    async function printPdfWithOptions(filename, options, saveAsPdf) {
      if (!state.pdfDoc || state.currentPdf !== filename) {
        throw new Error('Open the PDF in the viewer before printing');
      }

      let pages;
      if (options.pageMode === 'all') {
        pages = Array.from({ length: state.totalPages }, (_, i) => i + 1);
      } else if (options.pageMode === 'current') {
        pages = [state.currentPage];
      } else {
        pages = parsePageRange(options.customPages, state.totalPages);
        if (!pages || pages.length === 0) throw new Error('Invalid custom page range');
      }

      if (pages.length > 60) {
        throw new Error('Please print up to 60 pages at a time to avoid browser memory issues');
      }

      const renderScale = 1.45 * (options.scalePct / 100);
      const images = [];
      for (const pageNum of pages) {
        const page = await state.pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: renderScale, rotation: state.rotation });
        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        images.push({ pageNum, src: canvas.toDataURL('image/png') });
      }

      const pageSize = resolvePageSize(options.paperSize);
      const margin = resolvePageMargin(options.margins);
      const orientation = options.orientation === 'auto'
        ? ((images[0] && images[0].src && state.pageViewports[pages[0] - 1] && state.pageViewports[pages[0] - 1].width > state.pageViewports[pages[0] - 1].height) ? 'landscape' : 'portrait')
        : options.orientation;
      const filterCss = options.colorMode === 'grayscale' ? 'grayscale(1)' : 'none';
      const generatedAt = new Date().toLocaleString();
      let body = '';

      for (let copy = 1; copy <= options.copies; copy++) {
        for (const page of images) {
          body += `
            <section class="print-page">
              ${options.includeHeader ? `<header class="print-header">${escapeHtml(filename)} | Page ${page.pageNum} | ${escapeHtml(generatedAt)}${options.copies > 1 ? ` | Copy ${copy}/${options.copies}` : ''}</header>` : ''}
              <img src="${page.src}" alt="Page ${page.pageNum}">
            </section>
          `;
        }
      }

      const html = `
        <!doctype html>
        <html>
        <head>
          <meta charset="utf-8">
          <style>
            @page { size: ${pageSize} ${orientation}; margin: ${margin}; }
            html, body { margin: 0; padding: 0; background: #fff; }
            body { font-family: Arial, sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .print-page { break-after: page; page-break-after: always; display: flex; flex-direction: column; align-items: center; }
            .print-header { width: 100%; font-size: 11px; color: #444; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
            img { width: 100%; object-fit: contain; filter: ${filterCss}; }
          </style>
        </head>
        <body>${body}</body>
        </html>
      `;

      if (saveAsPdf) {
        toast('In the print dialog, choose "Save as PDF".', 'info');
      }
      await openPrintFrame(html);
    }

    async function printDocxWithOptions(filename, options) {
      if (!state.docxViewerFile || state.docxViewerFile !== filename) {
        throw new Error('Open the DOCX viewer before printing');
      }

      const pageSize = resolvePageSize(options.paperSize);
      const margin = resolvePageMargin(options.margins);
      const orientation = options.orientation === 'auto' ? 'portrait' : options.orientation;
      const filterCss = options.colorMode === 'grayscale' ? 'grayscale(1)' : 'none';
      const generatedAt = new Date().toLocaleString();
      let body = '';

      for (let copy = 1; copy <= options.copies; copy++) {
        body += `
          <section class="doc-copy">
            ${options.includeHeader ? `<header class="print-header">${escapeHtml(filename)} | ${escapeHtml(generatedAt)}${options.copies > 1 ? ` | Copy ${copy}/${options.copies}` : ''}</header>` : ''}
            <article class="docx-body">${el.docxContent.innerHTML}</article>
          </section>
        `;
      }

      const html = `
        <!doctype html>
        <html>
        <head>
          <meta charset="utf-8">
          <style>
            @page { size: ${pageSize} ${orientation}; margin: ${margin}; }
            html, body { margin: 0; padding: 0; background: #fff; }
            body { font-family: Arial, sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: #111; }
            .doc-copy { break-after: page; page-break-after: always; transform: scale(${(options.scalePct / 100).toFixed(2)}); transform-origin: top left; width: ${(100 / (options.scalePct / 100)).toFixed(2)}%; padding: 0; filter: ${filterCss}; }
            .print-header { width: 100%; font-size: 11px; color: #444; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
            .docx-body { line-height: 1.45; }
            .docx-body table { width: 100%; border-collapse: collapse; }
            .docx-body td, .docx-body th { border: 1px solid #ddd; padding: 6px; }
            .docx-body img { max-width: 100%; }
          </style>
        </head>
        <body>${body}</body>
        </html>
      `;

      await openPrintFrame(html);
    }

    async function saveDocxAsPdf(filename) {
      const res = await authFetch(`/api/convert/docx-to-pdf/${encodeURIComponent(filename)}`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok || !data.success) {
        throw new Error(data.error || 'DOCX to PDF conversion failed');
      }
      toast(`Created PDF: ${data.pdfName}`, 'success');
      downloadFile(data.pdfName);
      fetchFiles();
    }

    // ===== OCR =====
    function openOcrModal() {
      if (!state.currentPdf) {
        toast('Open a PDF first', 'warning');
        return;
      }
      el.ocrModal.classList.add('active');
      el.ocrMeta.textContent = `Target: ${state.currentPdf}`;
      el.ocrTextArea.value = state.ocrText || '';
    }

    function closeOcrModal() {
      el.ocrModal.classList.remove('active');
    }

    async function runPdfOcr() {
      if (!state.currentPdf) return;
      el.ocrMeta.textContent = 'Running OCR...';
      try {
        const res = await authFetch(`/api/ocr/pdf/${encodeURIComponent(state.currentPdf)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ maxPages: 20 })
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'OCR failed');
        }
        state.ocrText = data.text || '';
        el.ocrTextArea.value = state.ocrText;
        el.ocrMeta.textContent = `Source: ${data.source} | Pages: ${data.pagesProcessed} | ${new Date().toLocaleString()}`;
        toast('OCR completed', 'success');
      } catch (e) {
        el.ocrMeta.textContent = `OCR failed: ${e.message || 'Unknown error'}`;
        toast(e.message || 'OCR failed', 'error');
      }
    }

    async function copyOcrText() {
      if (!el.ocrTextArea.value.trim()) {
        toast('No OCR text to copy', 'warning');
        return;
      }
      await navigator.clipboard.writeText(el.ocrTextArea.value);
      toast('OCR text copied', 'success');
    }

    function downloadOcrText() {
      const text = el.ocrTextArea.value || '';
      if (!text.trim()) {
        toast('No OCR text to download', 'warning');
        return;
      }
      const base = (state.currentPdf || 'document').replace(/\.pdf$/i, '');
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${base}_ocr.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== FILE OPERATIONS =====
    function downloadFile(name) {
      const a = document.createElement('a');
      a.href = getDownloadUrl(name);
      a.download = name;
      a.click();
      toast(`Downloading ${name}`, 'success');
    }

    async function deleteFile(name) {
      if (!confirm(`Delete "${name}"?`)) return;
      try {
        const res = await authFetch(`/api/pdfs/${encodeURIComponent(name)}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.pendingApproval) {
          toast('Delete request sent for admin approval', 'warning');
        } else {
          toast(`Deleted ${name}`, 'success');
        }
        fetchFiles();
      } catch { toast('Delete failed', 'error'); }
    }

    function toggleSelect(name) {
      if (state.selectedFiles.has(name)) {
        state.selectedFiles.delete(name);
      } else {
        state.selectedFiles.add(name);
      }
      updateSelectionUI();
      renderFiles();
    }

    function selectAll() {
      if (state.selectedFiles.size === state.filteredFiles.length) {
        state.selectedFiles.clear();
      } else {
        state.filteredFiles.forEach(f => state.selectedFiles.add(f.name));
      }
      updateSelectionUI();
      renderFiles();
    }

    function clearSelection() {
      state.selectedFiles.clear();
      updateSelectionUI();
      renderFiles();
    }

    function updateSelectionUI() {
      const count = state.selectedFiles.size;
      el.selectionBar.classList.toggle('visible', count > 0);
      el.selectionCount.textContent = `${count} selected`;
    }

    async function bulkDownload() {
      const files = [...state.selectedFiles];
      if (!files.length) return;
      toast(`Preparing download for ${files.length} files...`, 'info');
      try {
        const res = await authFetch('/api/bulk-download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files })
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prenxy-documents.zip';
        a.click();
        URL.revokeObjectURL(url);
        toast('Download started!', 'success');
        clearSelection();
      } catch { toast('Bulk download failed', 'error'); }
    }

    async function bulkDelete() {
      const files = [...state.selectedFiles];
      if (!files.length) return;
      if (!confirm(`Delete ${files.length} files?`)) return;
      try {
        const res = await authFetch('/api/bulk-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files })
        });
        const data = await res.json();
        if (data.pendingApproval) {
          toast('Delete requests sent for admin approval', 'warning');
        } else {
          toast(`Deleted ${files.length} files`, 'success');
        }
        clearSelection();
        fetchFiles();
      } catch { toast('Bulk delete failed', 'error'); }
    }

    // ===== FAVORITES =====
    function toggleFav(name) {
      const idx = state.favorites.indexOf(name);
      if (idx > -1) {
        state.favorites.splice(idx, 1);
        toast(`Removed from favorites`, 'info');
      } else {
        state.favorites.push(name);
        toast(`Added to favorites â­`, 'success');
      }
      localStorage.setItem('favorites', JSON.stringify(state.favorites));
      applyFilters();
      renderFiles();
    }

    // ===== RENAME =====
    let renameTarget = '';
    function showRename(name) {
      renameTarget = name;
      el.renameInput.value = name;
      el.renameModal.classList.add('active');
      setTimeout(() => {
        el.renameInput.focus();
        const dotIdx = name.lastIndexOf('.');
        if (dotIdx > 0) el.renameInput.setSelectionRange(0, dotIdx);
      }, 100);
    }

    async function doRename() {
      const newName = el.renameInput.value.trim();
      if (!newName || newName === renameTarget) {
        el.renameModal.classList.remove('active');
        return;
      }
      try {
        const res = await authFetch('/api/rename', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ oldName: renameTarget, newName })
        });
        const data = await res.json();
        if (data.success) {
          toast(`Renamed to ${newName}`, 'success');
          el.renameModal.classList.remove('active');
          fetchFiles();
        } else {
          toast(data.error || 'Rename failed', 'error');
        }
      } catch { toast('Rename failed', 'error'); }
    }

    // ===== UPLOAD =====
    let uploadFiles = [];

    function showUploadModal() {
      el.uploadModal.classList.add('active');
      el.uploadList.innerHTML = '';
      el.uploadActions.style.display = 'none';
      el.uploadProgress.style.display = 'none';
      uploadFiles = [];
    }

    function addUploadFiles(fileList) {
      for (const f of fileList) {
        uploadFiles.push(f);
      }
      el.uploadList.innerHTML = uploadFiles.map(f => `
        <div class="upload-item">
          <i class="${getFileIcon(f.name.split('.').pop().toLowerCase())}"></i>
          <span class="upload-name">${f.name}</span>
          <span class="upload-size">${formatSize(f.size)}</span>
          <span class="upload-status">â³</span>
        </div>
      `).join('');
      el.uploadActions.style.display = uploadFiles.length ? 'block' : 'none';
    }

    async function startUpload() {
      if (!uploadFiles.length) return;
      el.uploadProgress.style.display = 'block';
      el.uploadProgressBar.style.width = '0%';

      const formData = new FormData();
      uploadFiles.forEach(f => formData.append('files', f));

      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload');
        const token = getAuthToken();
        if (token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            el.uploadProgressBar.style.width = Math.round((e.loaded / e.total) * 100) + '%';
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.pendingApproval) {
              toast('Upload sent for admin approval', 'warning');
            } else {
              toast(`Uploaded ${data.files.length} file(s)!`, 'success');
              spawnConfetti();
            }
            el.uploadModal.classList.remove('active');
            fetchFiles();
          } else if (xhr.status === 401) {
            handleAuthFail();
          } else {
            toast('Upload failed', 'error');
          }
        };

        xhr.onerror = () => toast('Upload failed', 'error');
        xhr.send(formData);
      } catch { toast('Upload failed', 'error'); }
    }

    // ===== CONTEXT MENU =====
    function openContextMenuAt(x, y, html) {
      el.contextMenu.innerHTML = html;
      el.contextMenu.style.left = Math.min(x, window.innerWidth - 260) + 'px';
      el.contextMenu.style.top = Math.min(y, window.innerHeight - 360) + 'px';
      el.contextMenu.classList.add('active');
    }

    function showContextMenu(event, filename) {
      event.preventDefault();
      event.stopPropagation();
      const isFav = state.favorites.includes(filename);
      const ext = filename.split('.').pop().toLowerCase();
      const isShared = state.classroomShared.includes(filename);
      const classroomItem = state.role === 'admin'
        ? (isShared
            ? `<div class="context-menu-divider"></div><div class="context-menu-item classroom" onclick="app.unshareFromClassroom('${esc(filename)}')"><i class="fas fa-chalkboard"></i><span>Remove from Classroom</span></div>`
            : `<div class="context-menu-divider"></div><div class="context-menu-item classroom" onclick="app.shareToClassroom('${esc(filename)}')"><i class="fas fa-chalkboard-teacher"></i><span>Send to Classroom</span></div>`)
        : '';
      const menuHtml = `
        <div class="context-menu-label">File Actions</div>
        <div class="context-menu-item" onclick="app.openFile('${esc(filename)}')"><i class="fas fa-eye"></i><span>Open</span></div>
        <div class="context-menu-item" onclick="app.downloadFile('${esc(filename)}')"><i class="fas fa-download"></i><span>Download</span></div>
        ${ext === 'pdf' ? `<div class="context-menu-item" onclick="app.openFile('${esc(filename)}'); setTimeout(() => app.openPrintForCurrent('pdf'), 200)"><i class="fas fa-print"></i><span>Print</span></div>` : ''}
        ${ext === 'pdf' ? `<div class="context-menu-item" onclick="app.openFile('${esc(filename)}'); setTimeout(() => app.openOcrForCurrentPdf(), 300)"><i class="fas fa-spell-check"></i><span>OCR Text</span></div>` : ''}
        ${['ppt', 'pptx'].includes(ext) ? `<div class="context-menu-item" onclick="app.openFile('${esc(filename)}')"><i class="fas fa-file-powerpoint"></i><span>Open as Slides</span></div>` : ''}
        ${ext === 'docx' ? `<div class="context-menu-item" onclick="app.openFile('${esc(filename)}'); setTimeout(() => app.openPrintForCurrent('docx'), 200)"><i class="fas fa-print"></i><span>Print</span></div>` : ''}
        ${['doc', 'docx'].includes(ext) ? `<div class="context-menu-item" onclick="app.saveDocAsPdf('${esc(filename)}')"><i class="fas fa-file-pdf"></i><span>Save as PDF</span></div>` : ''}
        <div class="context-menu-item" onclick="app.toggleFav('${esc(filename)}')"><i class="${isFav ? 'fas' : 'far'} fa-star"></i><span>${isFav ? 'Unfavorite' : 'Favorite'}</span></div>
        <div class="context-menu-item" onclick="app.showRename('${esc(filename)}')"><i class="fas fa-pen"></i><span>Rename</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="navigator.clipboard.writeText('${esc(filename)}'); app.toast('Copied!','success')"><i class="fas fa-copy"></i><span>Copy Name</span></div>
        <div class="context-menu-item" onclick="navigator.clipboard.writeText(location.origin+getDocUrl('${esc(filename)}')); app.toast('Link copied!','success')"><i class="fas fa-link"></i><span>Copy Link</span></div>
        ${classroomItem}
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="app.deleteFile('${esc(filename)}')"><i class="fas fa-trash"></i><span>Delete</span></div>
      `;
      openContextMenuAt(event.clientX, event.clientY, menuHtml);
    }

    function showBlankSpaceContextMenu(event) {
      event.preventDefault();
      openContextMenuAt(event.clientX, event.clientY, `
        <div class="context-menu-label">Workspace</div>
        <div class="context-menu-item" onclick="app.refreshFiles()"><i class="fas fa-sync-alt"></i><span>Refresh</span></div>
        <div class="context-menu-item" onclick="app.showUpload()"><i class="fas fa-upload"></i><span>Upload Files</span></div>
        <div class="context-menu-item" onclick="app.openRandomDoc()"><i class="fas fa-random"></i><span>Open Random File</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="app.setGridView()"><i class="fas fa-th-large"></i><span>Grid View</span></div>
        <div class="context-menu-item" onclick="app.setListView()"><i class="fas fa-list"></i><span>List View</span></div>
      `);
    }

    function showToolbarContextMenu(event) {
      event.preventDefault();
      openContextMenuAt(event.clientX, event.clientY, `
        <div class="context-menu-label">Toolbar</div>
        <div class="context-menu-item" onclick="app.refreshFiles()"><i class="fas fa-sync-alt"></i><span>Refresh</span></div>
        <div class="context-menu-item" onclick="app.showStatsPanel()"><i class="fas fa-chart-bar"></i><span>Open Dashboard</span></div>
        <div class="context-menu-item" onclick="app.showThemePicker()"><i class="fas fa-palette"></i><span>Choose Theme</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="app.selectAllFiles()"><i class="fas fa-check-square"></i><span>Select All</span></div>
        <div class="context-menu-item" onclick="app.clearSelectedFiles()"><i class="fas fa-times"></i><span>Clear Selection</span></div>
      `);
    }

    // ===== COMMAND PALETTE =====
    function openCommandPalette() {
      el.commandPalette.classList.add('active');
      el.commandInput.value = '';
      el.commandInput.focus();
      renderCommands('');
    }

    function renderCommands(query) {
      const commands = [
        { icon: 'fa-upload', label: 'Upload Files', action: () => showUploadModal(), shortcut: 'U' },
        { icon: 'fa-sun', label: 'Toggle Theme', action: () => toggleTheme(), shortcut: 'T' },
        { icon: 'fa-palette', label: 'Theme: Classic', action: () => selectTheme('classic') },
        { icon: 'fa-palette', label: 'Theme: Light', action: () => selectTheme('light') },
        { icon: 'fa-meteor', label: 'Theme: Asteroid', action: () => selectTheme('asteroid') },
        { icon: 'fa-microchip', label: 'Theme: Techi', action: () => selectTheme('techi') },
        { icon: 'fa-code', label: 'Theme: VS Code Dark', action: () => selectTheme('vscode-dark') },
        { icon: 'fa-code', label: 'Theme: VS Code Light', action: () => selectTheme('vscode-light') },
        { icon: 'fa-google', label: 'Theme: Google', action: () => selectTheme('google') },
        { icon: 'fa-droplet', label: 'Theme: Liquid Glass', action: () => selectTheme('liquid-glass') },
        { icon: 'fa-sync', label: 'Refresh Files', action: () => fetchFiles(), shortcut: 'R' },
        { icon: 'fa-th-large', label: 'Grid View', action: () => setViewMode('grid'), shortcut: 'G' },
        { icon: 'fa-list', label: 'List View', action: () => setViewMode('list'), shortcut: 'L' },
        { icon: 'fa-check-square', label: 'Select All', action: () => selectAll() },
        { icon: 'fa-keyboard', label: 'Show Shortcuts', action: () => el.shortcutsModal.classList.add('active') },
        { icon: 'fa-chart-bar', label: 'Show Stats', action: () => showStatsModal() },
        { icon: 'fa-random', label: 'Open Random Document', action: () => openRandom() },
        { icon: 'fa-egg', label: 'ðŸ¥š Secret...', action: () => fetchSecret() },
      ];
      if (state.role === 'admin') {
        commands.push(
          { icon: 'fa-terminal', label: 'Open Admin Dashboard', action: () => showStatsModal() },
          { icon: 'fa-hashtag', label: 'Open Social App', action: () => openAdminApp('social') },
          { icon: 'fa-comments', label: 'Open Chat App', action: () => openAdminApp('chat') }
        );
      }

      // Add files
      const fileCommands = state.files.map(f => ({
        icon: getFileIcon(f.type).replace('fas ', 'fa-'),
        label: f.name,
        action: () => openFile(f.name)
      }));

      const all = [...commands, ...fileCommands];
      const q = query.toLowerCase();
      const filtered = q ? all.filter(c => c.label.toLowerCase().includes(q)) : all;

      el.commandResults.innerHTML = filtered.slice(0, 15).map((c, i) => `
        <div class="command-item ${i === 0 ? 'active' : ''}" onclick="app.executeCommand(${commands.indexOf(c) > -1 ? commands.indexOf(c) : -1}, '${esc(c.label)}')">
          <i class="fas ${c.icon}"></i>
          <span>${c.label}</span>
          ${c.shortcut ? `<span class="shortcut">${c.shortcut}</span>` : ''}
        </div>
      `).join('');

      // Store for keyboard nav
      el.commandPalette._commands = filtered;
      el.commandPalette._activeIdx = 0;
    }

    function executeCommand(idx, label) {
      el.commandPalette.classList.remove('active');
      const cmds = el.commandPalette._commands;
      if (cmds && cmds.length > 0) {
        const cmd = idx >= 0 ? cmds.find((_, i) => i === idx) : cmds.find(c => c.label === label.replace(/\\'/g, "'"));
        if (cmd) cmd.action();
      }
    }

    function appendAdminTerminalLine(line, type = 'info') {
      const out = $('adminTerminalOutput');
      if (!out) return;
      const color = type === 'error' ? 'var(--danger)' : (type === 'ok' ? 'var(--success)' : 'var(--text-secondary)');
      const row = document.createElement('div');
      row.style.color = color;
      row.style.padding = '2px 0';
      row.textContent = line;
      out.appendChild(row);
      out.scrollTop = out.scrollHeight;
    }

    function appendAdminSandboxLine(line, type = 'info') {
      const out = $('adminSandboxOutput');
      if (!out) return;
      const color = type === 'error' ? '#fca5a5' : (type === 'ok' ? '#86efac' : '#cbd5e1');
      const row = document.createElement('div');
      row.style.color = color;
      row.style.padding = '2px 0';
      row.style.whiteSpace = 'pre-wrap';
      row.textContent = line;
      out.appendChild(row);
      out.scrollTop = out.scrollHeight;
    }

    async function refreshAdminAccounts() {
      if (state.role !== 'admin') return;
      try {
        const res = await authFetch('/api/admin/accounts');
        if (!res.ok) throw new Error('Failed to fetch accounts');
        state.adminAccounts = await res.json();
        const list = $('adminAccountsList');
        if (list) {
          if (!state.adminAccounts.length) {
            list.innerHTML = '<div style="color:var(--text-muted);font-size:12px">No managed accounts yet.</div>';
          } else {
            list.innerHTML = state.adminAccounts.map(a => `
              <div style="display:grid;grid-template-columns:1.2fr .8fr 1fr;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);font-size:12px">
                <div style="font-weight:600">${esc(a.username)}</div>
                <div style="text-transform:capitalize">${esc(a.role || 'user')}</div>
                <div style="color:var(--text-muted)">${esc(a.createdBy || '-')}</div>
              </div>
            `).join('');
          }
        }
      } catch (e) {
        appendAdminTerminalLine('Error loading account list: ' + (e.message || 'unknown error'), 'error');
      }
    }

    async function createManagedAccountFromDashboard() {
      const username = ($('adminNewUsername')?.value || '').trim();
      const password = ($('adminNewPassword')?.value || '').trim();
      const role = ($('adminNewRole')?.value || '').trim();
      const parentAdmin = ($('adminParentAdmin')?.value || '').trim();
      const displayName = ($('adminDisplayName')?.value || '').trim();
      if (!username || !password || !role) {
        toast('Username, password and role are required', 'error');
        return;
      }
      try {
        const res = await authFetch('/api/admin/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, role, parentAdmin, displayName })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to create account');
        toast(`Created ${data.account.role}: ${data.account.username}`, 'success');
        appendAdminTerminalLine(`Created ${data.account.role} account: ${data.account.username}`, 'ok');
        if ($('adminNewUsername')) $('adminNewUsername').value = '';
        if ($('adminNewPassword')) $('adminNewPassword').value = '';
        if ($('adminDisplayName')) $('adminDisplayName').value = '';
        await refreshAdminAccounts();
      } catch (e) {
        toast(e.message || 'Failed to create account', 'error');
        appendAdminTerminalLine('Create account failed: ' + (e.message || 'unknown error'), 'error');
      }
    }

    async function runAdminTerminalCommand(raw) {
      const input = String(raw || '').trim();
      if (!input) return;
      appendAdminTerminalLine('> ' + input, 'info');
      try {
        const res = await authFetch('/api/admin/terminal/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: input })
        });
        const data = await res.json();
        const lines = String(data.output || '').split('\n').filter(Boolean);
        if (!lines.length) appendAdminTerminalLine('(no output)', res.ok ? 'ok' : 'error');
        lines.forEach(line => appendAdminTerminalLine(line, res.ok ? 'ok' : 'error'));
        if (res.ok && /(create-|delete-account|set-role|reset-password)/.test(input)) {
          refreshAdminAccounts();
        }
      } catch (e) {
        appendAdminTerminalLine('Command failed: ' + (e.message || 'unknown error'), 'error');
      }
    }

    async function runAdminSandboxCommand(raw) {
      const input = String(raw || '').trim();
      if (!input) return;
      const promptEl = $('adminSandboxPrompt');
      const prompt = promptEl ? promptEl.textContent : '~/';
      appendAdminSandboxLine(`${prompt} $ ${input}`, 'info');
      try {
        const res = await authFetch('/api/admin/sandbox/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: input })
        });
        const data = await res.json();
        if (data.cwd && promptEl) promptEl.textContent = data.cwd;
        if (String(data.output || '') === '__CLEAR__') {
          const out = $('adminSandboxOutput');
          if (out) out.innerHTML = '';
          return;
        }
        const lines = String(data.output || '').split('\n');
        if (!lines.length || (lines.length === 1 && !lines[0])) appendAdminSandboxLine('(no output)', res.ok ? 'ok' : 'error');
        else lines.forEach(line => appendAdminSandboxLine(line, res.ok ? 'ok' : 'error'));
      } catch (e) {
        appendAdminSandboxLine('Command failed: ' + (e.message || 'unknown error'), 'error');
      }
    }

    function bindAdminDashboardEventsOnce() {
      const input = $('adminTerminalInput');
      if (input && !input.dataset.bound) {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const value = input.value;
            input.value = '';
            runAdminTerminalCommand(value);
          }
        });
        input.dataset.bound = '1';
      }
      const sandboxInput = $('adminSandboxInput');
      if (sandboxInput && !sandboxInput.dataset.bound) {
        sandboxInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const value = sandboxInput.value;
            sandboxInput.value = '';
            runAdminSandboxCommand(value);
          }
        });
        sandboxInput.dataset.bound = '1';
      }
    }

    function openAdminApp(appId) {
      if (appId === 'social') window.open('/social.html', '_blank');
      if (appId === 'chat') window.open('/chat.html', '_blank');
      if (appId === 'docs') window.open('/drive.html', '_blank');
    }

    // ===== STATS MODAL =====
    async function showStatsModal() {
      el.statsModal.classList.add('active');
      try {
        const res = await authFetch('/api/stats');
        const data = await res.json();
        const adminTools = state.role === 'admin' ? `
          <div style="background:var(--bg-tertiary);border-radius:var(--radius-md);padding:16px;grid-column:1/-1">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
              <div style="font-size:14px;font-weight:700;color:var(--text-secondary)">Admin Control Center</div>
              <div style="display:flex;gap:8px">
                <button class="btn" onclick="app.adminOpenApp('docs')"><i class="fas fa-folder-open"></i> Doc Viewer</button>
                <button class="btn" onclick="app.adminOpenApp('social')"><i class="fas fa-hashtag"></i> Social</button>
                <button class="btn" onclick="app.adminOpenApp('chat')"><i class="fas fa-comments"></i> Chat</button>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:12px">
                <div style="font-size:13px;font-weight:700;margin-bottom:10px">Create Account</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                  <input id="adminNewUsername" class="search-input" placeholder="username">
                  <input id="adminNewPassword" class="search-input" placeholder="password">
                  <select id="adminNewRole" class="search-input" style="padding:10px 12px">
                    <option value="admin">Admin</option>
                    <option value="slave">Slave (Student)</option>
                    <option value="user">Normal User</option>
                  </select>
                  <input id="adminParentAdmin" class="search-input" placeholder="parent admin (for slave)">
                  <input id="adminDisplayName" class="search-input" style="grid-column:1/-1" placeholder="display name (optional)">
                </div>
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button class="btn btn-primary" onclick="app.adminCreateAccount()"><i class="fas fa-user-plus"></i> Create</button>
                  <button class="btn" onclick="app.adminRefreshAccounts()"><i class="fas fa-sync-alt"></i> Refresh Accounts</button>
                </div>
                <div id="adminAccountsList" style="display:grid;gap:8px;margin-top:12px;max-height:220px;overflow:auto"></div>
              </div>
              <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;min-height:320px">
                <div style="font-size:13px;font-weight:700;margin-bottom:8px">Terminal App</div>
                <div style="font-size:12px;color:var(--text-muted);line-height:1.5">
                  Terminal has been moved to the Study Hub for a consistent experience.
                </div>
                <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn btn-primary" onclick="window.location.href='/'"><i class="fas fa-terminal"></i> Open Terminal in Hub</button>
                  <button class="btn" onclick="window.open('/', '_blank')"><i class="fas fa-up-right-from-square"></i> Open Hub in New Tab</button>
                </div>
              </div>
            </div>
          </div>
        ` : '';

        el.statsContent.innerHTML = `
          <div style="background:var(--bg-tertiary);border-radius:var(--radius-md);padding:20px;text-align:center">
            <div style="font-size:32px;font-weight:800;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent">${data.totalFiles}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">Total Files</div>
          </div>
          <div style="background:var(--bg-tertiary);border-radius:var(--radius-md);padding:20px;text-align:center">
            <div style="font-size:32px;font-weight:800;color:var(--success)">${formatSize(data.totalSize)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">Total Size</div>
          </div>
          <div style="background:var(--bg-tertiary);border-radius:var(--radius-md);padding:20px;text-align:center">
            <div style="font-size:32px;font-weight:800;color:var(--info)">${data.totalViews}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">Views</div>
          </div>
          <div style="background:var(--bg-tertiary);border-radius:var(--radius-md);padding:20px;text-align:center">
            <div style="font-size:32px;font-weight:800;color:var(--warning)">${data.totalDownloads}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">Downloads</div>
          </div>
          <div style="background:var(--bg-tertiary);border-radius:var(--radius-md);padding:16px;grid-column:1/-1">
            <div style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text-secondary)">File Breakdown</div>
            <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center">
              <div style="display:flex;align-items:center;gap:6px"><i class="fas fa-file-pdf" style="color:#ef4444"></i><span style="font-weight:700">${data.pdfCount || 0}</span><span style="color:var(--text-muted);font-size:12px">PDFs</span></div>
              <div style="display:flex;align-items:center;gap:6px"><i class="fas fa-image" style="color:#3b82f6"></i><span style="font-weight:700">${data.imgCount || 0}</span><span style="color:var(--text-muted);font-size:12px">Images</span></div>
              <div style="display:flex;align-items:center;gap:6px"><i class="fas fa-file-word" style="color:#2563eb"></i><span style="font-weight:700">${data.docCount || 0}</span><span style="color:var(--text-muted);font-size:12px">Documents</span></div>
              <div style="display:flex;align-items:center;gap:6px"><i class="fas fa-file-powerpoint" style="color:#f97316"></i><span style="font-weight:700">${data.pptCount || 0}</span><span style="color:var(--text-muted);font-size:12px">Presentations</span></div>
            </div>
          </div>
          ${adminTools}
        `;

        if (state.role === 'admin') {
          bindAdminDashboardEventsOnce();
          appendAdminTerminalLine('Safe terminal ready. Type "help" for commands.', 'info');
          appendAdminSandboxLine('Sandbox terminal ready. Type "help".', 'info');
          refreshAdminAccounts();
        }
      } catch {}
    }

    // ===== VIEW MODE =====
    function setViewMode(mode) {
      state.viewMode = mode;
      localStorage.setItem('viewMode', mode);
      $('viewGrid').classList.toggle('active', mode === 'grid');
      $('viewList').classList.toggle('active', mode === 'list');
      renderFiles();
    }

    // ===== EASTER EGGS =====
    // Konami Code
    document.addEventListener('keydown', (e) => {
      if (e.keyCode === konamiCode[state.konamiIndex]) {
        state.konamiIndex++;
        if (state.konamiIndex === konamiCode.length) {
          state.konamiIndex = 0;
          activateMatrixRain();
          toast('ðŸŽ® KONAMI CODE ACTIVATED! Matrix mode!', 'success');
        }
      } else {
        state.konamiIndex = 0;
      }
    });

    // Logo click counter
    $('logo').addEventListener('click', () => {
      state.logoClicks++;
      if (state.logoClicks === 7) {
        spawnConfetti();
        toast('ðŸŽ‰ You found an Easter egg! 7 clicks!', 'success');
        document.querySelector('.logo-icon').style.background = 'linear-gradient(135deg, #ff0080, #ff8c00, #40e0d0)';
      }
      if (state.logoClicks === 20) {
        toast('ðŸ¤¯ 20 clicks?! You really like clicking!', 'warning');
        document.querySelector('.app').classList.add('shake');
        setTimeout(() => document.querySelector('.app').classList.remove('shake'), 500);
      }
      if (state.logoClicks === 42) {
        toast('ðŸŒŒ 42 â€” The answer to everything!', 'info');
      }
    });

    async function fetchSecret() {
      try {
        const res = await authFetch('/api/secret');
        const data = await res.json();
        toast(data.message, 'info');
      } catch {}
    }

    function openRandom() {
      if (state.filteredFiles.length === 0) {
        toast('No files to open', 'warning');
        return;
      }
      const f = state.filteredFiles[Math.floor(Math.random() * state.filteredFiles.length)];
      openFile(f.name);
      toast(`Random pick: ${f.name}`, 'info');
    }

    // Matrix rain
    function activateMatrixRain() {
      const canvas = el.matrixCanvas;
      canvas.style.display = 'block';
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const ctx = canvas.getContext('2d');
      const cols = Math.floor(canvas.width / 14);
      const drops = Array(cols).fill(1);
      const chars = 'QuantumTunneling0123456789Prenxy@#$%^&*()ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³';

      let frameCount = 0;
      const maxFrames = 300; // ~5 seconds

      function draw() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0f0';
        ctx.font = '14px JetBrains Mono, monospace';

        for (let i = 0; i < drops.length; i++) {
          const char = chars[Math.floor(Math.random() * chars.length)];
          ctx.fillText(char, i * 14, drops[i] * 14);
          if (drops[i] * 14 > canvas.height && Math.random() > 0.975) drops[i] = 0;
          drops[i]++;
        }

        frameCount++;
        if (frameCount < maxFrames) {
          requestAnimationFrame(draw);
        } else {
          canvas.style.display = 'none';
        }
      }
      draw();
    }

    // Confetti
    function spawnConfetti() {
      const colors = ['#7c3aed', '#a855f7', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4'];
      for (let i = 0; i < 80; i++) {
        const conf = document.createElement('div');
        conf.className = 'confetti-piece';
        conf.style.left = Math.random() * 100 + 'vw';
        conf.style.top = '-10px';
        conf.style.background = colors[Math.floor(Math.random() * colors.length)];
        conf.style.width = (Math.random() * 10 + 5) + 'px';
        conf.style.height = (Math.random() * 10 + 5) + 'px';
        conf.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        conf.style.animation = `confettiFall ${Math.random() * 2 + 2}s linear forwards`;
        conf.style.animationDelay = Math.random() * 0.5 + 's';
        document.body.appendChild(conf);
        setTimeout(() => conf.remove(), 4000);
      }
    }

    // ===== GLOBAL DRAG & DROP =====
    let dragCounter = 0;
    document.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragCounter++;
      el.globalDropOverlay.classList.add('active');
    });

    document.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) el.globalDropOverlay.classList.remove('active');
    });

    document.addEventListener('dragover', (e) => e.preventDefault());

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      dragCounter = 0;
      el.globalDropOverlay.classList.remove('active');
      if (e.dataTransfer.files.length) {
        showUploadModal();
        addUploadFiles(e.dataTransfer.files);
      }
    });

    // ===== MINI PLAYER DRAG =====
    let miniDragging = false, miniDragOffset = { x: 0, y: 0 };
    $('miniPlayerHeader').addEventListener('mousedown', (e) => {
      miniDragging = true;
      miniDragOffset.x = e.clientX - el.miniPlayer.offsetLeft;
      miniDragOffset.y = e.clientY - el.miniPlayer.offsetTop;
    });
    document.addEventListener('mousemove', (e) => {
      if (miniDragging) {
        el.miniPlayer.style.left = (e.clientX - miniDragOffset.x) + 'px';
        el.miniPlayer.style.top = (e.clientY - miniDragOffset.y) + 'px';
        el.miniPlayer.style.right = 'auto';
        el.miniPlayer.style.bottom = 'auto';
      }
    });
    document.addEventListener('mouseup', () => miniDragging = false);

    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', (e) => {
      // Don't trigger when typing in inputs
      const tag = e.target.tagName;
      const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

      if (e.key === 'Escape') {
        if ($('themePicker').classList.contains('active')) { $('themePicker').classList.remove('active'); return; }
        if (el.ocrModal.classList.contains('active')) { closeOcrModal(); return; }
        if (el.printModal.classList.contains('active')) { closePrintModal(); return; }
        if (el.imageViewer.classList.contains('active')) { closeImageViewer(); return; }
        if (el.docxViewer.classList.contains('active')) { if (maybeConfirmDocxDiscard()) closeDocxViewer(); return; }
        if (el.viewerOverlay.classList.contains('active')) { closeViewer(); return; }
        if (el.commandPalette.classList.contains('active')) { el.commandPalette.classList.remove('active'); return; }
        if (el.uploadModal.classList.contains('active')) { el.uploadModal.classList.remove('active'); return; }
        if (el.renameModal.classList.contains('active')) { el.renameModal.classList.remove('active'); return; }
        if (el.shortcutsModal.classList.contains('active')) { el.shortcutsModal.classList.remove('active'); return; }
        if (el.statsModal.classList.contains('active')) { el.statsModal.classList.remove('active'); return; }
        if (el.contextMenu.classList.contains('active')) { el.contextMenu.classList.remove('active'); return; }
        if (state.selectedFiles.size > 0) { clearSelection(); return; }
      }

      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        el.searchInput.focus();
        el.searchInput.select();
        return;
      }

      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        openCommandPalette();
        return;
      }

      if ((e.ctrlKey || e.metaKey) && e.key === 'a' && !isInput) {
        e.preventDefault();
        selectAll();
        return;
      }

      // Viewer shortcuts
      if (el.viewerOverlay.classList.contains('active')) {
        if (e.key === 'ArrowLeft') { if (state.currentPage > 1) scrollToPage(state.currentPage - 1); return; }
        if (e.key === 'ArrowRight') { if (state.currentPage < state.totalPages) scrollToPage(state.currentPage + 1); return; }
        if (e.key === '+' || e.key === '=') { state.zoom = Math.min(state.zoom + 0.25, 5); rerenderAllPages(); return; }
        if (e.key === '-') { state.zoom = Math.max(state.zoom - 0.25, 0.25); rerenderAllPages(); return; }
        return;
      }

      if (isInput) return;

      if (e.key === 'u' || e.key === 'U') showUploadModal();
      if (e.key === 't' || e.key === 'T') toggleTheme();
      if (e.key === 'r' || e.key === 'R') { fetchFiles(); toast('Refreshed', 'info'); }
      if (e.key === 'g' || e.key === 'G') setViewMode('grid');
      if (e.key === 'l' || e.key === 'L') setViewMode('list');
      if (e.key === '?' || e.key === '/') el.shortcutsModal.classList.add('active');
    });

    // ===== EVENT LISTENERS =====
    // Search
    el.searchInput.addEventListener('input', () => {
      clearTimeout(state.searchDebounce);
      state.searchDebounce = setTimeout(() => {
        applyFilters();
        renderFiles();
        updateFileCount();
      }, 200);
    });

    // Sort & Filter
    el.sortSelect.addEventListener('change', (e) => {
      state.sortBy = e.target.value;
      localStorage.setItem('sortBy', state.sortBy);
      applyFilters();
      renderFiles();
    });

    el.filterType.addEventListener('change', (e) => {
      state.filterType = e.target.value;
      applyFilters();
      renderFiles();
      updateFileCount();
    });

    // View toggle
    $('viewGrid').addEventListener('click', () => setViewMode('grid'));
    $('viewList').addEventListener('click', () => setViewMode('list'));

    // Toolbar buttons
    $('btnRefresh').addEventListener('click', () => { fetchFiles(); fetchStats(); toast('Refreshed', 'info'); });
    $('btnUpload').addEventListener('click', showUploadModal);
    $('btnTheme').addEventListener('click', toggleTheme);
    $('btnShortcuts').addEventListener('click', () => el.shortcutsModal.classList.add('active'));
    $('btnStats').addEventListener('click', showStatsModal);
    $('btnSelectAll').addEventListener('click', selectAll);
    $('btnBulkDownload').addEventListener('click', bulkDownload);
    $('btnBulkDelete').addEventListener('click', bulkDelete);
    $('btnClearSelection').addEventListener('click', clearSelection);

    // Upload modal
    $('uploadModalClose').addEventListener('click', () => el.uploadModal.classList.remove('active'));
    el.fileInput.addEventListener('change', (e) => addUploadFiles(e.target.files));
    $('btnStartUpload').addEventListener('click', startUpload);

    el.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); el.dropZone.classList.add('dragover'); });
    el.dropZone.addEventListener('dragleave', () => el.dropZone.classList.remove('dragover'));
    el.dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      el.dropZone.classList.remove('dragover');
      addUploadFiles(e.dataTransfer.files);
    });

    // Rename
    $('renameModalClose').addEventListener('click', () => el.renameModal.classList.remove('active'));
    $('renameCancel').addEventListener('click', () => el.renameModal.classList.remove('active'));
    $('renameSave').addEventListener('click', doRename);
    el.renameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doRename(); });

    // Print modal
    $('printModalClose').addEventListener('click', closePrintModal);
    $('printCancelBtn').addEventListener('click', closePrintModal);
    $('printStartBtn').addEventListener('click', () => startPrint(false));
    $('printSaveAsPdfBtn').addEventListener('click', () => startPrint(true));
    el.printPageMode.addEventListener('change', () => {
      el.printCustomPagesWrap.style.display = el.printPageMode.value === 'custom' && state.printTarget && state.printTarget.type === 'pdf' ? '' : 'none';
    });

    // Shortcuts modal
    $('shortcutsModalClose').addEventListener('click', () => el.shortcutsModal.classList.remove('active'));
    $('statsModalClose').addEventListener('click', () => el.statsModal.classList.remove('active'));

    // Viewer controls
    $('viewerClose').addEventListener('click', closeViewer);
    $('viewerPrev').addEventListener('click', () => { if (state.currentPage > 1) scrollToPage(state.currentPage - 1); });
    $('viewerNext').addEventListener('click', () => { if (state.currentPage < state.totalPages) scrollToPage(state.currentPage + 1); });
    el.viewerPageInput.addEventListener('change', () => {
      const p = parseInt(el.viewerPageInput.value);
      if (p >= 1 && p <= state.totalPages) scrollToPage(p);
    });
    $('viewerZoomIn').addEventListener('click', () => { state.zoom = Math.min(state.zoom + 0.25, 5); rerenderAllPages(); });
    $('viewerZoomOut').addEventListener('click', () => { state.zoom = Math.max(state.zoom - 0.25, 0.25); rerenderAllPages(); });
    $('viewerFitWidth').addEventListener('click', () => {
      if (state.pageViewports && state.pageViewports.length > 0) {
        const containerWidth = el.viewerCanvasContainer.clientWidth - 80;
        const nativeWidth = state.pageViewports[0].width;
        state.zoom = Math.min(Math.max(containerWidth / nativeWidth, 0.25), 5.0);
        rerenderAllPages();
      }
    });
    $('viewerRotate').addEventListener('click', async () => {
      state.rotation = (state.rotation + 90) % 360;
      // Recompute base viewports for new rotation
      if (state.pdfDoc && state.pageViewports.length > 0) {
        for (let i = 0; i < state.totalPages; i++) {
          const page = await state.pdfDoc.getPage(i + 1);
          state.pageViewports[i] = page.getViewport({ scale: 1.0, rotation: state.rotation });
        }
      }
      rerenderAllPages();
    });
    $('viewerSidebar').addEventListener('click', () => el.viewerSidebarPanel.classList.toggle('visible'));
    $('viewerPiP').addEventListener('click', openMiniPlayer);
    $('viewerOCR').addEventListener('click', openOcrModal);
    $('viewerPrint').addEventListener('click', () => openPrintModal('pdf'));
    $('viewerDownload').addEventListener('click', () => { if (state.currentPdf) downloadFile(state.currentPdf); });

    // Viewer Ctrl+scroll zoom with scroll-position preservation
    el.viewerCanvasContainer.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        const delta = e.deltaY < 0 ? 0.1 : -0.1;
        state.zoom = Math.min(Math.max(state.zoom + delta, 0.25), 5.0);
        rerenderAllPages();
      }
    }, { passive: false });

    // Pinch-to-zoom on touch devices
    let _pinchStartDist = 0;
    let _pinchStartZoom = 1.0;

    el.viewerCanvasContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        _pinchStartDist = Math.sqrt(dx * dx + dy * dy);
        _pinchStartZoom = state.zoom;
      }
    }, { passive: false });

    el.viewerCanvasContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2 && _pinchStartDist > 0) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const scale = dist / _pinchStartDist;
        state.zoom = Math.min(Math.max(_pinchStartZoom * scale, 0.25), 5.0);
        rerenderAllPages();
      }
    }, { passive: false });

    el.viewerCanvasContainer.addEventListener('touchend', () => {
      _pinchStartDist = 0;
    });

    // Mini player
    $('miniClose').addEventListener('click', closeMiniPlayer);

    // Image viewer controls
    $('imgViewerClose').addEventListener('click', closeImageViewer);
    $('imgZoomIn').addEventListener('click', imgZoomIn);
    $('imgZoomOut').addEventListener('click', imgZoomOut);
    $('imgRotate').addEventListener('click', imgRotate);
    $('imgFitScreen').addEventListener('click', imgFitScreen);
    $('imgOpenTab').addEventListener('click', () => { if (state.imgViewerFile) window.open(getDocUrl(state.imgViewerFile), '_blank'); });
    $('imgDownload').addEventListener('click', () => { if (state.imgViewerFile) downloadFile(state.imgViewerFile); });
    $('imgPrev').addEventListener('click', () => imgNavigateGallery(-1));
    $('imgNext').addEventListener('click', () => imgNavigateGallery(1));

    // Image viewer wheel zoom
    el.imgViewerBody.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        if (e.deltaY < 0) imgZoomIn(); else imgZoomOut();
      }
    }, { passive: false });

    // Image viewer keyboard nav
    document.addEventListener('keydown', (e) => {
      if (!el.imageViewer.classList.contains('active')) return;
      if (e.key === 'ArrowLeft') imgNavigateGallery(-1);
      if (e.key === 'ArrowRight') imgNavigateGallery(1);
      if (e.key === '+' || e.key === '=') imgZoomIn();
      if (e.key === '-') imgZoomOut();
      if (e.key === 'r' || e.key === 'R') imgRotate();
      if (e.key === '0') imgFitScreen();
    });

    // DOCX viewer controls
    $('docxViewerClose').addEventListener('click', () => {
      if (maybeConfirmDocxDiscard()) closeDocxViewer();
    });
    $('docxPrint').addEventListener('click', () => openPrintModal('docx'));
    $('docxSavePdf').addEventListener('click', async () => {
      if (!state.docxViewerFile) return;
      try {
        await saveDocxAsPdf(state.docxViewerFile);
      } catch (e) {
        toast(e.message || 'Save as PDF failed', 'error');
      }
    });
    $('docxEditToggle').addEventListener('click', () => setDocxEditing(!state.docxEditing));
    $('docxExportHtml').addEventListener('click', exportEditedDocxHtml);
    $('docxOpenTab').addEventListener('click', () => { if (state.docxViewerFile) window.open(getDocUrl(state.docxViewerFile), '_blank'); });
    $('docxDownload').addEventListener('click', () => { if (state.docxViewerFile) downloadFile(state.docxViewerFile); });
    $('docxBlockFormat').addEventListener('change', (e) => applyDocxCommand('formatBlock', e.target.value));
    $('docxForeColor').addEventListener('input', (e) => applyDocxCommand('foreColor', e.target.value));
    $('docxBackColor').addEventListener('input', (e) => applyDocxCommand('hiliteColor', e.target.value));
    $('docxLinkBtn').addEventListener('click', () => {
      if (!state.docxEditing) return;
      const url = prompt('Enter URL');
      if (url) applyDocxCommand('createLink', url);
    });
    document.querySelectorAll('.docx-tool-btn[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => applyDocxCommand(btn.dataset.cmd));
    });
    el.docxContent.addEventListener('input', () => {
      if (state.docxEditing) state.docxDirty = true;
    });
    $('miniExpand').addEventListener('click', () => {
      if (state.miniPdf && state.currentPdf) {
        closeMiniPlayer();
        // Reopen in full viewer
        state.pdfDoc = state.miniPdf;
        state.currentPage = state.miniPage;
        state.totalPages = state.miniPdf.numPages;
        el.viewerOverlay.classList.add('active');
        el.viewerTitle.textContent = state.currentPdf;
        el.viewerTotalPages.textContent = state.totalPages;
        el.viewerPageInput.max = state.totalPages;
        el.viewerLoading.style.display = 'none';
        document.body.style.overflow = 'hidden';
        renderAllPages();
        generateViewerThumbnails();
        setupScrollTracking();
      }
    });
    $('miniPrev').addEventListener('click', () => {
      if (state.miniPage > 1) { state.miniPage--; renderMiniPage(); }
    });
    $('miniNext').addEventListener('click', () => {
      if (state.miniPdf && state.miniPage < state.miniPdf.numPages) { state.miniPage++; renderMiniPage(); }
    });
    $('miniDownload').addEventListener('click', () => { if (state.currentPdf) downloadFile(state.currentPdf); });

    // FAB
    $('fabBtn').addEventListener('click', () => el.fabMenu.classList.toggle('open'));
    $('fabUpload').addEventListener('click', () => { el.fabMenu.classList.remove('open'); showUploadModal(); });
    $('fabTheme').addEventListener('click', () => { el.fabMenu.classList.remove('open'); toggleTheme(); });
    $('fabTop').addEventListener('click', () => { el.fabMenu.classList.remove('open'); window.scrollTo({ top: 0, behavior: 'smooth' }); });
    $('fabRandom').addEventListener('click', () => { el.fabMenu.classList.remove('open'); openRandom(); });

    // Command palette
    el.commandInput.addEventListener('input', (e) => renderCommands(e.target.value));
    el.commandInput.addEventListener('keydown', (e) => {
      const items = el.commandResults.querySelectorAll('.command-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const idx = Math.min((el.commandPalette._activeIdx || 0) + 1, items.length - 1);
        el.commandPalette._activeIdx = idx;
        items.forEach((it, i) => it.classList.toggle('active', i === idx));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const idx = Math.max((el.commandPalette._activeIdx || 0) - 1, 0);
        el.commandPalette._activeIdx = idx;
        items.forEach((it, i) => it.classList.toggle('active', i === idx));
      } else if (e.key === 'Enter') {
        const cmds = el.commandPalette._commands;
        const idx = el.commandPalette._activeIdx || 0;
        if (cmds && cmds[idx]) {
          el.commandPalette.classList.remove('active');
          cmds[idx].action();
        }
      }
    });

    // Close overlays on backdrop click
    el.commandPalette.addEventListener('click', (e) => {
      if (e.target === el.commandPalette) el.commandPalette.classList.remove('active');
    });
    el.uploadModal.addEventListener('click', (e) => {
      if (e.target === el.uploadModal) el.uploadModal.classList.remove('active');
    });
    el.renameModal.addEventListener('click', (e) => {
      if (e.target === el.renameModal) el.renameModal.classList.remove('active');
    });
    el.ocrModal.addEventListener('click', (e) => {
      if (e.target === el.ocrModal) closeOcrModal();
    });
    el.printModal.addEventListener('click', (e) => {
      if (e.target === el.printModal) closePrintModal();
    });
    el.shortcutsModal.addEventListener('click', (e) => {
      if (e.target === el.shortcutsModal) el.shortcutsModal.classList.remove('active');
    });
    el.statsModal.addEventListener('click', (e) => {
      if (e.target === el.statsModal) el.statsModal.classList.remove('active');
    });
    el.docxViewer.addEventListener('click', (e) => {
      if (e.target === el.docxViewer && maybeConfirmDocxDiscard()) closeDocxViewer();
    });

    // Close context menu
    document.addEventListener('click', () => el.contextMenu.classList.remove('active'));
    document.querySelector('.toolbar').addEventListener('contextmenu', showToolbarContextMenu);
    el.contentArea.addEventListener('contextmenu', (e) => {
      if (e.target.closest('.file-card') || e.target.closest('.file-list-item')) return;
      showBlankSpaceContextMenu(e);
    });

    // OCR modal controls
    $('ocrModalClose').addEventListener('click', closeOcrModal);
    $('ocrRunBtn').addEventListener('click', runPdfOcr);
    $('ocrCopyBtn').addEventListener('click', copyOcrText);
    $('ocrDownloadBtn').addEventListener('click', downloadOcrText);

    // Theme picker
    $('themePickerClose').addEventListener('click', () => $('themePicker').classList.remove('active'));
    $('themePicker').addEventListener('click', (e) => {
      if (e.target === $('themePicker')) $('themePicker').classList.remove('active');
    });

    // Block browser zoom (Ctrl+/-, Ctrl+wheel, Ctrl+0)
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')) {
        // Allow when image viewer is active (for our built-in zoom)
        if (!el.imageViewer.classList.contains('active')) {
          e.preventDefault();
        }
      }
    });
    document.addEventListener('wheel', (e) => {
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
      }
    }, { passive: false });

    // ===== PUBLIC API =====
    function openClassroomFile(filename) {
      // Open classroom file in a new tab (since it's from admin's folder)
      const url = getClassroomDocUrl(filename);
      window.open(url, '_blank');
    }

    function downloadClassroomFile(filename) {
      const url = getClassroomDownloadUrl(filename);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }

    window.app = {
      openFile, downloadFile, deleteFile, toggleSelect, toggleFav,
      showContextMenu, showRename, toast, executeCommand, fetchSecret,
      selectTheme,
      openPrintForCurrent: openPrintModal,
      openOcrForCurrentPdf: openOcrModal,
      refreshFiles: () => { fetchFiles(); fetchStats(); toast('Refreshed', 'info'); },
      showUpload: showUploadModal,
      openRandomDoc: openRandom,
      setGridView: () => setViewMode('grid'),
      setListView: () => setViewMode('list'),
      showStatsPanel: showStatsModal,
      showThemePicker: toggleTheme,
      selectAllFiles: selectAll,
      clearSelectedFiles: clearSelection,
      shareToClassroom,
      unshareFromClassroom,
      toggleClassroom,
      openClassroomFile,
      downloadClassroomFile,
      adminCreateAccount: createManagedAccountFromDashboard,
      adminRefreshAccounts: refreshAdminAccounts,
      adminOpenApp: openAdminApp,
      adminRunSafeCommand: runAdminTerminalCommand,
      adminRunSandboxCommand: runAdminSandboxCommand,
      adminRunTerminalFromInput: () => {
        const input = $('adminTerminalInput');
        if (!input) return;
        const value = input.value;
        input.value = '';
        runAdminTerminalCommand(value);
      },
      adminRunSandboxFromInput: () => {
        const input = $('adminSandboxInput');
        if (!input) return;
        const value = input.value;
        input.value = '';
        runAdminSandboxCommand(value);
      },
      saveDocAsPdf: async (name) => {
        try {
          await saveDocxAsPdf(name);
        } catch (e) {
          toast(e.message || 'Save as PDF failed', 'error');
        }
      },
    };

    // ===== INIT =====
    setTheme(state.theme);
    setViewMode(state.viewMode);
    el.sortSelect.value = state.sortBy;

    // Auth: Login is now handled on the hub page (index.html)

    // Auth: Logout handler â€” redirect to hub
    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await fetch('/api/auth/logout', { method: 'POST', headers: authHeaders() }); } catch {}
      clearAuthToken();
      window.location.href = '/';
    });

    // Auth: Verify on load â€” redirect to hub if not authenticated
    (async () => {
      const ok = await verifyAuth();
      if (!ok) { window.location.href = '/'; return; }
      document.getElementById('userBadgeName').textContent = getAuthUser();
      fetchFiles();
      fetchStats();
    })();

    setInterval(() => { if (getAuthToken()) fetchStats(); }, 30000);

    // Console Easter Egg
    console.log('%câš› Prenxy PDF+ v2.5', 'font-size:24px;font-weight:bold;background:linear-gradient(135deg,#7c3aed,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent');
    console.log('%cðŸ¥š Try the Konami Code: â†‘â†‘â†“â†“â†â†’â†â†’BA', 'font-size:14px;color:#a855f7');
    console.log('%cðŸŽ¯ Click the logo 7 times for a surprise!', 'font-size:14px;color:#3b82f6');
    console.log('%cðŸ”® Ctrl+P opens the command palette', 'font-size:14px;color:#10b981');
    console.log('%cðŸ’¡ GET /api/secret for wisdom', 'font-size:14px;color:#f59e0b');

  })();
  </script>
</body>
</html>
