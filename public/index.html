<!DOCTYPE html>
<html lang="en" data-theme="liquid-glass">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Prenxy Study Hub</title>
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/shared.css">
  <style>
    body { display: flex; flex-direction: column; min-height: 100vh; }

    /* ═══ LOGIN ═══ */
    .login-screen {
      flex: 1; display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .login-card {
      width: 400px; max-width: 95vw; background: var(--bg-secondary);
      border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 48px 36px 36px; text-align: center;
      box-shadow: var(--shadow-lg); position: relative; overflow: hidden;
    }
    .login-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: var(--accent-gradient);
    }
    .login-logo { font-size: 52px; margin-bottom: 8px; }
    .login-logo i { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .login-title { font-size: 24px; font-weight: 800; margin-bottom: 4px; }
    .login-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 28px; }
    .field { text-align: left; margin-bottom: 16px; }
    .field label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 6px; }
    .login-btn {
      width: 100%; padding: 13px; margin-top: 8px;
      background: var(--accent-gradient); color: #fff; border: none;
      border-radius: var(--radius-sm); font-size: 15px; font-weight: 700;
      font-family: inherit; cursor: pointer; transition: opacity 0.2s;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .login-error { color: var(--danger); font-size: 13px; margin-top: 12px; min-height: 18px; }
    .login-footer { margin-top: 24px; font-size: 11px; color: var(--text-muted); }

    /* ═══ HUB ═══ */
    .hub { flex: 1; display: none; flex-direction: column; }
    .hub.active { display: flex; }
    .hub-content { flex: 1; padding: 40px 24px; max-width: 1100px; margin: 0 auto; width: 100%; }
    .hub-greeting { font-size: 28px; font-weight: 300; margin-bottom: 4px; color: var(--text-primary); }
    .hub-greeting strong { font-weight: 800; }
    .hub-handle { font-size: 14px; color: var(--text-muted); margin-bottom: 40px; }
    .hub-section { margin-bottom: 40px; }
    .hub-section h2 { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }

    /* App cards */
    .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .app-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 28px 24px;
      cursor: pointer; transition: var(--transition); text-decoration: none;
      display: flex; align-items: flex-start; gap: 20px;
      position: relative; overflow: hidden;
    }
    .app-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--border-hover); text-decoration: none; }
    .app-card .icon-wrap {
      width: 56px; height: 56px; border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: #fff; flex-shrink: 0;
    }
    .app-card .info { flex: 1; }
    .app-card .info h3 { font-size: 17px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
    .app-card .info p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
    .card-drive .icon-wrap { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .card-social .icon-wrap { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .card-chat .icon-wrap { background: linear-gradient(135deg, #10b981, #059669); }
    .card-terminal .icon-wrap { background: linear-gradient(135deg, #0f172a, #334155); }
    .card-vm .icon-wrap { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .card-offers .icon-wrap { background: linear-gradient(135deg, #ec4899, #db2777); }
    .card-resources .icon-wrap { background: linear-gradient(135deg, #06b6d4, #0891b2); }

    /* ═══ PROFILE SECTION ═══ */
    .profile-section {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 24px; display: flex; gap: 20px;
      align-items: center; flex-wrap: wrap;
    }
    .profile-avatar-wrap { position: relative; cursor: pointer; }
    .profile-avatar-wrap:hover .avatar-edit { opacity: 1; }
    .avatar-edit {
      position: absolute; inset: 0; background: rgba(0,0,0,0.5);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 16px; opacity: 0; transition: opacity 0.2s;
    }
    .profile-info { flex: 1; min-width: 200px; }
    .profile-info .name { font-size: 20px; font-weight: 700; }
    .profile-info .handle { font-size: 14px; color: var(--text-muted); }
    .profile-info .role { display: inline-block; padding: 2px 10px; font-size: 11px; font-weight: 600; border-radius: 99px; margin-top: 6px; text-transform: uppercase; }
    .role-admin { background: rgba(239,68,68,0.15); color: var(--danger); }
    .role-student { background: rgba(59,130,246,0.15); color: var(--info); }
    .profile-edit { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
    .profile-edit .field { margin-bottom: 0; flex: 1; min-width: 150px; }
    .profile-edit input { padding: 8px 12px; font-size: 13px; }

    /* ═══ ADMIN PANEL ═══ */
    .admin-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; }
    .admin-panel h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .create-user-form { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .create-user-form input { flex: 1; min-width: 140px; padding: 10px 12px; }
    .user-list { display: flex; flex-direction: column; gap: 8px; }
    .user-row {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      background: var(--bg-tertiary); border-radius: var(--radius-sm);
    }
    .user-row .name { font-weight: 600; font-size: 14px; flex: 1; }
    .user-row .handle { font-size: 12px; color: var(--text-muted); }
    .user-row .del-btn {
      background: none; border: 1px solid var(--danger); color: var(--danger);
      padding: 4px 10px; border-radius: var(--radius-sm); font-size: 11px;
      cursor: pointer; font-family: inherit;
    }
    .user-row .del-btn:hover { background: var(--danger); color: #fff; }

    /* Approvals */
    .approval-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 8px;
    }
    .approval-item .meta { flex: 1; }
    .approval-item .meta .type { font-weight: 600; font-size: 13px; text-transform: capitalize; }
    .approval-item .meta .detail { font-size: 12px; color: var(--text-muted); }
    .approval-btns { display: flex; gap: 6px; }
    .approval-btns button { padding: 5px 12px; border: none; border-radius: var(--radius-sm); font-size: 12px; font-family: inherit; cursor: pointer; font-weight: 600; }
    .approve-btn { background: var(--success); color: #fff; }
    .reject-btn { background: var(--danger); color: #fff; }
    .review-btn { background: var(--info); color: #fff; }
    .no-items { font-size: 13px; color: var(--text-muted); padding: 12px; text-align: center; }

    /* ═══ TERMINAL APP ═══ */
    .terminal-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
      box-shadow: var(--shadow-sm);
    }
    .terminal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .terminal-head h3 {
      font-size: 16px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .terminal-output {
      min-height: 300px;
      max-height: 420px;
      overflow: auto;
      border: 1px solid rgba(148,163,184,.26);
      border-radius: 12px;
      background: #020617;
      color: #cbd5e1;
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.45;
      padding: 10px;
      margin-bottom: 10px;
    }
    .terminal-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .terminal-prompt {
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      color: var(--text-muted);
      min-width: 32px;
      white-space: nowrap;
    }
    .terminal-input {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px;
      outline: none;
    }
    .terminal-input:focus {
      border-color: var(--accent-primary);
    }
    .terminal-shortcuts {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    .terminal-shortcuts .btn {
      padding: 6px 10px;
      font-size: 11px;
    }
    .terminal-editor {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg-secondary);
      padding: 10px;
      display: none;
    }
    .terminal-editor.active { display: block; }
    .terminal-editor-toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .terminal-editor-path {
      flex: 1;
      min-width: 220px;
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      padding: 8px 10px;
    }
    .terminal-editor-status {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .terminal-editor-text {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.45;
      background: #020617;
      color: #cbd5e1;
      border: 1px solid rgba(148,163,184,.26);
      border-radius: 10px;
      padding: 10px;
    }

    /* ═══ APP PANELS (VM, Offers, Resources) ═══ */
    .app-panel {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 28px 24px;
      box-shadow: var(--shadow-sm);
    }
    .app-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .app-panel-header h3 {
      font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px; margin: 0;
    }
    .app-panel-desc {
      font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5;
    }
    .app-panel .back-btn {
      background: var(--bg-tertiary); border: 1px solid var(--border);
      color: var(--text-secondary); padding: 8px 16px; border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
      display: flex; align-items: center; gap: 6px; transition: var(--transition);
    }
    .app-panel .back-btn:hover { background: var(--bg-hover); }

    /* Resource / VM / Offer grid */
    .resource-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    .resource-card {
      background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 20px;
      transition: var(--transition); cursor: default;
    }
    .resource-card:hover { border-color: var(--border-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .resource-card .rc-icon {
      width: 44px; height: 44px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #fff; margin-bottom: 12px;
    }
    .resource-card h4 { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
    .resource-card .rc-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
    .resource-card .rc-badge {
      display: inline-block; padding: 2px 8px; border-radius: 99px;
      font-size: 10px; font-weight: 700; margin-top: 10px; text-transform: uppercase;
    }
    .rc-badge.active { background: rgba(16,185,129,.15); color: var(--success); }
    .rc-badge.coming { background: rgba(245,158,11,.15); color: var(--warning); }
    .rc-badge.free { background: rgba(59,130,246,.15); color: var(--info); }
    .rc-badge.hot { background: rgba(239,68,68,.15); color: var(--danger); }

    /* Classroom file list */
    .classroom-section {
      margin-top: 24px; padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .classroom-section h4 {
      font-size: 15px; font-weight: 700; margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px;
    }
    .classroom-files { display: flex; flex-direction: column; gap: 8px; }
    .classroom-file {
      display: flex; align-items: center; gap: 14px; padding: 12px 16px;
      background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: var(--radius-sm); transition: var(--transition); cursor: pointer;
    }
    .classroom-file:hover { border-color: var(--border-hover); background: var(--bg-hover); }
    .classroom-file .cf-icon {
      width: 38px; height: 38px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0;
    }
    .classroom-file .cf-info { flex: 1; min-width: 0; }
    .classroom-file .cf-name { font-size: 14px; font-weight: 600; }
    .classroom-file .cf-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .section-tabs {
      display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .section-tab {
      padding: 8px 18px; border-radius: 99px; font-size: 13px; font-weight: 600;
      background: var(--bg-tertiary); border: 1px solid var(--border);
      color: var(--text-secondary); cursor: pointer; font-family: inherit;
      transition: var(--transition);
    }
    .section-tab:hover { background: var(--bg-hover); }
    .section-tab.active { background: var(--accent-primary); color: #fff; border-color: var(--accent-primary); }

    /* ═══ THEME PICKER (on hub) ═══ */
    .theme-bar { display: flex; gap: 6px; flex-wrap: wrap; }
    .theme-dot {
      width: 28px; height: 28px; border-radius: 50%;
      border: 2px solid var(--border); cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }
    .theme-dot:hover { transform: scale(1.2); }
    .theme-dot.active { border-color: var(--accent-primary); transform: scale(1.15); box-shadow: 0 0 8px var(--accent-glow); }

    /* ===== 2026 DESKTOP REMASTER ===== */
    @keyframes hubFadeUp {
      from { opacity: 0; transform: translateY(14px) scale(.99); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes hubGlowDrift {
      0%, 100% { transform: translate3d(0,0,0) scale(1); opacity: .34; }
      50% { transform: translate3d(0,-18px,0) scale(1.1); opacity: .52; }
    }
    @media (min-width: 980px) {
      body::before,
      body::after {
        content: '';
        position: fixed;
        pointer-events: none;
        z-index: -1;
        border-radius: 50%;
        filter: blur(72px);
        animation: hubGlowDrift 11s ease-in-out infinite;
      }
      body::before {
        width: 340px;
        height: 340px;
        top: 60px;
        right: -120px;
        background: radial-gradient(circle, rgba(56,189,248,.26), rgba(56,189,248,0) 72%);
      }
      body::after {
        width: 360px;
        height: 360px;
        left: -120px;
        bottom: 60px;
        background: radial-gradient(circle, rgba(16,185,129,.2), rgba(16,185,129,0) 72%);
        animation-delay: -4s;
      }
      .top-bar {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(18px) saturate(130%);
        -webkit-backdrop-filter: blur(18px) saturate(130%);
        border-bottom: 1px solid color-mix(in srgb, var(--border), #7dd3fc 18%);
        background: color-mix(in srgb, var(--bg-primary), transparent 18%);
      }
      .hub-content {
        max-width: 1220px;
        padding: 44px 28px 62px;
      }
      .hub-greeting {
        font-size: 36px;
        letter-spacing: .2px;
      }
      .hub-handle {
        margin-bottom: 34px;
      }
      .hub-section {
        margin-bottom: 34px;
        animation: hubFadeUp .48s ease both;
      }
      .hub-section:nth-child(2) { animation-delay: .04s; }
      .hub-section:nth-child(3) { animation-delay: .08s; }
      .hub-section:nth-child(4) { animation-delay: .12s; }
      .app-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 18px;
      }
      .app-card {
        border-width: 1.5px;
        border-radius: 20px;
        padding: 26px 22px;
        box-shadow: 0 14px 30px rgba(2, 6, 23, .16);
      }
      .app-card::after {
        content: '';
        position: absolute;
        inset: auto -30% -62% -30%;
        height: 130px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.16), transparent);
        transform: rotate(8deg);
        opacity: 0;
        transition: opacity .24s ease;
      }
      .app-card:hover {
        transform: translateY(-7px) scale(1.01);
        box-shadow: 0 20px 40px rgba(2, 6, 23, .24);
      }
      .app-card:hover::after { opacity: 1; }
      .app-card .icon-wrap {
        width: 62px;
        height: 62px;
        font-size: 26px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,.3), 0 12px 24px rgba(2, 6, 23, .24);
      }
      .profile-section,
      .admin-panel,
      .login-card {
        border-width: 1.5px;
        box-shadow: 0 18px 38px rgba(2, 6, 23, .2);
      }
      .profile-section {
        border-radius: 22px;
        padding: 24px;
      }
      .admin-panel {
        border-radius: 22px;
      }
      .create-user-form input,
      .profile-edit input,
      .field input {
        border-width: 1.5px;
        transition: border-color .2s ease, box-shadow .2s ease, transform .16s ease;
      }
      .create-user-form input:focus,
      .profile-edit input:focus,
      .field input:focus {
        border-color: color-mix(in srgb, var(--accent-primary), white 20%);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary), transparent 76%);
        outline: none;
      }
      .btn,
      .btn-icon,
      .login-btn {
        transition: transform .16s ease, box-shadow .22s ease, filter .2s ease;
      }
      .btn:hover,
      .btn-icon:hover,
      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(2, 6, 23, .2);
      }
      .user-row,
      .approval-item {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: linear-gradient(160deg, color-mix(in srgb, var(--bg-tertiary), white 4%), var(--bg-tertiary));
      }
    }
  </style>
</head>
<body>
  <!-- login screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo"><i class="fas fa-atom"></i></div>
      <div class="login-title">Prenxy Study Hub</div>
      <div class="login-sub">Sign in to access your workspace</div>
      <form id="loginForm" autocomplete="off">
        <div class="field">
          <label for="loginUser">Username</label>
          <input type="text" id="loginUser" placeholder="Enter your username" required autofocus>
        </div>
        <div class="field">
          <label for="loginPass">Password</label>
          <input type="password" id="loginPass" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="login-btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Sign In</button>
        <div class="login-error" id="loginError"></div>
      </form>
      <div class="login-footer"><i class="fas fa-lock"></i> Secured with AES-256 encryption</div>
    </div>
  </div>

  <!-- hub (shown after login) -->
  <div class="hub" id="hub">
    <!-- top bar -->
    <div class="top-bar">
      <div class="left">
        <a class="logo-link" href="/"><i class="fas fa-atom"></i> Prenxy</a>
      </div>
      <div class="right">
        <div class="theme-bar" id="themeBar"></div>
        <div class="user-chip" id="userChip">
          <div class="avatar sm" id="topAvatar"></div>
          <span id="topName">user</span>
        </div>
        <button class="btn-icon" id="btnLogout" title="Sign Out"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="hub-content">
      <!-- greeting -->
      <div class="hub-greeting" id="hubGreeting">Welcome, <strong>User</strong></div>
      <div class="hub-handle" id="hubHandle">@user</div>

      <!-- apps -->
      <div class="hub-section">
        <h2><i class="fas fa-th-large"></i> Your Apps</h2>
        <div class="app-grid">
          <a class="app-card card-drive" href="/drive.html">
            <div class="icon-wrap"><i class="fas fa-folder-open"></i></div>
            <div class="info">
              <h3>Prenxy Drive</h3>
              <p>Upload, view & manage your documents, PDFs, and images.</p>
            </div>
          </a>
          <a class="app-card card-social" href="/social.html">
            <div class="icon-wrap"><i class="fas fa-users"></i></div>
            <div class="info">
              <h3>Prenxy Social</h3>
              <p>Post updates, comment, and react with your peers.</p>
            </div>
          </a>
          <a class="app-card card-chat" href="/chat.html">
            <div class="icon-wrap"><i class="fas fa-comments"></i></div>
            <div class="info">
              <h3>Prenxy Chat</h3>
              <p>Direct messaging with classmates and instructors.</p>
            </div>
          </a>
          <a class="app-card card-terminal" href="#" id="appTerminal">
            <div class="icon-wrap"><i class="fas fa-terminal"></i></div>
            <div class="info">
              <h3>Terminal</h3>
              <p>Sandboxed admin terminal for safe file operations.</p>
            </div>
          </a>
          <a class="app-card card-vm" href="/vm.html">
            <div class="icon-wrap"><i class="fas fa-cubes"></i></div>
            <div class="info">
              <h3>VM</h3>
              <p>Virtual machine workspace app (coming soon).</p>
            </div>
          </a>
          <a class="app-card card-offers" href="/offers.html">
            <div class="icon-wrap"><i class="fas fa-tags"></i></div>
            <div class="info">
              <h3>Offers</h3>
              <p>Special plans, bundles, and classroom deals.</p>
            </div>
          </a>
          <a class="app-card card-resources" href="/resources.html">
            <div class="icon-wrap"><i class="fas fa-graduation-cap"></i></div>
            <div class="info">
              <h3>Student Resources</h3>
              <p>Learning packs, notes, and quick references.</p>
            </div>
          </a>
        </div>
      </div>

      <!-- terminal app -->
      <div class="hub-section" id="terminalSection" style="display:none">
        <h2><i class="fas fa-terminal"></i> Terminal App</h2>
        <div class="terminal-panel">
          <div class="terminal-head">
            <h3><i class="fas fa-shield-alt"></i> Sandbox Terminal</h3>
            <button class="btn" id="btnTerminalClear"><i class="fas fa-eraser"></i> Clear</button>
          </div>
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">Safe sandbox only. No shell execution, no sudo, no system access.</div>
          <div class="terminal-output" id="terminalOutput"></div>
          <div class="terminal-row">
            <span class="terminal-prompt" id="terminalPrompt">/</span>
            <input class="terminal-input" id="terminalInput" placeholder='Try: help | tree . 2 | grep notes/todo.txt task | tail notes/todo.txt 20' />
            <button class="btn btn-primary" id="btnTerminalRun"><i class="fas fa-play"></i> Run</button>
          </div>
          <div class="terminal-shortcuts">
            <button class="btn" data-term-cmd="help">help</button>
            <button class="btn" data-term-cmd="pwd">pwd</button>
            <button class="btn" data-term-cmd="ls">ls</button>
            <button class="btn" data-term-cmd="history 20">history</button>
            <button class="btn" data-term-cmd="tree . 2">tree</button>
            <button class="btn" data-term-cmd="clear">clear</button>
            <button class="btn" id="btnEditorToggle"><i class="fas fa-pen"></i> Mini Editor</button>
          </div>
          <div class="terminal-editor" id="terminalEditor">
            <div class="terminal-editor-toolbar">
              <input id="terminalEditorPath" class="terminal-editor-path" placeholder="file path, e.g. notes/todo.txt">
              <button class="btn" id="btnEditorOpen"><i class="fas fa-folder-open"></i> Open</button>
              <button class="btn" id="btnEditorNew"><i class="fas fa-file"></i> New</button>
              <button class="btn btn-primary" id="btnEditorSave"><i class="fas fa-save"></i> Save</button>
              <button class="btn" id="btnEditorClose"><i class="fas fa-times"></i> Close</button>
            </div>
            <div class="terminal-editor-status" id="terminalEditorStatus">Editor ready.</div>
            <textarea id="terminalEditorText" class="terminal-editor-text" spellcheck="false"></textarea>
          </div>
        </div>
      </div>

      <!-- profile -->
      <div class="hub-section">
        <h2><i class="fas fa-user-cog"></i> Your Profile</h2>
        <div class="profile-section">
          <div class="profile-avatar-wrap" id="avatarWrap">
            <div class="avatar xl" id="profileAvatar"></div>
            <div class="avatar-edit"><i class="fas fa-camera"></i></div>
            <input type="file" id="avatarInput" accept="image/*" hidden>
          </div>
          <div class="profile-info">
            <div class="name" id="profileName">User</div>
            <div class="handle" id="profileHandle">@user</div>
            <div class="role" id="profileRole">user</div>
          </div>
          <div class="profile-edit">
            <div class="field"><label>Display Name</label><input type="text" id="editName" maxlength="50"></div>
            <div class="field"><label>Handle</label><input type="text" id="editHandle" maxlength="30" placeholder="@handle"></div>
            <button class="btn btn-primary" id="btnSaveProfile" style="height:38px;align-self:flex-end"><i class="fas fa-save"></i> Save</button>
          </div>
        </div>
      </div>

      <!-- admin panel (hidden for students) -->
      <div class="hub-section" id="adminSection" style="display:none">
        <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
        <div class="admin-panel">
          <h3><i class="fas fa-user-plus"></i> Create Student Account</h3>
          <div class="create-user-form">
            <input type="text" id="newUser" placeholder="Username">
            <input type="password" id="newPass" placeholder="Password">
            <input type="text" id="newDisplayName" placeholder="Display name (optional)">
            <button class="btn btn-primary" id="btnCreateUser"><i class="fas fa-plus"></i> Create</button>
          </div>
          <h3><i class="fas fa-users"></i> Student Accounts</h3>
          <div class="user-list" id="userList"><div class="no-items">No students yet</div></div>
          <h3 style="margin-top:24px"><i class="fas fa-bell"></i> Pending Approvals</h3>
          <div id="approvalList"><div class="no-items">No pending approvals</div></div>
          <h3 style="margin-top:24px"><i class="fas fa-flag"></i> DM Reports</h3>
          <div id="dmReportList"><div class="no-items">No pending DM reports</div></div>
          <h3 style="margin-top:24px"><i class="fas fa-exclamation-triangle"></i> Social Post Reports</h3>
          <div id="socialReportList"><div class="no-items">No pending post reports</div></div>
          <h3 style="margin-top:24px"><i class="fas fa-server"></i> System Tools</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
            <button class="btn" onclick="refreshSystemStatus()"><i class="fas fa-heartbeat"></i> Refresh Status</button>
            <button class="btn" onclick="loadSystemLogs()"><i class="fas fa-list"></i> Recent Logs</button>
            <button class="btn btn-danger" onclick="restartServerNow()"><i class="fas fa-rotate-right"></i> Restart Server</button>
          </div>
          <div id="systemStatusBox" class="no-items" style="text-align:left"></div>
          <pre id="systemLogsBox" style="margin-top:10px;max-height:240px;overflow:auto;background:#020617;color:#cbd5e1;border-radius:10px;padding:10px;font-size:12px;line-height:1.4;border:1px solid rgba(148,163,184,.2)">(no logs loaded)</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- toast container -->
  <div class="toast-container" id="toasts"></div>

  <script>
  (() => {
    'use strict';
    let isAdminUser = false;
    const themes = [
      { id: 'liquid-glass', color: '#38bdf8' }, { id: 'classic', color: '#7c3aed' },
      { id: 'light', color: '#a855f7' }, { id: 'asteroid', color: '#ff6b35' },
      { id: 'techi', color: '#00ffd5' }, { id: 'vscode-dark', color: '#569cd6' },
      { id: 'vscode-light', color: '#0066b8' }, { id: 'google', color: '#4285f4' }
    ];

    // ── auth helpers ──
    function getToken() { return localStorage.getItem('authToken'); }
    function setToken(t) { localStorage.setItem('authToken', t); }
    function clearAuth() { localStorage.removeItem('authToken'); localStorage.removeItem('authUser'); }
    function authHeaders(extra = {}) {
      const h = { ...extra }; const t = getToken();
      if (t) h['Authorization'] = 'Bearer ' + t;
      return h;
    }
    async function authFetch(url, opts = {}) {
      opts.headers = authHeaders(opts.headers || {});
      const res = await fetch(url, opts);
      if (res.status === 401) { clearAuth(); showLogin(); throw new Error('AUTH'); }
      return res;
    }

    // ── toast ──
    function toast(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':type==='warning'?'exclamation-triangle':'info-circle'}"></i> ${msg}`;
      document.getElementById('toasts').appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3500);
    }

    function appendTerminalLine(line, type = 'info') {
      const out = document.getElementById('terminalOutput');
      if (!out) return;
      const row = document.createElement('div');
      row.style.padding = '2px 0';
      row.style.whiteSpace = 'pre-wrap';
      row.style.color = type === 'error' ? '#fca5a5' : (type === 'ok' ? '#86efac' : '#cbd5e1');
      row.textContent = line;
      out.appendChild(row);
      out.scrollTop = out.scrollHeight;
    }

    async function runSandboxTerminalCommand(raw) {
      const input = String(raw || '').trim();
      if (!input) return;
      const prompt = document.getElementById('terminalPrompt');
      appendTerminalLine(`${prompt ? prompt.textContent : '/'} $ ${input}`, 'info');
      try {
        const res = await authFetch('/api/admin/sandbox/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: input })
        });
        const data = await res.json();
        if (prompt && data.cwd) prompt.textContent = data.cwd;
        if (String(data.output || '') === '__CLEAR__') {
          const out = document.getElementById('terminalOutput');
          if (out) out.innerHTML = '';
          return;
        }
        const lines = String(data.output || '').split('\n').filter(Boolean);
        if (!lines.length) appendTerminalLine('(no output)', res.ok ? 'ok' : 'error');
        else lines.forEach(line => appendTerminalLine(line, res.ok ? 'ok' : 'error'));
      } catch (e) {
        appendTerminalLine('Command failed: ' + (e.message || 'unknown error'), 'error');
      }
    }

    function setEditorStatus(msg, type = 'info') {
      const el = document.getElementById('terminalEditorStatus');
      if (!el) return;
      el.textContent = msg;
      el.style.color = type === 'error' ? '#fca5a5' : (type === 'ok' ? '#86efac' : 'var(--text-muted)');
    }

    function setEditorOpen(open) {
      const panel = document.getElementById('terminalEditor');
      if (!panel) return;
      panel.classList.toggle('active', !!open);
    }

    async function openEditorFile() {
      const pathEl = document.getElementById('terminalEditorPath');
      const textEl = document.getElementById('terminalEditorText');
      if (!pathEl || !textEl) return;
      const filePath = (pathEl.value || '').trim();
      if (!filePath) {
        setEditorStatus('Enter a file path first.', 'error');
        return;
      }
      setEditorStatus('Loading...');
      try {
        const res = await authFetch(`/api/admin/sandbox/file?path=${encodeURIComponent(filePath)}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to open file');
        pathEl.value = data.path || filePath;
        textEl.value = data.content || '';
        setEditorOpen(true);
        setEditorStatus(`Opened ${pathEl.value}`, 'ok');
      } catch (e) {
        setEditorStatus(e.message || 'Failed to open file', 'error');
      }
    }

    async function saveEditorFile() {
      const pathEl = document.getElementById('terminalEditorPath');
      const textEl = document.getElementById('terminalEditorText');
      if (!pathEl || !textEl) return;
      const filePath = (pathEl.value || '').trim();
      if (!filePath) {
        setEditorStatus('File path is required.', 'error');
        return;
      }
      setEditorStatus('Saving...');
      try {
        const res = await authFetch('/api/admin/sandbox/file', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: filePath, content: textEl.value || '' })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save file');
        pathEl.value = data.path || filePath;
        setEditorStatus(`Saved ${pathEl.value}`, 'ok');
        appendTerminalLine(`Saved ${pathEl.value}`, 'ok');
      } catch (e) {
        setEditorStatus(e.message || 'Failed to save file', 'error');
      }
    }

    function openTerminalApp() {
      if (!isAdminUser) {
        toast('Terminal is admin-only', 'warning');
        return;
      }
      const sec = document.getElementById('terminalSection');
      if (!sec) return;
      sec.style.display = '';
      sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const input = document.getElementById('terminalInput');
      if (input) input.focus();
      if (!sec.dataset.welcomeShown) {
        appendTerminalLine('Sandbox terminal ready. Type "help". Mini editor is available below.', 'info');
        sec.dataset.welcomeShown = '1';
      }
    }

    // ── theme ──
    function setTheme(id) {
      document.documentElement.setAttribute('data-theme', id);
      localStorage.setItem('theme', id);
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === id));
    }
    const savedTheme = localStorage.getItem('theme') || 'liquid-glass';
    setTheme(savedTheme);

    // render theme dots
    const themeBar = document.getElementById('themeBar');
    themes.forEach(t => {
      const dot = document.createElement('div');
      dot.className = 'theme-dot' + (t.id === savedTheme ? ' active' : '');
      dot.dataset.theme = t.id;
      dot.style.background = t.color;
      dot.title = t.id;
      dot.onclick = () => setTheme(t.id);
      themeBar.appendChild(dot);
    });

    // ── screens ──
    function showLogin() { document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('hub').classList.remove('active'); }
    function showHub() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('hub').classList.add('active'); }

    // ── avatar helper ──
    function renderAvatar(el, url, name) {
      if (url) { el.innerHTML = `<img src="${url}" alt="">`; }
      else { el.textContent = (name || '?')[0].toUpperCase(); }
    }

    // ── login ──
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      const err = document.getElementById('loginError');
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;
      if (!user || !pass) { err.textContent = 'Fill in all fields'; return; }
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
      err.textContent = '';
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        const data = await res.json();
        if (!res.ok) { err.textContent = data.error || 'Login failed'; return; }
        setToken(data.token);
        localStorage.setItem('authUser', data.username);
        loadHub();
      } catch (e) { err.textContent = 'Connection failed'; }
      finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In'; }
    });

    // ── logout ──
    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await fetch('/api/auth/logout', { method: 'POST', headers: authHeaders() }); } catch {}
      clearAuth(); showLogin();
      document.getElementById('loginUser').value = '';
      document.getElementById('loginPass').value = '';
    });

    // ── load hub ──
    async function loadHub() {
      showHub();
      try {
        const profile = await (await authFetch('/api/profile')).json();
        document.getElementById('hubGreeting').innerHTML = `Welcome back, <strong>${profile.displayName}</strong>`;
        document.getElementById('hubHandle').textContent = profile.handle;
        document.getElementById('profileName').textContent = profile.displayName;
        document.getElementById('profileHandle').textContent = profile.handle;
        document.getElementById('topName').textContent = profile.displayName;
        document.getElementById('editName').value = profile.displayName;
        document.getElementById('editHandle').value = profile.handle;
        const roleEl = document.getElementById('profileRole');
        roleEl.textContent = profile.role;
        roleEl.className = 'role role-' + profile.role;
        isAdminUser = profile.role === 'admin';
        renderAvatar(document.getElementById('profileAvatar'), profile.avatar, profile.displayName);
        renderAvatar(document.getElementById('topAvatar'), profile.avatar, profile.displayName);
        if (isAdminUser) {
          document.getElementById('adminSection').style.display = '';
          document.getElementById('terminalSection').style.display = '';
          loadStudents();
          loadApprovals();
          loadDMReports();
          loadSocialReports();
          refreshSystemStatus();
          loadSystemLogs();
        } else {
          document.getElementById('adminSection').style.display = 'none';
          document.getElementById('terminalSection').style.display = 'none';
        }
      } catch {}
    }

    // ── profile save ──
    document.getElementById('btnSaveProfile').addEventListener('click', async () => {
      const displayName = document.getElementById('editName').value.trim();
      const handle = document.getElementById('editHandle').value.trim();
      try {
        const res = await authFetch('/api/profile', {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ displayName, handle })
        });
        const data = await res.json();
        if (data.success) { toast('Profile updated!', 'success'); loadHub(); }
        else { toast(data.error || 'Failed', 'error'); }
      } catch { toast('Failed to save', 'error'); }
    });

    // ── avatar upload ──
    document.getElementById('avatarWrap').addEventListener('click', () => document.getElementById('avatarInput').click());
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('avatar', file);
      try {
        const res = await authFetch('/api/profile/avatar', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.success) { toast('Avatar updated!', 'success'); loadHub(); }
        else toast(data.error || 'Failed', 'error');
      } catch { toast('Upload failed', 'error'); }
    });

    // ── admin: create user ──
    document.getElementById('btnCreateUser').addEventListener('click', async () => {
      const username = document.getElementById('newUser').value.trim();
      const password = document.getElementById('newPass').value;
      const displayName = document.getElementById('newDisplayName').value.trim();
      if (!username || !password) { toast('Username and password required', 'warning'); return; }
      try {
        const res = await authFetch('/api/admin/create-user', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, displayName })
        });
        const data = await res.json();
        if (data.success) {
          toast(`Student "${username}" created!`, 'success');
          document.getElementById('newUser').value = '';
          document.getElementById('newPass').value = '';
          document.getElementById('newDisplayName').value = '';
          loadStudents();
        } else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    });

    async function loadStudents() {
      try {
        const students = await (await authFetch('/api/admin/users')).json();
        const list = document.getElementById('userList');
        if (!students.length) { list.innerHTML = '<div class="no-items">No students yet</div>'; return; }
        list.innerHTML = students.map(s => `
          <div class="user-row">
            <div class="avatar sm">${s.avatar ? `<img src="${s.avatar}" alt="">` : (s.displayName || s.username)[0].toUpperCase()}</div>
            <div class="name">${s.displayName || s.username}</div>
            <div class="handle">${s.handle}</div>
            <button class="del-btn" onclick="deleteStudent('${s.username}')"><i class="fas fa-trash"></i></button>
          </div>
        `).join('');
      } catch {}
    }

    window.deleteStudent = async (username) => {
      if (!confirm(`Delete student "${username}"? This cannot be undone.`)) return;
      try {
        const res = await authFetch(`/api/admin/users/${encodeURIComponent(username)}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) { toast('Student deleted', 'success'); loadStudents(); }
        else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };

    async function loadApprovals() {
      try {
        const items = await (await authFetch('/api/admin/approvals')).json();
        const el = document.getElementById('approvalList');
        if (!items.length) { el.innerHTML = '<div class="no-items">No pending approvals</div>'; return; }
        el.innerHTML = items.map(a => `
          <div class="approval-item">
            <i class="fas fa-${a.type === 'upload' ? 'cloud-upload-alt' : 'trash'}" style="font-size:20px;color:var(--${a.type === 'upload' ? 'info' : 'danger'})"></i>
            <div class="meta">
              <div class="type">${a.type} Request</div>
              <div class="detail">${a.filename} &mdash; by ${a.requestedBy} &mdash; ${new Date(a.timestamp).toLocaleString()}</div>
            </div>
            <div class="approval-btns">
              <button class="approve-btn" onclick="handleApproval('${a.id}','approve')"><i class="fas fa-check"></i></button>
              <button class="reject-btn" onclick="handleApproval('${a.id}','reject')"><i class="fas fa-times"></i></button>
            </div>
          </div>
        `).join('');
      } catch {}
    }

    window.handleApproval = async (id, action) => {
      try {
        const res = await authFetch(`/api/admin/approvals/${id}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) { toast(`Request ${data.status}`, data.status === 'approved' ? 'success' : 'warning'); loadApprovals(); }
        else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };

    async function loadDMReports() {
      try {
        const items = await (await authFetch('/api/admin/dm-reports')).json();
        const el = document.getElementById('dmReportList');
        if (!items.length) { el.innerHTML = '<div class="no-items">No pending DM reports</div>'; return; }
        el.innerHTML = items.map(r => `
          <div class="approval-item">
            <i class="fas fa-flag" style="font-size:20px;color:var(--danger)"></i>
            <div class="meta">
              <div class="type">DM Report: ${r.reason}</div>
              <div class="detail">
                Reporter: ${r.reporter?.displayName || r.reportedBy} &mdash; Sender: ${r.sender?.displayName || r.messageFrom} &mdash; ${new Date(r.timestamp).toLocaleString()}
              </div>
              <div class="detail" style="margin-top:4px">
                Message: ${(r.messageText || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') || '[attachment only]'}
              </div>
            </div>
            <div class="approval-btns">
              <button class="review-btn" onclick="handleDMReport('${r.id}','resolve')" title="Mark reviewed"><i class="fas fa-check-double"></i></button>
              <button class="approve-btn" onclick="handleDMReport('${r.id}','delete-message')" title="Delete message"><i class="fas fa-trash"></i></button>
              <button class="reject-btn" onclick="handleDMReport('${r.id}','dismiss')" title="Dismiss"><i class="fas fa-times"></i></button>
            </div>
          </div>
        `).join('');
      } catch {}
    }

    window.handleDMReport = async (id, action) => {
      try {
        const res = await authFetch(`/api/admin/dm-reports/${id}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) { toast(`DM report ${data.status}`, action === 'delete-message' ? 'warning' : 'success'); loadDMReports(); }
        else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };

    async function loadSocialReports() {
      try {
        const items = await (await authFetch('/api/admin/reports')).json();
        const el = document.getElementById('socialReportList');
        if (!items.length) { el.innerHTML = '<div class="no-items">No pending post reports</div>'; return; }
        el.innerHTML = items.map(r => `
          <div class="approval-item">
            <i class="fas fa-flag" style="font-size:20px;color:var(--warning)"></i>
            <div class="meta">
              <div class="type">Reported by ${r.reporter?.displayName || r.reportedBy}</div>
              <div class="detail">Post by ${r.postAuthor} &mdash; ${new Date(r.timestamp).toLocaleString()}</div>
              <div class="detail" style="margin-top:4px">Reason: ${(r.reason || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              <div class="detail" style="margin-top:2px;opacity:.7">"${(r.postContent || '').substring(0, 120).replace(/</g,'&lt;').replace(/>/g,'&gt;')}${(r.postContent||'').length>120?'...':''}"</div>
            </div>
            <div class="approval-btns">
              <button class="reject-btn" onclick="handleSocialReport('${r.id}','delete-post')" title="Delete post"><i class="fas fa-trash"></i></button>
              <button class="approve-btn" onclick="handleSocialReport('${r.id}','dismiss')" title="Dismiss"><i class="fas fa-times"></i></button>
            </div>
          </div>
        `).join('');
      } catch {}
    }

    window.handleSocialReport = async (id, action) => {
      try {
        const res = await authFetch(`/api/admin/reports/${id}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) { toast(action === 'delete-post' ? 'Post deleted' : 'Report dismissed', action === 'delete-post' ? 'warning' : 'success'); loadSocialReports(); }
        else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };

    function fmtBytes(bytes) {
      const n = Number(bytes) || 0;
      if (n < 1024) return `${n} B`;
      if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
      if (n < 1024 * 1024 * 1024) return `${(n / (1024 * 1024)).toFixed(1)} MB`;
      return `${(n / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    }

    function fmtDuration(ms) {
      const s = Math.max(0, Math.floor((Number(ms) || 0) / 1000));
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (d) return `${d}d ${h}h ${m}m`;
      if (h) return `${h}h ${m}m ${sec}s`;
      if (m) return `${m}m ${sec}s`;
      return `${sec}s`;
    }

    window.refreshSystemStatus = async () => {
      const box = document.getElementById('systemStatusBox');
      if (!box) return;
      box.textContent = 'Loading...';
      try {
        const res = await authFetch('/api/admin/system/status');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load status');
        box.innerHTML = [
          `PID: ${data.pid}`,
          `Node: ${data.nodeVersion}`,
          `Platform: ${data.platform}`,
          `Uptime: ${fmtDuration(data.uptimeMs)}`,
          `Memory (RSS/Heap): ${fmtBytes(data.rssBytes)} / ${fmtBytes(data.heapUsedBytes)} of ${fmtBytes(data.heapTotalBytes)}`,
          `Restart Enabled: ${data.restartEnabled ? 'yes' : 'no'}`
        ].join('<br>');
      } catch (e) {
        box.textContent = `Status error: ${e.message || 'unknown error'}`;
      }
    };

    window.loadSystemLogs = async () => {
      const box = document.getElementById('systemLogsBox');
      if (!box) return;
      box.textContent = 'Loading logs...';
      try {
        const res = await authFetch('/api/admin/system/logs?count=40');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load logs');
        const lines = (data.logs || []).map(l => {
          const details = l.details && typeof l.details === 'object' ? JSON.stringify(l.details) : '{}';
          return `${l.timestamp || ''}  ${l.actor || 'system'}  ${l.action || ''}  ${details}`;
        });
        box.textContent = lines.length ? lines.join('\n') : '(no logs found)';
      } catch (e) {
        box.textContent = `Logs error: ${e.message || 'unknown error'}`;
      }
    };

    window.restartServerNow = async () => {
      if (!confirm('Restart server now? Use this only when supervised by pm2/systemd/docker.')) return;
      try {
        const res = await authFetch('/api/admin/system/restart', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Restart failed');
        toast(data.message || 'Restart requested', 'warning');
      } catch (e) {
        toast(e.message || 'Restart failed', 'error');
      }
    };

    const terminalApp = document.getElementById('appTerminal');
    if (terminalApp) {
      terminalApp.addEventListener('click', (e) => {
        e.preventDefault();
        openTerminalApp();
      });
    }

    const terminalRun = document.getElementById('btnTerminalRun');
    if (terminalRun) {
      terminalRun.addEventListener('click', () => {
        const input = document.getElementById('terminalInput');
        if (!input) return;
        const value = input.value;
        input.value = '';
        runSandboxTerminalCommand(value);
      });
    }

    const terminalInput = document.getElementById('terminalInput');
    if (terminalInput) {
      terminalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const value = terminalInput.value;
          terminalInput.value = '';
          runSandboxTerminalCommand(value);
        }
      });
    }

    const terminalClear = document.getElementById('btnTerminalClear');
    if (terminalClear) {
      terminalClear.addEventListener('click', () => {
        const out = document.getElementById('terminalOutput');
        if (out) out.innerHTML = '';
      });
    }

    document.querySelectorAll('[data-term-cmd]').forEach(btn => {
      btn.addEventListener('click', () => runSandboxTerminalCommand(btn.getAttribute('data-term-cmd') || ''));
    });

    const editorToggle = document.getElementById('btnEditorToggle');
    if (editorToggle) {
      editorToggle.addEventListener('click', () => {
        const panel = document.getElementById('terminalEditor');
        setEditorOpen(!panel || !panel.classList.contains('active'));
      });
    }
    const editorOpen = document.getElementById('btnEditorOpen');
    if (editorOpen) editorOpen.addEventListener('click', openEditorFile);
    const editorSave = document.getElementById('btnEditorSave');
    if (editorSave) editorSave.addEventListener('click', saveEditorFile);
    const editorClose = document.getElementById('btnEditorClose');
    if (editorClose) editorClose.addEventListener('click', () => setEditorOpen(false));
    const editorNew = document.getElementById('btnEditorNew');
    if (editorNew) {
      editorNew.addEventListener('click', () => {
        const text = document.getElementById('terminalEditorText');
        setEditorOpen(true);
        if (text) text.value = '';
        setEditorStatus('New file. Set a path and click Save.', 'info');
      });
    }
    const editorPath = document.getElementById('terminalEditorPath');
    if (editorPath) {
      editorPath.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          openEditorFile();
        }
      });
    }

    // ── init ──
    (async () => {
      const token = getToken();
      if (!token) { showLogin(); return; }
      try {
        const res = await fetch('/api/auth/verify', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) { showLogin(); return; }
        const data = await res.json();
        if (!data.valid) { showLogin(); return; }
        loadHub();
      } catch { showLogin(); }
    })();
  })();
  </script>
</body>
</html>
