<!DOCTYPE html>
<html lang="en" data-theme="liquid-glass">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Prenxy Study Hub</title>
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/shared.css">
  <style>
    html { overflow: clip; }
    html, body { height: 100%; }
    body { display: flex; flex-direction: column; min-height: 100dvh; -webkit-tap-highlight-color: transparent; }

    /* ═══ LOGIN ═══ */
    .login-screen {
      flex: 1; display: flex; align-items: center; justify-content: center;
      padding: 16px; overflow-y: auto;
    }
    .login-card {
      width: 100%; max-width: 400px; background: var(--bg-secondary);
      border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 36px 24px 28px; text-align: center;
      box-shadow: var(--shadow-lg); position: relative; overflow: hidden;
    }
    .login-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--accent-gradient); }
    .login-logo { font-size: 44px; margin-bottom: 6px; }
    .login-logo i { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .login-title { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
    .login-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; }
    .field { text-align: left; margin-bottom: 14px; }
    .field label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--text-secondary); margin-bottom: 6px; }
    .field input { font-size: 16px !important; /* prevent iOS zoom */ padding: 12px 14px; }
    .login-btn {
      width: 100%; padding: 14px; margin-top: 8px;
      background: var(--accent-gradient); color: #fff; border: none;
      border-radius: var(--radius-sm); font-size: 16px; font-weight: 700;
      font-family: inherit; cursor: pointer; -webkit-appearance: none;
    }
    .login-error { color: var(--danger); font-size: 13px; margin-top: 10px; min-height: 18px; }
    .login-footer { margin-top: 20px; font-size: 11px; color: var(--text-muted); }

    /* ═══ HUB ═══ */
    .hub { flex: 1; display: none; flex-direction: column; overflow: hidden; }
    .hub.active { display: flex; }
    .hub-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px 16px 100px; }
    .hub-greeting { font-size: 22px; font-weight: 300; margin-bottom: 2px; }
    .hub-greeting strong { font-weight: 800; }
    .hub-handle { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; }
    .hub-section { margin-bottom: 28px; }
    .hub-section h2 { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }

    /* App cards — stacked vertically */
    .app-grid { display: flex; flex-direction: column; gap: 12px; }
    .app-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 20px 16px;
      display: flex; align-items: center; gap: 16px;
      text-decoration: none; transition: transform .15s; position: relative; overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .app-card:active { transform: scale(0.97); }
    .app-card .icon-wrap {
      width: 48px; height: 48px; border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #fff; flex-shrink: 0;
    }
    .app-card .info h3 { font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; }
    .app-card .info p { font-size: 12px; color: var(--text-muted); line-height: 1.4; }
    .app-card.holding {
      transform: scale(.986);
      border-color: var(--accent-primary);
      background: color-mix(in srgb, var(--bg-card), var(--accent-primary) 8%);
    }
    .card-drive .icon-wrap { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .card-social .icon-wrap { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .card-chat .icon-wrap { background: linear-gradient(135deg, #10b981, #059669); }

    /* ═══ PROFILE ═══ */
    .profile-section {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 20px 16px;
      display: flex; flex-direction: column; gap: 16px; align-items: center; text-align: center;
    }
    .profile-info .name { font-size: 18px; font-weight: 700; }
    .profile-info .handle { font-size: 13px; color: var(--text-muted); }
    .profile-info .role { display: inline-block; padding: 2px 10px; font-size: 11px; font-weight: 600; border-radius: 99px; margin-top: 6px; text-transform: uppercase; }
    .role-admin { background: rgba(239,68,68,.15); color: var(--danger); }
    .role-student { background: rgba(59,130,246,.15); color: var(--info); }
    .profile-edit { width: 100%; display: flex; flex-direction: column; gap: 10px; }
    .profile-edit .field { margin-bottom: 0; text-align: left; }
    .profile-edit input { font-size: 16px !important; padding: 10px 12px; }
    .profile-avatar-wrap { position: relative; cursor: pointer; }
    .avatar-edit {
      position: absolute; inset: 0; background: rgba(0,0,0,.45);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 18px; opacity: 0; transition: opacity .2s;
    }
    .profile-avatar-wrap:active .avatar-edit { opacity: 1; }

    /* ═══ ADMIN PANEL ═══ */
    .admin-panel {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 20px 16px;
    }
    .admin-panel h3 { font-size: 14px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .create-user-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .create-user-form input { font-size: 16px !important; padding: 12px; }
    .user-list { display: flex; flex-direction: column; gap: 8px; }
    .user-row {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      background: var(--bg-tertiary); border-radius: var(--radius-sm);
    }
    .user-row .name { font-weight: 600; font-size: 13px; flex: 1; }
    .user-row .handle { font-size: 11px; color: var(--text-muted); }
    .user-row .del-btn {
      background: none; border: 1px solid var(--danger); color: var(--danger);
      padding: 6px 12px; border-radius: var(--radius-sm); font-size: 11px;
      cursor: pointer; font-family: inherit; min-height: 36px;
    }
    .approval-item {
      display: flex; align-items: center; gap: 10px; padding: 12px;
      background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .approval-item .meta { flex: 1; min-width: 0; }
    .approval-item .meta .type { font-weight: 600; font-size: 13px; text-transform: capitalize; }
    .approval-item .meta .detail { font-size: 11px; color: var(--text-muted); word-break: break-all; }
    .approval-btns { display: flex; gap: 6px; }
    .approval-btns button { padding: 8px 14px; border: none; border-radius: var(--radius-sm); font-size: 12px; font-family: inherit; cursor: pointer; font-weight: 600; min-height: 36px; }
    .approve-btn { background: var(--success); color: #fff; }
    .reject-btn { background: var(--danger); color: #fff; }
    .review-btn { background: var(--info); color: #fff; }
    .no-items { font-size: 13px; color: var(--text-muted); padding: 12px; text-align: center; }

    /* Card colors for new apps */
    .card-vm .icon-wrap { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .card-offers .icon-wrap { background: linear-gradient(135deg, #ec4899, #db2777); }
    .card-resources .icon-wrap { background: linear-gradient(135deg, #06b6d4, #0891b2); }

    /* ═══ APP PANELS (VM, Offers, Resources) ═══ */
    .app-panel {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 20px 16px;
    }
    .app-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; gap: 10px;
    }
    .app-panel-header h3 {
      font-size: 15px; font-weight: 800; display: flex; align-items: center; gap: 8px; margin: 0;
    }
    .app-panel-desc {
      font-size: 12px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5;
    }
    .app-panel .back-btn {
      background: var(--bg-tertiary); border: 1px solid var(--border);
      color: var(--text-secondary); padding: 8px 14px; border-radius: var(--radius-sm);
      font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
      min-height: 36px;
    }
    .resource-grid {
      display: flex; flex-direction: column; gap: 12px;
    }
    .resource-card {
      background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 16px;
    }
    .resource-card .rc-icon {
      width: 40px; height: 40px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; color: #fff; margin-bottom: 10px;
    }
    .resource-card h4 { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
    .resource-card .rc-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
    .resource-card .rc-badge {
      display: inline-block; padding: 2px 8px; border-radius: 99px;
      font-size: 10px; font-weight: 700; margin-top: 8px; text-transform: uppercase;
    }
    .rc-badge.active { background: rgba(16,185,129,.15); color: var(--success); }
    .rc-badge.coming { background: rgba(245,158,11,.15); color: var(--warning); }
    .rc-badge.free { background: rgba(59,130,246,.15); color: var(--info); }
    .rc-badge.hot { background: rgba(239,68,68,.15); color: var(--danger); }
    .classroom-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
    .classroom-section h4 { font-size: 14px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .classroom-files { display: flex; flex-direction: column; gap: 8px; }
    .classroom-file {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }
    .classroom-file .cf-icon {
      width: 36px; height: 36px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; flex-shrink: 0;
    }
    .classroom-file .cf-info { flex: 1; min-width: 0; }
    .classroom-file .cf-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .classroom-file .cf-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .section-tabs {
      display: flex; gap: 6px; margin-bottom: 16px; overflow-x: auto;
      -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .section-tabs::-webkit-scrollbar { display: none; }
    .section-tab {
      padding: 7px 14px; border-radius: 99px; font-size: 12px; font-weight: 600;
      background: var(--bg-tertiary); border: 1px solid var(--border);
      color: var(--text-secondary); cursor: pointer; font-family: inherit;
      white-space: nowrap; flex-shrink: 0;
    }
    .section-tab.active { background: var(--accent-primary); color: #fff; border-color: var(--accent-primary); }

    /* ═══ MOBILE TOP BAR ═══ */
    .top-bar { padding: 10px 16px; }
    .top-bar .right { gap: 8px; }
    .theme-bar { display: none; }

    /* Theme picker as a bottom sheet */
    .theme-sheet {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999;
      background: var(--bg-secondary); border-top: 1px solid var(--border);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      padding: 20px 16px calc(env(safe-area-inset-bottom, 16px) + 16px);
      transform: translateY(100%); transition: transform .3s ease;
      box-shadow: 0 -8px 30px rgba(0,0,0,.2);
    }
    .theme-sheet.open { transform: translateY(0); }
    .theme-sheet h3 { font-size: 15px; font-weight: 700; margin-bottom: 14px; text-align: center; }
    .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .theme-cell {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      padding: 10px 4px; border-radius: var(--radius-sm); cursor: pointer;
      border: 2px solid transparent; transition: all .2s;
    }
    .theme-cell.active { border-color: var(--accent-primary); background: var(--bg-tertiary); }
    .theme-cell .swatch { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border); }
    .theme-cell .tname { font-size: 10px; color: var(--text-muted); text-align: center; }
    .theme-backdrop {
      position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,.4);
      display: none;
    }
    .theme-backdrop.open { display: block; }

    /* desktop link */
    .desktop-link {
      display: block; text-align: center; padding: 16px;
      font-size: 12px; color: var(--text-muted);
    }
    .desktop-link a { color: var(--accent-primary); }

    /* ===== 2026 MOBILE REMASTER ===== */
    @keyframes mobileAurora {
      0%, 100% { transform: translate3d(0,0,0) scale(1); opacity: .32; }
      50% { transform: translate3d(0,-12px,0) scale(1.08); opacity: .5; }
    }
    @keyframes mobileCardIn {
      from { opacity: 0; transform: translateY(14px) scale(.985); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    body::before,
    body::after {
      content: '';
      position: fixed;
      pointer-events: none;
      z-index: -1;
      border-radius: 50%;
      filter: blur(54px);
      animation: mobileAurora 9s ease-in-out infinite;
    }
    body::before {
      width: 210px;
      height: 210px;
      top: 70px;
      right: -65px;
      background: radial-gradient(circle, rgba(56,189,248,.36), rgba(56,189,248,0) 70%);
    }
    body::after {
      width: 230px;
      height: 230px;
      left: -90px;
      bottom: 90px;
      background: radial-gradient(circle, rgba(16,185,129,.22), rgba(16,185,129,0) 70%);
      animation-delay: -3s;
    }
    .top-bar {
      position: sticky;
      top: 0;
      z-index: 12;
      backdrop-filter: blur(16px) saturate(130%);
      -webkit-backdrop-filter: blur(16px) saturate(130%);
      border-bottom: 1px solid color-mix(in srgb, var(--border), #7dd3fc 20%);
      background: color-mix(in srgb, var(--bg-primary), transparent 18%);
    }
    .login-card,
    .app-card,
    .profile-section,
    .admin-panel {
      border-width: 1.5px;
      box-shadow: 0 16px 32px rgba(2, 6, 23, .2);
      animation: mobileCardIn .45s ease both;
    }
    .login-card {
      background: linear-gradient(160deg, color-mix(in srgb, var(--bg-secondary), white 5%), var(--bg-secondary));
    }
    .login-btn {
      box-shadow: 0 10px 18px rgba(56, 189, 248, .25);
      transition: transform .18s ease, box-shadow .2s ease, filter .2s ease;
    }
    .login-btn:active {
      transform: translateY(1px) scale(.985);
      box-shadow: 0 6px 14px rgba(56, 189, 248, .22);
      filter: brightness(.98);
    }
    .hub-scroll {
      padding-top: 24px;
      background:
        radial-gradient(circle at 82% 10%, rgba(56,189,248,.08), transparent 36%),
        radial-gradient(circle at 6% 70%, rgba(16,185,129,.08), transparent 40%);
    }
    .hub-greeting {
      letter-spacing: .2px;
      font-size: 24px;
    }
    .hub-handle {
      margin-bottom: 26px;
    }
    .app-card {
      border-radius: 20px;
      padding: 18px 15px;
      transition: transform .2s ease, box-shadow .24s ease, border-color .24s ease;
    }
    .app-card::after {
      content: '';
      position: absolute;
      inset: auto -35% -60% -35%;
      height: 120px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      transform: rotate(8deg);
      opacity: 0;
      transition: opacity .24s ease;
    }
    .app-card:active {
      transform: scale(.985);
    }
    .app-card:hover {
      transform: translateY(-3px);
      border-color: color-mix(in srgb, var(--accent-primary), white 26%);
      box-shadow: 0 20px 32px rgba(2, 6, 23, .24);
    }
    .app-card:hover::after {
      opacity: 1;
    }
    .app-card .icon-wrap {
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.32), 0 10px 20px rgba(2, 6, 23, .24);
    }
    .field input,
    .create-user-form input {
      border-width: 1.5px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .field input:focus,
    .create-user-form input:focus {
      border-color: color-mix(in srgb, var(--accent-primary), white 20%);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary), transparent 76%);
      outline: none;
    }
    .user-row,
    .approval-item {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(160deg, color-mix(in srgb, var(--bg-tertiary), white 4%), var(--bg-tertiary));
    }
    .btn-icon {
      transition: transform .16s ease, box-shadow .2s ease;
    }
    .btn-icon:active {
      transform: scale(.94);
    }
    .theme-sheet {
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      backdrop-filter: blur(14px) saturate(130%);
      -webkit-backdrop-filter: blur(14px) saturate(130%);
    }
    .btn-icon,.app-card,.login-btn,.del-btn,.approval-btns button { touch-action: manipulation; }
  </style>
</head>
<body>
  <!-- Login screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo"><i class="fas fa-atom"></i></div>
      <div class="login-title">Prenxy Study Hub</div>
      <div class="login-sub">Sign in to access your workspace</div>
      <form id="loginForm" autocomplete="off">
        <div class="field">
          <label for="loginUser">Username</label>
          <input type="text" id="loginUser" placeholder="Enter your username" required autocomplete="username" inputmode="text">
        </div>
        <div class="field">
          <label for="loginPass">Password</label>
          <input type="password" id="loginPass" placeholder="Enter your password" required autocomplete="current-password">
        </div>
        <button type="submit" class="login-btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Sign In</button>
        <div class="login-error" id="loginError"></div>
      </form>
      <div class="login-footer"><i class="fas fa-lock"></i> Secured with AES-256 encryption</div>
    </div>
  </div>

  <!-- Hub -->
  <div class="hub" id="hub">
    <div class="top-bar">
      <div class="left">
        <a class="logo-link" href="/"><i class="fas fa-atom"></i> Prenxy</a>
      </div>
      <div class="right">
        <button class="btn-icon" id="btnTheme" title="Theme"><i class="fas fa-palette"></i></button>
        <div class="user-chip" id="userChip">
          <div class="avatar sm" id="topAvatar"></div>
          <span id="topName">user</span>
        </div>
        <button class="btn-icon" id="btnLogout" title="Sign Out"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="hub-scroll">
      <div class="hub-greeting" id="hubGreeting">Welcome, <strong>User</strong></div>
      <div class="hub-handle" id="hubHandle">@user</div>

      <!-- Apps -->
      <div class="hub-section">
        <h2><i class="fas fa-th-large"></i> Your Apps</h2>
        <div class="app-grid">
          <a class="app-card card-drive" href="/drive.html">
            <div class="icon-wrap"><i class="fas fa-folder-open"></i></div>
            <div class="info"><h3>Prenxy Drive</h3><p>Upload, view & manage documents.</p></div>
          </a>
          <a class="app-card card-social" href="/social.html">
            <div class="icon-wrap"><i class="fas fa-users"></i></div>
            <div class="info"><h3>Prenxy Social</h3><p>Post updates, comment & react.</p></div>
          </a>
          <a class="app-card card-chat" href="/chat.html">
            <div class="icon-wrap"><i class="fas fa-comments"></i></div>
            <div class="info"><h3>Prenxy Chat</h3><p>Direct messaging with peers.</p></div>
          </a>
          <a class="app-card card-vm" href="/vm.html">
            <div class="icon-wrap"><i class="fas fa-cubes"></i></div>
            <div class="info"><h3>VM</h3><p>Cloud virtual machine workspaces.</p></div>
          </a>
          <a class="app-card card-offers" href="/offers.html">
            <div class="icon-wrap"><i class="fas fa-tags"></i></div>
            <div class="info"><h3>Offers</h3><p>Student plans, bundles & deals.</p></div>
          </a>
          <a class="app-card card-resources" href="/resources.html">
            <div class="icon-wrap"><i class="fas fa-graduation-cap"></i></div>
            <div class="info"><h3>Student Resources</h3><p>Learning materials & classroom files.</p></div>
          </a>
        </div>
      </div>

      <!-- Profile -->
      <div class="hub-section">
        <h2><i class="fas fa-user-cog"></i> Your Profile</h2>
        <div class="profile-section">
          <div class="profile-avatar-wrap" id="avatarWrap">
            <div class="avatar xl" id="profileAvatar"></div>
            <div class="avatar-edit"><i class="fas fa-camera"></i></div>
            <input type="file" id="avatarInput" accept="image/*" hidden>
          </div>
          <div class="profile-info">
            <div class="name" id="profileName">User</div>
            <div class="handle" id="profileHandle">@user</div>
            <div class="role" id="profileRole">user</div>
          </div>
          <div class="profile-edit">
            <div class="field"><label>Display Name</label><input type="text" id="editName" maxlength="50"></div>
            <div class="field"><label>Handle</label><input type="text" id="editHandle" maxlength="30" placeholder="@handle"></div>
            <button class="btn btn-primary" id="btnSaveProfile" style="width:100%;padding:12px"><i class="fas fa-save"></i> Save Profile</button>
          </div>
        </div>
      </div>

      <!-- Admin panel -->
      <div class="hub-section" id="adminSection" style="display:none">
        <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
        <div class="admin-panel">
          <h3><i class="fas fa-user-plus"></i> Create Student Account</h3>
          <div class="create-user-form">
            <input type="text" id="newUser" placeholder="Username" inputmode="text">
            <input type="password" id="newPass" placeholder="Password">
            <input type="text" id="newDisplayName" placeholder="Display name (optional)">
            <button class="btn btn-primary" id="btnCreateUser" style="width:100%;padding:12px"><i class="fas fa-plus"></i> Create</button>
          </div>
          <h3><i class="fas fa-users"></i> Student Accounts</h3>
          <div class="user-list" id="userList"><div class="no-items">No students yet</div></div>
          <h3 style="margin-top:20px"><i class="fas fa-bell"></i> Pending Approvals</h3>
          <div id="approvalList"><div class="no-items">No pending approvals</div></div>
          <h3 style="margin-top:20px"><i class="fas fa-flag"></i> DM Reports</h3>
          <div id="dmReportList"><div class="no-items">No pending DM reports</div></div>
          <h3 style="margin-top:20px"><i class="fas fa-exclamation-triangle"></i> Post Reports</h3>
          <div id="socialReportList"><div class="no-items">No pending post reports</div></div>
          <h3 style="margin-top:20px"><i class="fas fa-server"></i> System Tools</h3>
          <div style="display:grid;gap:8px;margin-bottom:8px">
            <button class="btn" style="width:100%;padding:10px" onclick="refreshSystemStatus()"><i class="fas fa-heartbeat"></i> Refresh Status</button>
            <button class="btn" style="width:100%;padding:10px" onclick="loadSystemLogs()"><i class="fas fa-list"></i> Recent Logs</button>
            <button class="btn btn-danger" style="width:100%;padding:10px" onclick="restartServerNow()"><i class="fas fa-rotate-right"></i> Restart Server</button>
          </div>
          <div id="systemStatusBox" class="no-items" style="text-align:left"></div>
          <pre id="systemLogsBox" style="margin-top:8px;max-height:220px;overflow:auto;background:#020617;color:#cbd5e1;border-radius:10px;padding:10px;font-size:11px;line-height:1.4;border:1px solid rgba(148,163,184,.2)">(no logs loaded)</pre>
        </div>
      </div>

      <div class="desktop-link">
        <a href="/?desktop=1">Switch to desktop version</a>
      </div>
    </div>
  </div>

  <!-- Theme bottom sheet -->
  <div class="theme-backdrop" id="themeBackdrop"></div>
  <div class="theme-sheet" id="themeSheet">
    <h3>Choose Theme</h3>
    <div class="theme-grid" id="themeGrid"></div>
  </div>

  <div class="toast-container" id="toasts"></div>

  <script>
  (() => {
    'use strict';
    const themes = [
      { id: 'liquid-glass', color: '#38bdf8', label: 'Glass' },
      { id: 'classic', color: '#7c3aed', label: 'Classic' },
      { id: 'light', color: '#a855f7', label: 'Light' },
      { id: 'asteroid', color: '#ff6b35', label: 'Asteroid' },
      { id: 'techi', color: '#00ffd5', label: 'Techi' },
      { id: 'vscode-dark', color: '#569cd6', label: 'VS Dark' },
      { id: 'vscode-light', color: '#0066b8', label: 'VS Light' },
      { id: 'google', color: '#4285f4', label: 'Google' }
    ];

    function getToken() { return localStorage.getItem('authToken'); }
    function setToken(t) { localStorage.setItem('authToken', t); }
    function clearAuth() { localStorage.removeItem('authToken'); localStorage.removeItem('authUser'); }
    function authHeaders(extra = {}) { const h = { ...extra }; const t = getToken(); if (t) h['Authorization'] = 'Bearer ' + t; return h; }
    async function authFetch(url, opts = {}) {
      opts.headers = authHeaders(opts.headers || {});
      const res = await fetch(url, opts);
      if (res.status === 401) { clearAuth(); showLogin(); throw new Error('AUTH'); }
      return res;
    }
    function toast(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':type==='warning'?'exclamation-triangle':'info-circle'}"></i> ${msg}`;
      document.getElementById('toasts').appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3500);
    }
    function renderAvatar(el, url, name) {
      if (url) el.innerHTML = `<img src="${url}" alt="">`;
      else el.textContent = (name || '?')[0].toUpperCase();
    }

    // Touch-hold helper for app cards
    function bindAppCardTouchHold() {
      let timer = null, sx = 0, sy = 0, target = null;
      document.querySelectorAll('.app-card').forEach(card => {
        if (card.dataset.touchBound) return;
        card.dataset.touchBound = '1';
        card.addEventListener('touchstart', e => {
          sx = e.touches?.[0]?.clientX || 0;
          sy = e.touches?.[0]?.clientY || 0;
          target = card;
          card.classList.add('holding');
          const title = (card.querySelector('h3')?.textContent || 'App').trim();
          timer = setTimeout(() => {
            navigator.vibrate?.(20);
            toast(`${title}: tap to open`, 'info');
            card.classList.remove('holding');
            timer = null;
            target = null;
          }, 480);
        }, { passive: true });
        card.addEventListener('touchmove', e => {
          const x = e.touches?.[0]?.clientX || 0;
          const y = e.touches?.[0]?.clientY || 0;
          const moved = Math.abs(x - sx) > 10 || Math.abs(y - sy) > 10;
          if (moved && timer) {
            clearTimeout(timer);
            timer = null;
            if (target) target.classList.remove('holding');
          }
        }, { passive: true });
        card.addEventListener('touchend', () => {
          if (timer) clearTimeout(timer);
          timer = null;
          if (target) target.classList.remove('holding');
          target = null;
        }, { passive: true });
      });
    }

    // ── theme ──
    function setTheme(id) {
      document.documentElement.setAttribute('data-theme', id);
      localStorage.setItem('theme', id);
      document.querySelectorAll('.theme-cell').forEach(c => c.classList.toggle('active', c.dataset.theme === id));
    }
    const savedTheme = localStorage.getItem('theme') || 'liquid-glass';
    setTheme(savedTheme);

    const themeGrid = document.getElementById('themeGrid');
    themes.forEach(t => {
      const cell = document.createElement('div');
      cell.className = 'theme-cell' + (t.id === savedTheme ? ' active' : '');
      cell.dataset.theme = t.id;
      cell.innerHTML = `<div class="swatch" style="background:${t.color}"></div><div class="tname">${t.label}</div>`;
      cell.onclick = () => setTheme(t.id);
      themeGrid.appendChild(cell);
    });

    const themeSheet = document.getElementById('themeSheet');
    const themeBackdrop = document.getElementById('themeBackdrop');
    document.getElementById('btnTheme').onclick = () => {
      themeSheet.classList.toggle('open');
      themeBackdrop.classList.toggle('open');
    };
    themeBackdrop.onclick = () => {
      themeSheet.classList.remove('open');
      themeBackdrop.classList.remove('open');
    };

    // ── screens ──
    function showLogin() { document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('hub').classList.remove('active'); }
    function showHub() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('hub').classList.add('active'); }

    // ── login ──
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      const err = document.getElementById('loginError');
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;
      if (!user || !pass) { err.textContent = 'Fill in all fields'; return; }
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
      err.textContent = '';
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        const data = await res.json();
        if (!res.ok) { err.textContent = data.error || 'Login failed'; return; }
        setToken(data.token);
        localStorage.setItem('authUser', data.username);
        loadHub();
      } catch { err.textContent = 'Connection failed'; }
      finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In'; }
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await fetch('/api/auth/logout', { method: 'POST', headers: authHeaders() }); } catch {}
      clearAuth(); showLogin();
      document.getElementById('loginUser').value = '';
      document.getElementById('loginPass').value = '';
    });

    async function loadHub() {
      showHub();
      try {
        const profile = await (await authFetch('/api/profile')).json();
        document.getElementById('hubGreeting').innerHTML = `Welcome back, <strong>${profile.displayName}</strong>`;
        document.getElementById('hubHandle').textContent = profile.handle;
        document.getElementById('profileName').textContent = profile.displayName;
        document.getElementById('profileHandle').textContent = profile.handle;
        document.getElementById('topName').textContent = profile.displayName;
        document.getElementById('editName').value = profile.displayName;
        document.getElementById('editHandle').value = profile.handle;
        const roleEl = document.getElementById('profileRole');
        roleEl.textContent = profile.role;
        roleEl.className = 'role role-' + profile.role;
        renderAvatar(document.getElementById('profileAvatar'), profile.avatar, profile.displayName);
        renderAvatar(document.getElementById('topAvatar'), profile.avatar, profile.displayName);
        if (profile.role === 'admin') {
          document.getElementById('adminSection').style.display = '';
          loadStudents(); loadApprovals(); loadDMReports(); loadSocialReports(); refreshSystemStatus(); loadSystemLogs();
        } else {
          document.getElementById('adminSection').style.display = 'none';
        }
      } catch {}
    }

    document.getElementById('btnSaveProfile').addEventListener('click', async () => {
      const displayName = document.getElementById('editName').value.trim();
      const handle = document.getElementById('editHandle').value.trim();
      try {
        const res = await authFetch('/api/profile', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ displayName, handle }) });
        const data = await res.json();
        if (data.success) { toast('Profile updated!', 'success'); loadHub(); } else toast(data.error || 'Failed', 'error');
      } catch { toast('Failed to save', 'error'); }
    });

    document.getElementById('avatarWrap').addEventListener('click', () => document.getElementById('avatarInput').click());
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData(); fd.append('avatar', file);
      try {
        const res = await authFetch('/api/profile/avatar', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.success) { toast('Avatar updated!', 'success'); loadHub(); } else toast(data.error || 'Failed', 'error');
      } catch { toast('Upload failed', 'error'); }
    });

    // ── admin ──
    document.getElementById('btnCreateUser').addEventListener('click', async () => {
      const username = document.getElementById('newUser').value.trim();
      const password = document.getElementById('newPass').value;
      const displayName = document.getElementById('newDisplayName').value.trim();
      if (!username || !password) { toast('Username and password required', 'warning'); return; }
      try {
        const res = await authFetch('/api/admin/create-user', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password, displayName }) });
        const data = await res.json();
        if (data.success) {
          toast(`Student "${username}" created!`, 'success');
          document.getElementById('newUser').value = '';
          document.getElementById('newPass').value = '';
          document.getElementById('newDisplayName').value = '';
          loadStudents();
        } else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    });

    async function loadStudents() {
      try {
        const students = await (await authFetch('/api/admin/users')).json();
        const list = document.getElementById('userList');
        if (!students.length) { list.innerHTML = '<div class="no-items">No students yet</div>'; return; }
        list.innerHTML = students.map(s => `
          <div class="user-row">
            <div class="avatar sm">${s.avatar ? `<img src="${s.avatar}" alt="">` : (s.displayName || s.username)[0].toUpperCase()}</div>
            <div class="name">${s.displayName || s.username}</div>
            <div class="handle">${s.handle}</div>
            <button class="del-btn" onclick="deleteStudent('${s.username}')"><i class="fas fa-trash"></i></button>
          </div>`).join('');
      } catch {}
    }
    window.deleteStudent = async (username) => {
      if (!confirm(`Delete student "${username}"?`)) return;
      try {
        const res = await authFetch(`/api/admin/users/${encodeURIComponent(username)}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) { toast('Deleted', 'success'); loadStudents(); } else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };
    async function loadApprovals() {
      try {
        const items = await (await authFetch('/api/admin/approvals')).json();
        const el = document.getElementById('approvalList');
        if (!items.length) { el.innerHTML = '<div class="no-items">No pending approvals</div>'; return; }
        el.innerHTML = items.map(a => `
          <div class="approval-item">
            <i class="fas fa-${a.type === 'upload' ? 'cloud-upload-alt' : 'trash'}" style="font-size:18px;color:var(--${a.type==='upload'?'info':'danger'})"></i>
            <div class="meta"><div class="type">${a.type} Request</div><div class="detail">${a.filename} — by ${a.requestedBy}</div></div>
            <div class="approval-btns">
              <button class="approve-btn" onclick="handleApproval('${a.id}','approve')"><i class="fas fa-check"></i></button>
              <button class="reject-btn" onclick="handleApproval('${a.id}','reject')"><i class="fas fa-times"></i></button>
            </div>
          </div>`).join('');
      } catch {}
    }
    window.handleApproval = async (id, action) => {
      try {
        const res = await authFetch(`/api/admin/approvals/${id}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) { toast(`${data.status}`, data.status==='approved'?'success':'warning'); loadApprovals(); } else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };
    async function loadDMReports() {
      try {
        const items = await (await authFetch('/api/admin/dm-reports')).json();
        const el = document.getElementById('dmReportList');
        if (!items.length) { el.innerHTML = '<div class="no-items">No pending DM reports</div>'; return; }
        el.innerHTML = items.map(r => `
          <div class="approval-item">
            <i class="fas fa-flag" style="font-size:18px;color:var(--danger)"></i>
            <div class="meta">
              <div class="type">${r.reason || 'DM Report'}</div>
              <div class="detail">By ${r.reporter?.displayName||r.reportedBy} about ${r.sender?.displayName||r.messageFrom}</div>
            </div>
            <div class="approval-btns">
              <button class="review-btn" onclick="handleDMReport('${r.id}','resolve')"><i class="fas fa-check-double"></i></button>
              <button class="approve-btn" onclick="handleDMReport('${r.id}','delete-message')"><i class="fas fa-trash"></i></button>
              <button class="reject-btn" onclick="handleDMReport('${r.id}','dismiss')"><i class="fas fa-times"></i></button>
            </div>
          </div>`).join('');
      } catch {}
    }
    window.handleDMReport = async (id, action) => {
      try {
        const res = await authFetch(`/api/admin/dm-reports/${id}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) { toast(`DM report ${data.status}`, 'success'); loadDMReports(); } else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };
    async function loadSocialReports() {
      try {
        const items = await (await authFetch('/api/admin/reports')).json();
        const el = document.getElementById('socialReportList');
        if (!items.length) { el.innerHTML = '<div class="no-items">No pending post reports</div>'; return; }
        el.innerHTML = items.map(r => `
          <div class="approval-item">
            <i class="fas fa-flag" style="font-size:18px;color:var(--warning)"></i>
            <div class="meta">
              <div class="type">By ${r.reporter?.displayName||r.reportedBy}</div>
              <div class="detail">${(r.reason||'').substring(0,80)}</div>
            </div>
            <div class="approval-btns">
              <button class="reject-btn" onclick="handleSocialReport('${r.id}','delete-post')"><i class="fas fa-trash"></i></button>
              <button class="approve-btn" onclick="handleSocialReport('${r.id}','dismiss')"><i class="fas fa-times"></i></button>
            </div>
          </div>`).join('');
      } catch {}
    }
    window.handleSocialReport = async (id, action) => {
      try {
        const res = await authFetch(`/api/admin/reports/${id}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) { toast(action==='delete-post'?'Post deleted':'Dismissed', 'success'); loadSocialReports(); } else toast(data.error, 'error');
      } catch { toast('Failed', 'error'); }
    };

    function fmtBytes(bytes) {
      const n = Number(bytes) || 0;
      if (n < 1024) return `${n} B`;
      if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
      if (n < 1024 * 1024 * 1024) return `${(n / (1024 * 1024)).toFixed(1)} MB`;
      return `${(n / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    }

    function fmtDuration(ms) {
      const s = Math.max(0, Math.floor((Number(ms) || 0) / 1000));
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (d) return `${d}d ${h}h ${m}m`;
      if (h) return `${h}h ${m}m ${sec}s`;
      if (m) return `${m}m ${sec}s`;
      return `${sec}s`;
    }

    window.refreshSystemStatus = async () => {
      const box = document.getElementById('systemStatusBox');
      if (!box) return;
      box.textContent = 'Loading...';
      try {
        const res = await authFetch('/api/admin/system/status');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load status');
        box.innerHTML = [
          `PID: ${data.pid}`,
          `Node: ${data.nodeVersion}`,
          `Platform: ${data.platform}`,
          `Uptime: ${fmtDuration(data.uptimeMs)}`,
          `Memory: ${fmtBytes(data.rssBytes)} RSS`,
          `Restart Enabled: ${data.restartEnabled ? 'yes' : 'no'}`
        ].join('<br>');
      } catch (e) {
        box.textContent = `Status error: ${e.message || 'unknown error'}`;
      }
    };

    window.loadSystemLogs = async () => {
      const box = document.getElementById('systemLogsBox');
      if (!box) return;
      box.textContent = 'Loading logs...';
      try {
        const res = await authFetch('/api/admin/system/logs?count=30');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load logs');
        const lines = (data.logs || []).map(l => {
          const details = l.details && typeof l.details === 'object' ? JSON.stringify(l.details) : '{}';
          return `${l.timestamp || ''}  ${l.actor || 'system'}  ${l.action || ''}  ${details}`;
        });
        box.textContent = lines.length ? lines.join('\n') : '(no logs found)';
      } catch (e) {
        box.textContent = `Logs error: ${e.message || 'unknown error'}`;
      }
    };

    window.restartServerNow = async () => {
      if (!confirm('Restart server now? Use only if supervised by pm2/systemd/docker.')) return;
      try {
        const res = await authFetch('/api/admin/system/restart', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Restart failed');
        toast(data.message || 'Restart requested', 'warning');
      } catch (e) {
        toast(e.message || 'Restart failed', 'error');
      }
    };

    // ── init ──
    (async () => {
      const token = getToken();
      if (!token) { showLogin(); return; }
      try {
        const res = await fetch('/api/auth/verify', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) { showLogin(); return; }
        const data = await res.json();
        if (!data.valid) { showLogin(); return; }
        loadHub();
      } catch { showLogin(); }
    })();

    bindAppCardTouchHold();
  })();
  </script>
</body>
</html>
